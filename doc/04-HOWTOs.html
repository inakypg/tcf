

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Examples and HOWTOs &mdash; Test Case Framework 0.11 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Rationales and Frequently Asked Questions" href="05-RFAQs.html" />
    <link rel="prev" title="3. Server deployment guide" href="03-server-setup.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Test Case Framework
          

          
          </a>

          
            
            
              <div class="version">
                0.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../02-QUICKSTART.html">1. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-guides.html">2. Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="03-server-setup.html">3. Server deployment guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Examples and HOWTOs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-examples.test_yielding_results">4.1. Automation/testcase script examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#returning-results">4.1.1. Returning results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tag-a-testcase">4.1.2. Tag a testcase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploying-os-images-and-files-to-targets-over-the-network">4.1.3. Deploying OS images and files to targets over the network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#quick-way-to-deploy-an-os-image-to-a-target-and-get-a-prompt">4.1.3.1. Quick way to deploy an OS image to a target and get a prompt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#quick-way-to-deploy-an-os-image-to-an-specific-target-and-get-a-prompt">4.1.3.2. Quick way to deploy an OS image to an specific target and get a prompt</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-an-os-image-to-a-target">4.1.3.3. Deploy an OS image to a target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deploy-an-os-image-to-two-targets-simultaneously">4.1.3.4. Deploy an OS image to two targets simultaneously</a></li>
<li class="toctree-l4"><a class="reference internal" href="#boot-a-target-in-provisioning-mode">4.1.3.5. Boot a target in Provisioning mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="#send-a-file-or-directory-tree-during-deployment-to-the-target">4.1.3.6. Send a file or directory tree during deployment to the target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-install-and-boot-a-linux-kernel-alongside-a-given-os">4.1.3.7. Build, install and boot a Linux kernel alongside a given OS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-install-and-boot-a-qemu-machine-with-modified-bios">4.1.3.8. Build, install and boot a QEMU machine with modified BIOS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-examples.test_subcases">4.1.4. Common patterns</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reporting-subcases">4.1.4.1. Reporting subcases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-examples.test_audio_capture">4.1.5. Capturing data, doing SSH</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#reproducing-audio-and-capturing-the-output">4.1.5.1. Reproducing audio and capturing the output</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-target-s-ssh-server-and-executing-an-ssh-command">4.1.5.2. Enabling target’s SSH server and executing an SSH command</a></li>
<li class="toctree-l4"><a class="reference internal" href="#different-options-of-accessing-a-target-via-ssh">4.1.5.3. Different options of accessing a target via SSH</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#keywords-that-are-available-to-this-testcase-while-running-on-a-target">4.1.6. Keywords that are available to this testcase while running on a target</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#static-testcases-no-targets-run-local">4.1.6.1. Static testcases (no targets, run local)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testcase-using-one-target">4.1.6.2. Testcase using one target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testcase-using-two-targets">4.1.6.3. Testcase using two targets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testcase-drivers">4.1.7. Testcase drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#impromptu-testcase-driver-to-execute-and-report-yocto-oe-ptest-runner-testcases">4.1.7.1. Impromptu testcase driver to execute and report Yocto/OE ptest-runner testcases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#creating-a-file-in-the-target-from-the-command-line">4.1.8. Creating a file in the target from the command line</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tcf-client-tricks">4.2. TCF client tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#where-is-the-tcf-client-configuration-taken-from">4.2.1. Where is the TCF client configuration taken from?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-list-which-targets-i-own">4.2.2. How do I list which targets I own?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-release-a-target-i-don-t-own">4.2.3. How do I release a target I don’t own?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-release-all-the-targets-i-own">4.2.4. How do I release all the targets I own?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-keep-a-target-acquired-reserved-after-tcf-run-is-done">4.2.5. How do I keep a target acquired/reserved after <em>tcf run</em> is done?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#alternative-method-without-hashids">4.2.5.1. Alternative method without hashids</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-debug-a-target">4.2.6. How can I debug a target?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#zephyr-debugging-with-tcf-run">4.2.6.1. Zephyr debugging with TCF run</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-quickly-flash-a-linux-target">4.2.7. How can I quickly flash a Linux target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-can-i-quickly-build-and-deploy-an-image-to-a-zephyr-target">4.2.8. How can I quickly build and deploy an image to a Zephyr target?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tcf-s-run-says-something-failed-can-i-get-more-detail">4.2.9. TCF’s <cite>run</cite> says something failed, can I get more detail?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux-targets-common-tricks">4.2.10. Linux targets: Common tricks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-sending-ctrl-c-to-a-target">4.2.10.1. Linux targets: sending Ctrl-C to a target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-running-a-linux-shell-command">4.2.10.2. Linux targets: running a Linux shell command</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-ssh-login-from-a-testcase-client">4.2.10.3. Linux targets: ssh login from a testcase / client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-restarting-the-ssh-daemon">4.2.10.4. Linux targets: restarting the SSH daemon</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-do-i-boot-a-target-to-pxe-boot-mode-manually">4.2.10.5. How do I boot a target to PXE boot mode manually?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pos-booting-from-http-or-tftp">4.2.10.6. POS: booting from HTTP or TFTP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-pos-setting-default-linux-kernel-options">4.2.10.7. Linux targets: POS: setting default linux kernel options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-using-proxies">4.2.10.8. Linux targets: using proxies</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-removing-the-root-password">4.2.10.9. Linux targets: removing the root password</a></li>
<li class="toctree-l4"><a class="reference internal" href="#linux-targets-allowing-ssh-as-root-with-no-passwords">4.2.10.10. Linux targets: allowing SSH as root with no passwords</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-change-the-default-timeout-in-my-test-scripts">4.2.11. How do I change the default timeout in my test scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#making-the-client-always-generate-report-files">4.2.12. Making the client always generate report files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#splitting-report-files-by-domain">4.2.13. Splitting report files by domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#capturing-network-traffic">4.2.14. Capturing network traffic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#continuous-integration">4.2.15. Continuous Integration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generate-a-unique-id-for-each-run-and-feed-it-to-tcf">4.2.15.1. Generate a unique ID for each run and feed it to TCF</a></li>
<li class="toctree-l4"><a class="reference internal" href="#splitting-in-multiple-shards">4.2.15.2. Splitting in multiple shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-output-location">4.2.15.3. Controlling output location</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#general-catchas">4.3. General catchas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hidden-characters-in-console-output-ansi-menus">4.3.1. Hidden characters in console output, ANSI menus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#newlines-when-reading-output-of-a-command">4.3.2. Newlines when reading output of a command</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#general-linux-system">4.4. General Linux system</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setup-proxies">4.4.1. Setup proxies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-update-my-tcf-installation">4.4.2. How do I update my TCF installation?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-a-usb-or-other-network-adapter-for-an-infrastructure-network">4.4.3. Configuring a USB or other network adapter for an infrastructure network</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-network-interfaces-with-networkmanager-and-nmcli">4.4.4. Configuring network interfaces with NetworkManager and nmcli</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#disabling-networkmanager-from-controlling-an-interface">4.4.4.1. Disabling NetworkManager from controlling an interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuring-a-static-interface-via-networkmanager-s-nmcli">4.4.4.2. Configuring a static interface Via NetworkManager’s nmcli</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#generating-an-ssl-certificate">4.4.5. Generating an SSL certificate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-and-reloading-udev">4.4.6. Configuring and reloading UDEV</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-usb-device-information">4.4.7. Finding USB device information</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#finding-usb-device-information-with-dmesg">4.4.7.1. Finding USB device information with dmesg</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-usb-device-information-with-lsusb-py">4.4.7.2. Finding USB device information with lsusb.py</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-usb-device-information-with-udevadm">4.4.7.3. Finding USB device information with udevadm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#udev-configuration-of-serial-port">4.4.8. udev configuration of serial port</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#udev-configuration-of-serial-port-based-on-serial-number">4.4.8.1. udev configuration of serial port based on serial number</a></li>
<li class="toctree-l4"><a class="reference internal" href="#udev-configuration-of-serial-port-without-serial-number-based-on-path">4.4.8.2. udev configuration of serial port without serial number based on path</a></li>
<li class="toctree-l4"><a class="reference internal" href="#udev-configuration-of-serial-port-based-on-sibling-s-serial-number">4.4.8.3. udev configuration of serial port based on sibling’s serial number</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#finding-the-serial-number-of-a-devantech-usbrly08b-relay-controller">4.4.9. Finding the serial number of a Devantech USBRLY08B relay controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-the-serial-number-of-an-ykush-hub">4.4.10. Finding the serial number of an YKUSH hub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ttbd-tcf-server-configuration-and-tricks">4.5. <em>ttbd</em>: TCF server configuration and tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#starting-more-that-one-instance">4.5.1. Starting more that one instance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-authentication-for-local-users-optional">4.5.2. Configure authentication for local users (optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-simple-authentication-for-jenkins-jobs-optional">4.5.3. Configure simple authentication / for Jenkins jobs (optional)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-authentication-against-ldap">4.5.4. Configure authentication against LDAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-a-target-for-just-controlling-power-to-something">4.5.5. Configuring a target for just controlling power to something</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-a-linux-target-to-power-on-off-with-serial-console">4.5.6. Configuring a Linux target to power on/off with serial console</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-physical-linux-targets-with-a-fixed-live-filesystem">4.5.7. Configure physical Linux targets with a fixed Live filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-tags-to-a-target">4.5.8. Adding tags to a target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-do-i-disable-a-target-by-default">4.5.9. How do I disable a target by default?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#allowing-the-server-to-be-used-remotely">4.5.10. Allowing the server to be used remotely</a></li>
<li class="toctree-l3"><a class="reference internal" href="#increasing-the-verbosity-of-the-server">4.5.11. Increasing the verbosity of the server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manual-installation-of-tcf-from-source">4.6. Manual installation of TCF from source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#creation-and-setup-of-user-ttbd">4.6.1. Creation and setup of user <em>ttbd</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-required-software">4.6.2. Install required software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remove-conflicting-packages">4.6.3. Remove conflicting packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-tcf">4.6.4. Install TCF</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#manual-installation-of-support-packages">4.7. Manual installation of support packages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#bossac-arduino-due-flasher">4.7.1. Bossac: Arduino Due flasher</a></li>
<li class="toctree-l3"><a class="reference internal" href="#zephyr-sdk">4.7.2. Zephyr SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arduino-builder-1-6-13">4.7.3. Arduino Builder 1.6.13</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tunslip6">4.7.4. tunslip6</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xtensa-esp32">4.7.5. Xtensa ESP32</a></li>
<li class="toctree-l3"><a class="reference internal" href="#libcoap">4.7.6. libcoap</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fpm-fast-package-manager">4.7.7. FPM, fast package manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#platform-firmware-bios-update-procedures">4.8. Platform firmware / BIOS update procedures</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-serial-number-and-or-description-of-a-ftdi-serial-device">4.8.1. Updating the serial number and / or description of a FTDI serial device</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-serial-number-and-or-description-of-a-cp210x-serial-device">4.8.2. Updating the serial number and / or description of a CP210x serial device</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-firmware-in-an-arduino101-to-factory-settings">4.8.3. Updating the firmware in an Arduino101 to factory settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-firmware-in-an-quark-c1000-reference-boards">4.8.4. Updating the firmware in an Quark C1000 reference boards</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#remediation-steps">4.8.4.1. Remediation steps</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-firmware-in-an-quark-d2000-reference-boards">4.8.5. Updating the firmware in an Quark D2000 reference boards</a></li>
<li class="toctree-l3"><a class="reference internal" href="#updating-the-fpga-image-in-synopsys-emsk-boards">4.8.6. Updating the FPGA image in Synopsys EMSK boards</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#creating-images-for-the-provisioning-os">4.9. Creating images for the Provisioning OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linux-live-images">4.9.1. Linux Live images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux-kickstart-images-using-qemu">4.9.2. Linux Kickstart images using QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manual-image-extraction-using-qemu">4.9.3. Manual image extraction using QEMU</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="05-RFAQs.html">5. Rationales and Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-troubleshooting.html">6. Support &amp; Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-Architecture.html">7. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="09-api.html">8. APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="10-Status.html">10. Current status and plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-CHANGELOG.html">11. TCF release v0.11</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Test Case Framework</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>4. Examples and HOWTOs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/doc/04-HOWTOs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="examples-and-howtos">
<h1>4. Examples and HOWTOs<a class="headerlink" href="#examples-and-howtos" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-examples.test_yielding_results">
<span id="automation-testcase-script-examples"></span><span id="examples-script"></span><h2>4.1. Automation/testcase script examples<a class="headerlink" href="#module-examples.test_yielding_results" title="Permalink to this headline">¶</a></h2>
<div class="section" id="returning-results">
<h3>4.1.1. Returning results<a class="headerlink" href="#returning-results" title="Permalink to this headline">¶</a></h3>
<p>Testcases can return <a class="reference internal" href="09-api.html#tcfl.tc.valid_results" title="tcfl.tc.valid_results"><code class="xref py py-data docutils literal notranslate"><span class="pre">five</span> <span class="pre">results</span></code></a> to
the testcase runner:</p>
<ul class="simple">
<li>pass</li>
<li>fail</li>
<li>error</li>
<li>blockage</li>
<li>skip</li>
</ul>
<p>Note that any function that:</p>
<ul class="simple">
<li>just returns or returns <em>True</em> is a <strong>pass</strong></li>
<li>returns <em>False</em> is a <strong>failure</strong></li>
<li>any other return value other than <a class="reference internal" href="09-api.html#tcfl.tc.result_c" title="tcfl.tc.result_c"><code class="xref py py-class docutils literal notranslate"><span class="pre">tcfl.tc.result_c</span></code></a> will yield
blockage, as it cannot be interpreted.</li>
</ul>
<p>By raising an exception at any time in your testcase, the execution is
terminated, cleanup methods called and the results / collaterals that
apply collected.</p>
<p>This example generates a random result, running only in the local
host (it is a <a class="reference internal" href="glossary.html#term-static-testcase"><span class="xref std std-term">static testcase</span></a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test_pass</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;I am causing a pass by raising&quot;</span><span class="p">)</span>
        <span class="c1"># or you can just return nothing, that means pass</span>
        <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">pass_e</span><span class="p">(</span><span class="s2">&quot;I passed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test_errr</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_error</span><span class="p">(</span><span class="s2">&quot;I am causing an error by raising&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">error_e</span><span class="p">(</span><span class="s2">&quot;I errored&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test_fail</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_fail</span><span class="p">(</span><span class="s2">&quot;I am causing a failure by raising&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;I failed&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test_blck</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_blck</span><span class="p">(</span><span class="s2">&quot;I am causing a blockage by raising&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">blocked_e</span><span class="p">(</span><span class="s2">&quot;I blocked&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test_skip</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_skip</span><span class="p">(</span><span class="s2">&quot;I am causing a skip by raising&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">skip_e</span><span class="p">(</span><span class="s2">&quot;I skipped&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_yielding_results.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vv /usr/share/tcf/examples/test_yielding_results.py
INFO2/        toplevel @local: scanning for test cases
INFO1/zom6    .../test_yielding_results.py#_test_pass @localic-localtg: will run on target group &#39;localic-localtg&#39;
INFO1/kvkn    .../test_yielding_results.py#_test_blck @localic-localtg: will run on target group &#39;localic-localtg&#39;
INFO1/rnpd    .../test_yielding_results.py#_test_skip @localic-localtg: will run on target group &#39;localic-localtg&#39;
INFO1/enpe    .../test_yielding_results.py#_test_fail @localic-localtg: will run on target group &#39;localic-localtg&#39;
INFO1/ap2n    .../test_yielding_results.py#_test_errr @localic-localtg: will run on target group &#39;localic-localtg&#39;
PASS2/zom6E#1 .../test_yielding_results.py#_test_pass @localic-localtg: I am causing a pass by raising
PASS2/zom6E#1 .../test_yielding_results.py#_test_pass @localic-localtg: eval passed: I passed
PASS1/zom6    .../test_yielding_results.py#_test_pass @localic-localtg: evaluation passed 
BLCK2/kvknE#1 .../test_yielding_results.py#_test_blck @localic-localtg: I am causing a blockage by raising
BLCK2/kvknE#1 .../test_yielding_results.py#_test_blck @localic-localtg: eval blocked: I blocked
BLCK0/kvkn    .../test_yielding_results.py#_test_blck @localic-localtg: evaluation blocked 
SKIP2/rnpdE#1 .../test_yielding_results.py#_test_skip @localic-localtg: I am causing a skip by raising
SKIP2/rnpdE#1 .../test_yielding_results.py#_test_skip @localic-localtg: eval skipped: I skipped
SKIP1/rnpd    .../test_yielding_results.py#_test_skip @localic-localtg: evaluation skipped 
FAIL2/enpeE#1 .../test_yielding_results.py#_test_fail @localic-localtg: I am causing a failure by raising
FAIL2/enpeE#1 .../test_yielding_results.py#_test_fail @localic-localtg: eval failed: I failed
FAIL0/enpe    .../test_yielding_results.py#_test_fail @localic-localtg: evaluation failed 
ERRR2/ap2nE#1 .../test_yielding_results.py#_test_errr @localic-localtg: I am causing an error by raising
ERRR2/ap2nE#1 .../test_yielding_results.py#_test_errr @localic-localtg: eval errored: I errored
ERRR0/ap2n    .../test_yielding_results.py#_test_errr @localic-localtg: evaluation errored 
FAIL0/        toplevel @local: 5 tests (1 passed, 1 error, 1 failed, 1 blocked, 1 skipped, in 0:00:00.505594) - failed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>Note how <em>tcf run</em> reports counts on how many testcase executed, how
many passed/errored/failed/blocked or skipped.</p>
</div>
<span class="target" id="module-examples.test_tagging"></span><div class="section" id="tag-a-testcase">
<h3>4.1.2. Tag a testcase<a class="headerlink" href="#tag-a-testcase" title="Permalink to this headline">¶</a></h3>
<p>A testcase can be given one or more tags with the <a class="reference internal" href="09-api.html#tcfl.tc.tags" title="tcfl.tc.tags"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.tags()</span></code></a>
decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="s2">&quot;boolean_tag&quot;</span><span class="p">,</span> <span class="s2">&quot;component/storage&quot;</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
              <span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;tag </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> [from </span><span class="si">%s</span><span class="s2">]&quot;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the <em>component/ANYTHING</em> tags are <em>special</em>, they are interpreted
as a namespace and with them, another tag called <em>components</em> is going
to be generated listing all the components found.</p>
<p>Tags, for example, can be used later to filter from the command line
to select all testcases with that expose a tag <em>color</em> with value
<em>red</em>, in this case, only <a class="reference download internal" href="../_downloads/test_tagging.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">this</span> <span class="pre">one</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vv -s &#39;color == &quot;red&quot;&#39; /usr/share/tcf/examples/
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<div class="section" id="deploying-os-images-and-files-to-targets-over-the-network">
<span id="examples-pos"></span><h3>4.1.3. Deploying OS images and files to targets over the network<a class="headerlink" href="#deploying-os-images-and-files-to-targets-over-the-network" title="Permalink to this headline">¶</a></h3>
<p>TCF can do very fast <a class="reference internal" href="07-Architecture.html#provisioning-os"><span class="std std-ref">OS deployment</span></a> by
rsyncing images over the network instead of just overwritting
evertything:</p>
<ul class="simple">
<li>for simple testcases that just need a target provisioned, use test
case templates <a class="reference internal" href="#example-pos-base"><span class="std std-ref">tc_pos_base</span></a></li>
<li>to have more control over the target selection process, use template
<a class="reference internal" href="#example-pos0-base"><span class="std std-ref">tc_pos0_base</span></a></li>
<li>to have full control over the deployment process or find more
details on how this process works in <a class="reference internal" href="#example-pos-deploy"><span class="std std-ref">here</span></a></li>
<li>to deploy multiple targets at the same time, for client/server
tests, see <a class="reference internal" href="#example-pos-deploy-2"><span class="std std-ref">here</span></a></li>
<li>to copy other content to the image after deploying the OS, see
<a class="reference internal" href="#example-deploy-files"><span class="std std-ref">this example</span></a></li>
</ul>
<span class="target" id="module-examples.test_pos_base"></span><div class="section" id="quick-way-to-deploy-an-os-image-to-a-target-and-get-a-prompt">
<span id="example-pos-base"></span><h4>4.1.3.1. Quick way to deploy an OS image to a target and get a prompt<a class="headerlink" href="#quick-way-to-deploy-an-os-image-to-a-target-and-get-a-prompt" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, deploy to it a given image, <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>. Then power cycle into the installed OS.</p>
<p>This is a <a class="reference internal" href="09-api.html#tcfl.pos.tc_pos_base" title="tcfl.pos.tc_pos_base"><code class="xref py py-class docutils literal notranslate"><span class="pre">template</span></code></a> when your testcase
<em>just needs a target</em>, with no frills and your evaluation wants a
prompt in a powered machine. In case of failures, errors or blockage,
the consoles will be dumped.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provisiong a target, boot it, run a shell command</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_pos_base.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_pos_base.py
INFO1/hxgj     .../test_pos_base.py#_test @sv3m-twgl: will run on target group &#39;ic=localhost/nwb target=localhost/qu06b:x86_64&#39;
INFO1/hxgjDPOS .../test_pos_base.py#_test @sv3m-twgl|localhost/qu06b: POS: rsyncing clear:desktop:29820::x86_64 from 192.168.98.1::images to /dev/sda5
PASS1/hxgj     .../test_pos_base.py#_test @sv3m-twgl: evaluation passed
PASS0/         toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:02:54.992824) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_pos0_base"></span><div class="section" id="quick-way-to-deploy-an-os-image-to-an-specific-target-and-get-a-prompt">
<span id="example-pos0-base"></span><h4>4.1.3.2. Quick way to deploy an OS image to an specific target and get a prompt<a class="headerlink" href="#quick-way-to-deploy-an-os-image-to-an-specific-target-and-get-a-prompt" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, deploy to it a given image, <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>. Then power cycle into the installed OS.</p>
<p>This is a <a class="reference internal" href="09-api.html#tcfl.pos.tc_pos0_base" title="tcfl.pos.tc_pos0_base"><code class="xref py py-class docutils literal notranslate"><span class="pre">template</span></code></a> when your testcase
just needs to flash a given target and you need control over that
target selection process. Otherwise is the same as <a class="reference internal" href="#example-pos-base"><span class="std std-ref">tc_pos_base</span></a>.</p>
<p>The selection is controlled by the decorators
<a class="reference internal" href="09-api.html#tcfl.tc.interconnect" title="tcfl.tc.interconnect"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.interconnect()</span></code></a> (to request a network) and
<a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.target()</span></code></a> (to request a target):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable and ic.id in interconnects &#39;</span>
                <span class="s1">&#39;and capture:&quot;screen:snapshot&quot;&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos0_base</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>the filtering values come from the metadata exposed by the target,
which can be seen with <em>tcf list -vv TARGETNAME*</em> and available to the
script in <em>target.kws</em> or <em>ic.kws</em> (see <a class="reference internal" href="02-guides.html#tcf-evaluation-expressions"><span class="std std-ref">here</span></a> for more information). In this case:</p>
<blockquote>
<div><ul>
<li><p class="first">select a network or interconnect (by default called <em>ic</em>) that
exposes an IPv4 address, which by convention means it implements
IPv4 networking</p>
</li>
<li><p class="first">select a target that:</p>
<ul>
<li><p class="first">can be provisioned with Provisioning OS (<em>pos_capable</em>)</p>
</li>
<li><p class="first">is connected to the interconnect (<em>ic.id in interconnects</em>
indicates the target declares the network in the list of networks
it is connected to; see the output of <em>tcf list -vv TARGETNAME |
grep interconnects</em>)</p>
</li>
<li><p class="first">exposes a capture interface to get screenshots from the screen;
the colon <code class="docutils literal notranslate"><span class="pre">:</span></code> after <em>capture</em> acts as a regex operator; see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf list -vv capture | grep -w -e id: -e capture:*
 id: qu04a
 capture: vnc0:snapshot:image/png screen:snapshot:image/png
 id: qu04b
 capture: vnc0:snapshot:image/png screen:snapshot:image/png
 ...
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable and ic.id in interconnects &#39;</span>
                <span class="s1">&#39;and capture:&quot;screen:snapshot&quot;&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos0_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provisiong a target, boot it, run a shell command</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_pos0_base.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_pos0_base.py
INFO1/yios     .../test_pos0_base.py#_test @sv3m-twgl: will run on target group &#39;ic=localhost/nwb target=localhost/qu06b:x86_64&#39;
INFO1/yiosDPOS .../test_pos0_base.py#_test @sv3m-twgl|localhost/qu06b: POS: rsyncing clear:desktop:29820::x86_64 from 192.168.98.1::images to /dev/sda5
PASS1/yios     .../test_pos0_base.py#_test @sv3m-twgl: evaluation passed
PASS0/         toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:01:51.845546) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_pos_deploy"></span><div class="section" id="deploy-an-os-image-to-a-target">
<span id="example-pos-deploy"></span><h4>4.1.3.3. Deploy an OS image to a target<a class="headerlink" href="#deploy-an-os-image-to-a-target" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, deploy to it a given image, <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>.</p>
<ul class="simple">
<li>to copy other content to the image after deploying the OS, see
<a class="reference internal" href="#example-deploy-files"><span class="std std-ref">this example</span></a></li>
</ul>
<p>This test will select two targets: a computer to provision and the
network it is connected to; the deploying happens over the network
(thus why the network is requested).</p>
<p>To accomplish this, the target is first booted in Provisioning mode, a
version of a Linux OS whose root filesystem runs off a read-only NFS
server in the target; provisioning mode is reached depending on the
type of target, via PXE boot or other means. The client then can drive
partitioning of the target’s storage and rsyncs root filesystem images
in.</p>
<p>If the rootfilesystem is already initialized present, rsync will
transfer only changes, or refresh, which is much faster.</p>
<p>This can be used to start every single test with <em>first install a
fresh OS</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;pos_capable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="n">image_requested</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;not deployed&quot;</span>

    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;IMAGE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">blocked_e</span><span class="p">(</span>
                    <span class="s2">&quot;No image to install specified, set envar IMAGE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">]</span>
        <span class="c1"># ensure network, DHCP, TFTP, etc are up and deploy</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_image</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;deployed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># fire up the target, wait for a login prompt, ensure the</span>
        <span class="c1"># network is on so the PXE controller can direct the target</span>
        <span class="c1"># where to boot--also, if we skip deployment, ensures we have</span>
        <span class="c1"># networking on</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">boot_normal</span><span class="p">()</span>		<span class="c1"># boot no Provisioning OS</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>		<span class="c1"># login as root</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>			<span class="c1"># if we don&#39;t need the network</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># do our test</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">console_dump_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_pos_deploy.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_pos_deploy.py
INFO1/cz1c     .../test_pos_deploy.py#_test @sv3m-twgl: will run on target group &#39;ic=localhost/nwb target=localhost/qu06b:x86_64&#39;
INFO1/cz1cDPOS .../test_pos_deploy.py#_test @sv3m-twgl|localhost/qu06b: POS: rsyncing clear:desktop:29820::x86_64 from 192.168.98.1::images to /dev/sda5
PASS1/cz1c     .../test_pos_deploy.py#_test @sv3m-twgl: evaluation passed 
PASS0/         toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:03:21.020510) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>In general, you can use <em>tcf run test_pos_deploy.py</em> to provision
machines any time for any reason from the command line.</p>
</div>
<span class="target" id="module-examples.test_pos_deploy_2"></span><div class="section" id="deploy-an-os-image-to-two-targets-simultaneously">
<span id="example-pos-deploy-2"></span><h4>4.1.3.4. Deploy an OS image to two targets simultaneously<a class="headerlink" href="#deploy-an-os-image-to-two-targets-simultaneously" title="Permalink to this headline">¶</a></h4>
<p>Given two target that can be provisioned with <a class="reference internal" href="07-Architecture.html#provisioning-os"><span class="std std-ref">Provisioning OS</span></a>, deploy to them images <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">available in the
server</span></a>.</p>
<p>This test will select three targets: two machines to provision and the
network they are both connected to; the deploying happens over the
network (thus why the it is requested).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provision two PC targets at the same time with the Provisioning OS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_requested</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">image_requested1</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@tcfl.tc.serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;IMAGE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">blocked_e</span><span class="p">(</span>
                    <span class="s2">&quot;No image to install specified, set envar IMAGE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_requested1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.concurrently</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_10_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_image</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;deployed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">image</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.concurrently</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_10_target1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">target1</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_image</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_requested1</span><span class="p">)</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;deployed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">image</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">start_ic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>			<span class="c1"># in case we skip deploy</span>

    <span class="k">def</span> <span class="nf">start_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">boot_normal</span><span class="p">()</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">start_target1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">boot_normal</span><span class="p">()</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">up</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">console_dump_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>This can be used to implement client/server testcases, where one
target is configured as a server, the other as client and tests are
executed in a private, isolated network with fresh OS instalations. It
can be easily extended to any number of targets by adding more
<a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.target()</span></code></a> decorators, and <em>deploy_targetN()</em> and
<em>start_targetN()</em> methods.</p>
<p>Execute <a class="reference download internal" href="../_downloads/test_pos_deploy_2.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">available in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_pos_deploy_2.py
INFO1/x9uz    .../test_pos_deploy_2.py#_test @sv3m-fmav: will run on target group &#39;ic=localhost/nwb target=localhost/qu06b:x86_64 target1=localhost/qu05b:x86_64&#39;
PASS1/x9uz    .../test_pos_deploy_2.py#_test @sv3m-fmav: evaluation passed 
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:02:43.525650) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_pos_boot"></span><div class="section" id="boot-a-target-in-provisioning-mode">
<span id="example-pos-boot"></span><h4>4.1.3.5. Boot a target in Provisioning mode<a class="headerlink" href="#boot-a-target-in-provisioning-mode" title="Permalink to this headline">¶</a></h4>
<p>Given a target that supports Provisioning OS mode, boot it in said mode.</p>
<p>This allows to manipulate the target’s filesystem, as the POS boots
off a filesystem in the network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Boot a target to Provisioning OS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">boot_to_pos</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">console_dump_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_deploy_files.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vt &quot;nwa or qu04a&quot; /usr/share/tcf/examples/test_pos_boot.py
$ tcf run -vt &quot;nwa or qu04a&quot; tcf.git/examples/test_pos_boot.py
INFO1/rdgx    tcf.git/examples/test_pos_boot.py#_test @3hyt-uo3g: will run on target group &#39;ic=localhost/nwa target=localhost/qu04a:x86_64&#39;
PASS1/rdgx    tcf.git/examples/test_pos_boot.py#_test @3hyt-uo3g: evaluation passed 
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:36.773884) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>Note if you add <code class="docutils literal notranslate"><span class="pre">--no-release</span></code>, then you can login to the console
and manipulate the target; later you will have to manually release the
target and network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run --no-release -vt &quot;nwa or qu04a&quot; tcf.git/examples/test_pos_boot.py
INFO1/rdgx    tcf.git/examples/test_pos_boot.py#_test @3hyt-uo3g: will run on target group &#39;ic=localhost/nwa target=localhost/qu04a:x86_64&#39;
PASS1/rdgx    tcf.git/examples/test_pos_boot.py#_test @3hyt-uo3g: evaluation passed 
INFO0/rdgx    tcf.git/examples/test_pos_boot.py#_test @3hyt-uo3g: WARNING!! not releasing targets
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:36.773884) - passed 

$ tcf -t rdgx console-write -i qu04a
WARNING: This is a very limited interactive console
         Escape character twice ^[^[ to exit
...
My IP is 192.168.97.4
TCF Network boot to Service OS
Loading http://192.168.97.1/ttbd-pos/x86_64/vmlinuz-tcf-live... ok
Loading http://192.168.97.1/ttbd-pos/x86_64/initramfs-tcf-live...ok
...

TCF-rdgx: 4 $ ls -la
ls -la
total 28
dr-xr-x---  2 root root 4096 Jan 10 11:56 .
dr-xr-xr-x 18 root root 4096 Jan 10 11:58 ..
-rw-r--r--  1 root root   18 Feb  9  2018 .bash_logout
-rw-r--r--  1 root root  176 Feb  9  2018 .bash_profile
-rw-r--r--  1 root root  176 Feb  9  2018 .bashrc
-rw-r--r--  1 root root  100 Feb  9  2018 .cshrc
-rw-r--r--  1 root root  129 Feb  9  2018 .tcshrc
TCF-rdgx: 5 $ 
...

$ tcf -t rdgx release nwa qu04a
</pre></div>
</div>
</div>
<span class="target" id="module-examples.test_deploy_files"></span><div class="section" id="send-a-file-or-directory-tree-during-deployment-to-the-target">
<span id="example-deploy-files"></span><h4>4.1.3.6. Send a file or directory tree during deployment to the target<a class="headerlink" href="#send-a-file-or-directory-tree-during-deployment-to-the-target" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, send a directory tree to it during the deployment phase.</p>
<p>This allows to copy one or more files, directories etc to the target,
right after flashing the OS, so once the target is rebooted into the
provisioned OS, it is there. Note that the content itself is cached in
the target (in subdirectory <em>/persistent.tcf.d</em>), so next time it is
transferred it will be faster (with sizeable files).</p>
<p>You can also send/receive files <a class="reference internal" href="09-api.html#tcfl.target_ext_ssh.ssh" title="tcfl.target_ext_ssh.ssh"><code class="xref py py-class docutils literal notranslate"><span class="pre">via</span> <span class="pre">SSH</span></code></a> once the target is running (<a class="reference internal" href="#example-ssh-in"><span class="std std-ref">example</span></a>).</p>
<p>This also demonstrates a method to test if a local and remote files
are the same by using the MD5 sum.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;pos_capable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos0_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy files after installing OS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s1">&#39;clear:desktop&#39;</span><span class="p">)</span>
    <span class="n">login_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOGIN_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># the format is still a wee bit pedestrian, we&#39;ll improve the</span>
        <span class="c1"># argument passing</span>
        <span class="c1"># This could be a single path not necessarily a list of them</span>
        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_src</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># send a directory tree, the one containing this file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">],</span>
            <span class="c1"># send just a file, ../README.rst</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">],</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;README.rst&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_dest</span> <span class="o">=</span> <span class="s2">&quot;/home/place&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_image_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_deploy_fns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_path</span> <span class="p">])</span>
	
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;find /home -ls&quot;</span><span class="p">)</span>
        <span class="c1"># verify the file exists and is the same</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;md5sum &lt; /home/place/examples/data/beep.wav&quot;</span><span class="p">,</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">trim</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;md5sum &lt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/data/beep.wav&quot;</span><span class="p">,</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">remote</span> <span class="o">!=</span> <span class="n">local</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;MD5 mismatch (local </span><span class="si">%s</span><span class="s2"> remote </span><span class="si">%s</span><span class="s2">)&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">remote</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;deployed file is identical to local!&quot;</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_deploy_files.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_deploy_files.py
INFO1/ubio     .../test_deploy_files.py#_test @n6hi-da7e: will run on target group &#39;ic=server1/nwd target=server1/nuc-07d:x86_64&#39;
INFO1/ubioDPOS .../test_deploy_files.py#_test @n6hi-da7e|server1/nuc-07d: POS: rsyncing clear:desktop:30080::x86_64 from 192.168.100.1::images to /dev/sda4
PASS1/ubio     .../test_deploy_files.py#_test @n6hi-da7e: deployed file is identical to local!
PASS1/ubio     .../test_deploy_files.py#_test @n6hi-da7e: evaluation passed 
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:39.461709) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>where IMAGE is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>.</p>
</div>
<span class="target" id="module-examples.test_linux_kernel"></span><div class="section" id="build-install-and-boot-a-linux-kernel-alongside-a-given-os">
<span id="example-linux-kernel"></span><h4>4.1.3.7. Build, install and boot a Linux kernel alongside a given OS<a class="headerlink" href="#build-install-and-boot-a-linux-kernel-alongside-a-given-os" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, build a Linux kernel and modules, deploy an OS into the
target along with the just built kernel/modules. Then power cycle into
the installed OS with the new kernel.</p>
<p>From there on, different tests to exercise the new kernel could be
executed etc. This is a very common pattern for rapid development of
kernel code.</p>
<p>When the same target (for caching purposes) and build trees are used,
it allows for very quick turn arounds to test new code in the
hardware.</p>
<p>Builds on <a class="reference internal" href="#example-pos-base"><span class="std std-ref">deploying an OS to a target</span></a> and
<a class="reference internal" href="#example-deploy-files"><span class="std std-ref">deploying files to a target</span></a>. You can
find the list of OS images <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the server</span></a>.</p>
<p>The kernel deployment process removes any other kernel that was
available in the target’s <code class="docutils literal notranslate"><span class="pre">/boot</span></code> directory, replacing it with the
just built one, so the bootloader is configured to boot it.</p>
<p><strong>TIPS</strong>:</p>
<ul>
<li><p class="first">always use the same target (give <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">'nwX</span> <span class="pre">or</span> <span class="pre">TARGETX'</span></code> so that the
content is cached and each run doesn’t try to send the your built
kernel to a new target but just the bare changes. See methods for
doing this in the <a class="reference internal" href="#howto-target-keep-acquired"><span class="std std-ref">how-to section</span></a></p>
</li>
<li><p class="first">note depending on your connection to the target, sending the code to
the target can take a long time and even release the target as
inactive.</p>
<p>stripping the modules helps (only debug info!), as the debug info
accumulates and is usually not needed in the target.</p>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build, install and boot a linux kernel</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">build_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;LK_BUILDDIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">skip_e</span><span class="p">(</span>
                <span class="s2">&quot;please export env LK_BUILDDIR pointing to path of &quot;</span>
                <span class="s2">&quot;configured, built or ready-to-build linux kernel tree&quot;</span><span class="p">)</span>
        <span class="n">builddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LK_BUILDDIR&quot;</span><span class="p">]</span>
        <span class="n">rootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LK_ROOTDIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">+</span> <span class="s2">&quot;/root&quot;</span><span class="p">)</span>

        <span class="c1"># update the build</span>
        <span class="c1">#</span>
        <span class="c1">## $ make -C BUILDDIR all</span>
        <span class="c1">## ...</span>
        <span class="c1">#</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;re/building kernel in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">builddir</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;${MAKE:-make} -C </span><span class="si">%s</span><span class="s2"> all&quot;</span> <span class="o">%</span> <span class="n">builddir</span><span class="p">,</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;re/built kernel in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">builddir</span><span class="p">,</span>
                           <span class="nb">dict</span><span class="p">(</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">),</span>
                           <span class="n">alevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;installing kernel to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rootdir</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># will run to install the kernel to our fake root dir</span>
        <span class="c1">#</span>
        <span class="c1">## $ make INSTALLKERNEL=/dev/null \</span>
        <span class="c1">##       INSTALL_PATH=ROOTDIR/boot INSTALL_MOD_PATH=ROOTDIR \</span>
        <span class="c1">##       install modules_install</span>
        <span class="c1">## sh PATH/linux.git/arch/x86/boot/install.sh 4.19.5 arch/x86/boot/bzImage \</span>
	<span class="c1">##    System.map &quot;../root-linux/boot&quot;</span>
        <span class="c1">## Cannot find LILO.</span>
        <span class="c1">## INSTALL arch/x86/crypto/blowfish-x86_64.ko</span>
        <span class="c1">## INSTALL arch/x86/crypto/cast5-avx-x86_64.ko</span>
        <span class="c1">## INSTALL arch/x86/crypto/cast6-avx-x86_64.ko</span>
        <span class="c1">## INSTALL arch/x86/crypto/des3_ede-x86_64.ko</span>
        <span class="c1">## INSTALL arch/x86/crypto/sha1-mb/sha1-mb.ko</span>
        <span class="c1">## ...</span>
        <span class="c1">#</span>
        <span class="c1"># note that:</span>
        <span class="c1">#</span>
        <span class="c1"># - INSTALLKERNEL: shortcircuit kernel installer, not needed,</span>
        <span class="c1">#   since we won&#39;t boot it in the machine doing the building</span>
        <span class="c1">#</span>
        <span class="c1"># - LILO will not we found, we don&#39;t care -- we only want the</span>
        <span class="c1">#   files in rootdir/</span>
        <span class="n">commonl</span><span class="o">.</span><span class="n">makedirs_p</span><span class="p">(</span><span class="n">rootdir</span> <span class="o">+</span> <span class="s2">&quot;/boot&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;${MAKE:-make} -C </span><span class="si">%s</span><span class="s2"> INSTALLKERNEL=ignoreme&quot;</span>
            <span class="s2">&quot; INSTALL_PATH=</span><span class="si">%s</span><span class="s2">/boot INSTALL_MOD_PATH=</span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="s2">&quot; install modules_install&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">builddir</span><span class="p">,</span> <span class="n">rootdir</span><span class="p">,</span> <span class="n">rootdir</span><span class="p">),</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;installed kernel to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rootdir</span><span class="p">,</span>
                           <span class="nb">dict</span><span class="p">(</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">),</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;stripping debugging info&quot;</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;find </span><span class="si">%s</span><span class="s2"> -iname \*.ko | xargs strip --strip-debug&quot;</span> <span class="o">%</span> <span class="n">rootdir</span><span class="p">,</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;stripped debugging info&quot;</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">deploy_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># tell the deployment code to rsync our fake rootdir over the</span>
        <span class="c1"># /boot and /lib/modules/VERSION dirs in the target</span>
        <span class="n">rootdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LK_ROOTDIR&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">+</span> <span class="s2">&quot;/root&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">deploy_linux_kernel_tree</span> <span class="o">=</span> <span class="n">rootdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_image_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_deploy_fns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_linux_kernel</span> <span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># power cycle to the new kernel</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo I booted&quot;</span><span class="p">,</span> <span class="s2">&quot;I booted&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;uname -a&quot;</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">trim</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;uname -a: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_linux_kernel.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir -p build
$ cp CONFIGFILE build/.config
$ make -C PATH/TO/SRC/linux O=build oldconfig
$ make -C build -j all

$ LK_ROOTDIR=$PWD/build IMAGE=clear tcf run -v /usr/share/tcf/examples/test_linux_kernel.py
INFO1/ormorh    ..../test_linux_kernel.py#_test @3hyt-uo3g: will run on target group &#39;ic=localhost/nwa target=localhost/qu04a:x86_64&#39;
PASS1/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: re/building kernel in /home/inaky/t/gp/build-linux
PASS0/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: re/built kernel in /home/inaky/t/gp/build-linux
PASS1/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: installing kernel to /tmp/tcf.run-X2SMmK/ormorh/root
PASS0/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: installed kernel to /tmp/tcf.run-X2SMmK/ormorh/root
PASS2/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: output: Cannot find LILO.
PASS2/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: stripping debugging info
PASS1/ormorhB   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: stripped debugging info
PASS1/ormorh    ..../test_linux_kernel.py#_test @3hyt-uo3g: build passed 
INFO3/ormorhD   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/nwa: Powering on
INFO2/ormorhD   ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/nwa: Powered on
INFO3/ormorhDPOS  ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: POS: rebooting into Provisioning OS [0/3]
INFO3/ormorhDPOS  ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: POS: setting target to PXE boot Provisioning OS
...
INFO3/ormorhDPOS  ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: POS: rsynced clear:live:29100::x86_64 from 192.168.97.1::images to /dev/sda5
...
PASS3/ormorhDPOS  ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: linux kernel transferred
INFO3/ormorhDPOS  ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: POS: configuring bootloader
...
PASS2/ormorh    ..../test_linux_kernel.py#_test @3hyt-uo3g: deploy passed 
INFO3/ormorhE#1         ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/nwa: Powering on
INFO2/ormorhE#1         ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/nwa: Powered on
...
INFO2/ormorhE#1         ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: wrote &#39;echo I booted&#39; to console &#39;localhost/qu04a:&lt;default&gt;&#39;
PASS3/ormorhE#1         ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: found expected `I booted` in console `localhost/qu04a:default` at 0.01s
PASS2/ormorhE#1         ..../test_linux_kernel.py#_test @3hyt-uo3g|localhost/qu04a: eval passed: found expected `I booted` in console `localhost/qu04a:default` at 0.01s
...
PASS1/ormorh    ..../test_linux_kernel.py#_test @3hyt-uo3g: evaluation passed 
INFO0/ormorh    ..../test_linux_kernel.py#_test @3hyt-uo3g: WARNING!! not releasing targets
PASS0/            toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:03:18.911685) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_qemu_bios"></span><div class="section" id="build-install-and-boot-a-qemu-machine-with-modified-bios">
<span id="example-qemu-bios"></span><h4>4.1.3.8. Build, install and boot a QEMU machine with modified BIOS<a class="headerlink" href="#build-install-and-boot-a-qemu-machine-with-modified-bios" title="Permalink to this headline">¶</a></h4>
<p>Given a QEMU target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, build a UEFI BIOS with the vendor field modified,
provision the OS and the new BIOS, boot into it and verify via
<em>dmidecode</em> that the BIOS reports the new vendor information.</p>
<p>Builds on <a class="reference internal" href="#example-pos-base"><span class="std std-ref">deploying an OS to a target</span></a> and
<a class="reference internal" href="#example-deploy-files"><span class="std std-ref">deploying files to a target</span></a>. You can
find the list of OS images <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the server</span></a>.</p>
<p>This demonstrates how TCF can be used to create a fast development
cycle for working on changes to the BIOS code; for using any other
machine than QEMU, something with a <a class="reference internal" href="09-api.html#module-ttbl.images" title="ttbl.images"><code class="xref py py-mod docutils literal notranslate"><span class="pre">images</span></code></a>
interface that can flash the BIOS can be used.</p>
<p><strong>TIPS</strong>:</p>
<ul class="simple">
<li>always use the same target (give <code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">'nwX</span> <span class="pre">or</span> <span class="pre">TARGETX'</span></code> so that the
content is cached and each run doesn’t try to send the your built
kernel to a new target but just the bare changes. See methods for
doing this in the <a class="reference internal" href="#howto-target-keep-acquired"><span class="std std-ref">how-to section</span></a></li>
<li>if only the BIOS code is modified and there is no need to
re-provision the OS, method <em>disabled_deploy_50()</em> can be renamed
to <em>deploy_50()</em> to override the template inherited from
<a class="reference internal" href="09-api.html#tcfl.pos.tc_pos_base" title="tcfl.pos.tc_pos_base"><code class="xref py py-class docutils literal notranslate"><span class="pre">tcfl.pos.tc_pos_base</span></code></a> and skip the OS provisioning step.</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">configure_00</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;EDK2_DIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">skip_e</span><span class="p">(</span>
                <span class="s2">&quot;please export env EDK2_DIR pointing to path of &quot;</span>
                <span class="s2">&quot;configured, built or ready-to-build tree&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;EDK2_DIR&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_00</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Modify the BIOS vendor string to showcase a change</span>
        <span class="c1">#</span>
        <span class="c1"># Backslashes here are killing us; the original C code is</span>
        <span class="c1">#</span>
        <span class="c1">## #define TYPE0_STRINGS \</span>
        <span class="c1">##   &quot;EFI Development Kit II / OVMF\0&quot;     /* Vendor */ \</span>
        <span class="c1">##   &quot;0.0.0\0&quot;                             /* BiosVersion */ \</span>
        <span class="c1">##   &quot;02/06/2015\0&quot;                        /* BiosReleaseDate */</span>
        <span class="c1">#</span>
        <span class="c1"># So we need to replace all in the Vendor string until the \0,</span>
        <span class="c1"># but we need to escape that \\ for both python and the</span>
        <span class="c1"># shell. bleh.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;sed -i&quot;</span>
            <span class="s2">&quot; &#39;/Vendor/s|.*</span><span class="se">\\\\</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2">|</span><span class="se">\&quot;</span><span class="s2">I am the vendor now</span><span class="se">\\\\</span><span class="s2">0</span><span class="se">\&quot;</span><span class="s2">|&#39;&quot;</span>
            <span class="s2">&quot; &#39;</span><span class="si">%s</span><span class="s2">/OvmfPkg/SmbiosPlatformDxe/SmbiosPlatformDxe.c&#39;&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Build the new BIOS</span>
        <span class="c1">#</span>
        <span class="c1"># I lifted the build instructions of the Fedora 29 spec file</span>
        <span class="c1"># and simplified to the max, but I only know them to work on</span>
        <span class="c1"># this git version; complain otherwise</span>
        <span class="n">rev</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;git -C &#39;</span><span class="si">%s</span><span class="s2">&#39; rev-parse HEAD&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">,</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;cb5f4f45ce1fca390b99dae5c42b9c4c8b53deea&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span>
                <span class="s2">&quot;WARNING!! WARNING!!! These build process only verified to&quot;</span>
                <span class="s2">&quot; workwith git version cb5f4f45ce, found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rev</span><span class="p">,</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">GCC5_X64_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;x86_64-linux-gnu-&quot;</span><span class="p">,</span>
            <span class="n">CC_FLAGS</span> <span class="o">=</span> <span class="s2">&quot;-t GCC5 -n 4 --cmd-len=65536 -b DEBUG --hash&quot;</span> <span class="p">,</span>
        <span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;OVMF_FLAGS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(CC_FLAGS)s</span><span class="s2"> -FD_SIZE_2MB&quot;</span> <span class="o">%</span> <span class="n">env</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;re/building BaseTools in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">,</span>
                         <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="s2">&quot;${MAKE:-make} -C &#39;</span><span class="si">%s</span><span class="s2">/BaseTools&#39; -j4&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">)</span>

        <span class="c1"># there are warnings that otherwise kill the build</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="s2">&quot;sed -i -e &#39;s/-Werror//&#39; &#39;</span><span class="si">%s</span><span class="s2">/Conf/tools_def.txt&#39;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;re/building OVMF in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="s2">&quot;cd </span><span class="si">%s</span><span class="s2"> &amp;&amp; build $OVMF_FLAGS -a X64 -p OvmfPkg/OvmfPkgX64.dsc&quot;</span>
            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">)</span>

        <span class="c1"># Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;built BIOS&quot;</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">disabled_deploy_50</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># remove &quot;disabled_&quot; to override the method from the</span>
        <span class="c1"># tcfl.pos.tc_pos_base that flashes the OS--this makes the</span>
        <span class="c1"># scrip to only build, flash the bios, powercycle into the</span>
        <span class="c1"># installed OS and run the eval* steps--which works if you</span>
        <span class="c1"># know</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">deploy_90</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># Flash the new BIOS before power cycling</span>
        <span class="n">target</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;bios&quot;</span> <span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">builddir</span><span class="p">,</span>
                    <span class="s2">&quot;Build/OvmfX64/DEBUG_GCC5/FV/OVMF_CODE.fd&quot;</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="n">upload</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># power cycle to the new kernel</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;dmidecode -t bios&quot;</span><span class="p">,</span> <span class="s2">&quot;Vendor: I am the vendor now2&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;New BIOS is reporting via DMI/bios Vendor field&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_qemu_bios.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://github.com/tianocore/edk2 edk2.git
$ EDK2_DIR=$HOME/edk2.git IMAGE=clear tcf run -v /usr/share/tcf/examples/test_qemu_bios.py
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
</div>
<div class="section" id="module-examples.test_subcases">
<span id="common-patterns"></span><h3>4.1.4. Common patterns<a class="headerlink" href="#module-examples.test_subcases" title="Permalink to this headline">¶</a></h3>
<div class="section" id="reporting-subcases">
<span id="example-subcases"></span><h4>4.1.4.1. Reporting subcases<a class="headerlink" href="#reporting-subcases" title="Permalink to this headline">¶</a></h4>
<p>A common execution pattern is that a testcase executes and produces
results for multiple subcases.</p>
<p>In this example, given a target that can be provisioned with
<a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, we create a fake testcase that
generates ten subtestcase reports in individual logfiles called
<em>subN.log</em>.</p>
<p>When the testcase is created, in the <em>__init__()</em> method, we would
scan the test to discover the list of subcases that will unfold–in
this example, we are faking it–this is important because it allows us
to double check that all we expected to execute will.</p>
<p>In general, the name of the subcase is the name of the testcase plus a
<em>dot something</em> (in this case we append <em>.subN</em>); then it is added to
the <a class="reference internal" href="09-api.html#tcfl.tc.tc_c.subtc" title="tcfl.tc.tc_c.subtc"><code class="xref py py-data docutils literal notranslate"><span class="pre">subtestcase</span> <span class="pre">dictionary</span> <span class="pre">self.subtc</span></code></a> by
creating an instancel of <a class="reference internal" href="09-api.html#tcfl.tc.subtc_c" title="tcfl.tc.subtc_c"><code class="xref py py-class docutils literal notranslate"><span class="pre">tcfl.tc.subtc_c</span></code></a>, which implements
this pattern.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tc_file_path</span><span class="p">,</span> <span class="n">origin</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tc_file_path</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>

        <span class="c1"># &quot;scan&quot; for subcases (in our case, we know they&#39;ll be sub0 to sub9)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">subcase</span> <span class="o">=</span> <span class="s2">&quot;sub</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtc</span><span class="p">[</span><span class="n">subcase</span><span class="p">]</span> <span class="o">=</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">subtc_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">subcase</span><span class="p">,</span>
                                                  <span class="n">tc_file_path</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>

        <span class="c1"># Run our imaginary testcase in the target</span>
        <span class="c1">#</span>
        <span class="c1"># this script (our &#39;testcase&#39;) creates N files subX.log on</span>
        <span class="c1"># which the fist line is 0, 1 or 2 (pass, fail, error), a fake</span>
        <span class="c1"># summary and therest are a random made up log file we want to</span>
        <span class="c1"># report. Eg:</span>
        <span class="c1">#</span>
        <span class="c1">#   2</span>
        <span class="c1">#   Summary for subtest 5</span>
        <span class="c1">#   zsh syslinux zoneinfo hwdata file pixmaps drirc.d icons mime-packages</span>
        <span class="c1">#   gir-1.0 nano gtk-2.0 graphite2 libinput GConf misc vpnc bash-completion</span>
        <span class="c1">#   scan-view openldap security screen wayland cups opt-viewer znc pam.d</span>
        <span class="c1">#   libtool aclocal keyutils</span>
        <span class="c1">#</span>
        <span class="c1"># for a list of words that works everywhere, we just list /usr/share</span>
        <span class="c1"># `shuf` picks 30 random lines from input and `fmt` makes a</span>
        <span class="c1"># paragraph out of that.</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;for((n = 0; n &lt; </span><span class="si">%d</span><span class="s1">; n++));&#39;</span>
                         <span class="s1">&#39; do (&#39;</span>
                         <span class="s1">&#39;  echo $((RANDOM </span><span class="si">%%</span><span class="s1"> 3)); &#39;</span>
                         <span class="s1">&#39;  echo Summary for subtest $n; &#39;</span>
                         <span class="s1">&#39;  /bin/ls /usr/share | shuf -n 30 | fmt&#39;</span>
                         <span class="s1">&#39; ) &gt; sub$n.log;&#39;</span>
                         <span class="s1">&#39;done&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subtc</span><span class="p">))</span>

        <span class="c1"># cat each log file to tell what happened? we know the log</span>
        <span class="c1"># file names, so we can just iterate in python -- in other</span>
        <span class="c1"># cases, we might have to list files in the target to find the</span>
        <span class="c1"># log files, or scan through a big log file that has</span>
        <span class="c1"># indications of where the output for one subcase start and</span>
        <span class="c1"># ends.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subtc</span><span class="p">)):</span>
            <span class="n">subcase_name</span> <span class="o">=</span> <span class="s2">&quot;sub</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">n</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;cat </span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="n">subcase_name</span><span class="p">,</span>
                                      <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">trim</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
            <span class="c1"># first line is result, parse it</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">log</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># translate the result to a TCF result</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
                <span class="n">_result</span> <span class="o">=</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">result_c</span><span class="p">(</span><span class="n">passed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="n">_result</span> <span class="o">=</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">result_c</span><span class="p">(</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
                <span class="n">_result</span> <span class="o">=</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">result_c</span><span class="p">(</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;unknown result from command output &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                     <span class="o">%</span> <span class="n">result</span><span class="p">)</span>

            <span class="c1"># For each subcase&#39;s output, update the subcase report</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subtc</span><span class="p">[</span><span class="n">subcase_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_result</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_subcases.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -v /usr/share/tcf/examples/test_subcases.py
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>where IMAGE is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>.</p>
</div>
</div>
<div class="section" id="module-examples.test_audio_capture">
<span id="capturing-data-doing-ssh"></span><h3>4.1.5. Capturing data, doing SSH<a class="headerlink" href="#module-examples.test_audio_capture" title="Permalink to this headline">¶</a></h3>
<div class="section" id="reproducing-audio-and-capturing-the-output">
<h4>4.1.5.1. Reproducing audio and capturing the output<a class="headerlink" href="#reproducing-audio-and-capturing-the-output" title="Permalink to this headline">¶</a></h4>
<p>Given a target from which we can record audio, play a beep sound,
record it, and then compare with the original</p>
<p>The target selection for this test is any target that can be
provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a> and supports
capture of audio over capturer called <em>front_astream</em>, which is
usually connected to the front audio output of the target.</p>
<p>The <a class="reference download internal" href="../_downloads/beep.wav" download=""><code class="xref download docutils literal notranslate"><span class="pre">sound</span> <span class="pre">file</span></code></a> is a beep,
located in the <em>examples/data</em> subdirectory and is sent to the
target during the deployment phase, after flashing the image.</p>
<p>When the OS boots, the <em>beep.wav</em> file is already in <em>/home</em>,
ready to be played. The test starts recording the target’s audio
output, plays the <em>beep</em>, and then downloads the recording.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;pos_capable and capture:&#39;front_astream:stream&#39; &quot;</span>
                <span class="s2">&quot;and ic.id in interconnects&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos0_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple audio test</span>

<span class="sd">    Play a beep while capturing the audio output, ensure they match</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s1">&#39;clear:desktop&#39;</span><span class="p">)</span>
    <span class="n">login_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOGIN_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># the format is still a wee bit pedestrian, we&#39;ll improve the</span>
        <span class="c1"># argument passing</span>
        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/data/beep.wav&quot;</span>
        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_dest</span> <span class="o">=</span> <span class="s2">&quot;/home/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_image_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_deploy_fns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_path</span> <span class="p">])</span>
	
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">capture</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="s2">&quot;front_astream&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;aplay -D front /home/beep.wav&quot;</span> <span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">capture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;front_astream&quot;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">report_file_prefix</span> <span class="o">+</span> <span class="s2">&quot;capture.wav&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_audio_capture.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear tcf run -vv /usr/share/tcf/examples/test_audio_capture.py
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>where IMAGE is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>.</p>
</div>
<span class="target" id="module-examples.test_ssh_in"></span><div class="section" id="enabling-target-s-ssh-server-and-executing-an-ssh-command">
<span id="example-ssh-in"></span><h4>4.1.5.2. Enabling target’s SSH server and executing an SSH command<a class="headerlink" href="#enabling-target-s-ssh-server-and-executing-an-ssh-command" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, execute a command with SSH.</p>
<p>This allows to login via SSH, copy and rsync files around, etc.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;pos_capable&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos0_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy files after installing OS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s1">&#39;clear:desktop&#39;</span><span class="p">)</span>
    <span class="n">login_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LOGIN_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>

    <span class="nd">@tcfl.tc.serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">deploy_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># the format is still a wee bit pedestrian, we&#39;ll improve the</span>
        <span class="c1"># argument passing</span>
        <span class="c1"># This could be a single path not necessarily a list of them</span>
        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_src</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># send a directory tree, the one containing this file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">],</span>
            <span class="c1"># send just a file, ../README.rst</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">],</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;README.rst&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">target</span><span class="o">.</span><span class="n">deploy_path_dest</span> <span class="o">=</span> <span class="s2">&quot;/home/place&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deploy_image_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_deploy_fns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_path</span> <span class="p">])</span>
	
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;find /home -ls&quot;</span><span class="p">)</span>
        <span class="c1"># verify the file exists and is the same</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="s2">&quot;md5sum &lt; /home/place/examples/data/beep.wav&quot;</span><span class="p">,</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">trim</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;md5sum &lt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/data/beep.wav&quot;</span><span class="p">,</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">remote</span> <span class="o">!=</span> <span class="n">local</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;MD5 mismatch (local </span><span class="si">%s</span><span class="s2"> remote </span><span class="si">%s</span><span class="s2">)&quot;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">remote</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;deployed file is identical to local!&quot;</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_ssh_in.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=clear  tcf run -Dvvvt &#39;nwa or qu04a&#39; tcf.git/examples/test_ssh_in.py
INFO1/l79r    .../test_ssh_in.py#_test @zsqj-uwny: will run on target group &#39;ic=SERVER/nwa target=SERVER/qu04a:x86_64&#39;
PASS1/l79r    .../test_ssh_in.py#_test @zsqj-uwny: evaluation passed 
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:42.127021) - passed 
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>Note that once you have enabled the SSH server, you can use in the
script the functions enabled by the <a class="reference internal" href="09-api.html#tcfl.target_ext_ssh.ssh" title="tcfl.target_ext_ssh.ssh"><code class="xref py py-class docutils literal notranslate"><span class="pre">target.ssh</span></code></a> interface. As well, as long as the
<em>target</em> and the <em>network</em> are on, you can create a tunnel through the
server to access remotely:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf acquire nwa qu04a
$ tcf power-on nwa qu04a
</pre></div>
</div>
<p>Find the IPv4 address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf tcf list -vv qu04a | grep ipv4_addr
interconnects.nwa.ipv4_addr: 192.168.97.4
</pre></div>
</div>
<p>Establish a tunnel to the SSH port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf tunnel-add qu04a 22 tcp 192.168.97.4
SERVERNAME:20250
</pre></div>
</div>
<p>SSH into the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh -p 20250 root@SERVERNAME
...
</pre></div>
</div>
<p>Similarly <em>scp -P 20250 root&#64;SERVERNAME:REMOTEFILE .</em> or <em>rsync</em> over
SSH.</p>
<p>Learn more about tunnels <a class="reference internal" href="#tunnels-linux-ssh"><span class="std std-ref">here</span></a>.</p>
</div>
<span class="target" id="module-examples.test_linux_ssh"></span><div class="section" id="different-options-of-accessing-a-target-via-ssh">
<span id="example-linux-ssh"></span><h4>4.1.5.3. Different options of accessing a target via SSH<a class="headerlink" href="#different-options-of-accessing-a-target-via-ssh" title="Permalink to this headline">¶</a></h4>
<p>Given a target that can be provisioned with <a class="reference internal" href="03-server-setup.html#pos-setup"><span class="std std-ref">Provisioning OS</span></a>, setup its SSH server and run commands, copy files around.</p>
<p>Note that accessing a target over <em>ssh</em> with automation is not as
straightforward as doing it by hand, since humans are way slower than
automation. We also tend to assume passwords and keys are setup,
hostnames availables and server started and ready to go. Those are the
most common source of issues.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">tc_pos_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exercise different SSH calls with the SSH extension on a PC target</span>
<span class="sd">    that is provisioned to a Linux OS (Clear, by default)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_requested</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s1">&#39;clear:desktop&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_00_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># setup the SSH server to allow login as root with no password</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">linux_ssh_root_nopwd</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;systemctl restart sshd&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>		<span class="c1"># wait for sshd to be ready</span>
            <span class="s2">&quot;while ! curl -s http://localhost:22 | /usr/bin/fgrep SSH-2.0; do&quot;</span>
            <span class="s2">&quot; sleep 1s; done&quot;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
        <span class="c1"># Tell the tunnelling system which IP address to use</span>
        <span class="c1"># Note the client running this can&#39;t connect directly to the</span>
        <span class="c1"># DUT because the DUT is connected to an isolated</span>
        <span class="c1"># NUT. However, the server is connceted to the NUT and can</span>
        <span class="c1"># bridge us. With this we tell the tunneling system which ip</span>
        <span class="c1"># address to use.</span>
        <span class="n">target</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">addr_get</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="s2">&quot;ipv4&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_01_run_ssh_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># Run commands over SSH</span>
        <span class="c1">#</span>
        <span class="c1"># https://intel.github.io/tcf/doc/09-api.html?highlight=ssh#tcfl.target_ext_ssh.ssh.check_output</span>
        <span class="c1">#target.ssh._ssh_cmdline_options.append(&quot;-v&quot;)	# DEBUG login problems</span>
        <span class="c1">#target.ssh._ssh_cmdline_options.append(&quot;-v&quot;)	# DEBUG login problems</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;echo hello&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;hello&#39;</span> <span class="ow">in</span> <span class="n">output</span>

        <span class="c1"># Alternative way to do it https://intel.github.io/tcf/doc/04-HOWTOs.html?highlight=ssh#linux-targets-ssh-login-from-a-testcase-client</span>
        <span class="c1"># by hand</span>

        <span class="c1"># create a tunnel from server_name:server_port -&gt; to target:22</span>
        <span class="n">server_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">rtb</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>
        <span class="n">server_port</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
            <span class="s2">&quot;/usr/bin/ssh -p </span><span class="si">%d</span><span class="s2"> root@</span><span class="si">%s</span><span class="s2"> echo hello&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">server_port</span><span class="p">,</span> <span class="n">server_name</span><span class="p">),</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="c1"># this is done behind the doors of TCF, it doesn&#39;t know that</span>
        <span class="c1"># it was run, so report about it</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Ran SSH: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;hello&#39;</span> <span class="ow">in</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">eval_02_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;true over SSH passed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;false&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;false over SSH passed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_03_check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;echo -n </span><span class="si">%s</span><span class="s2"> &gt; somefile&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;created a file with SSH command&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_04_check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;echo example output&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;SSH check_output returns: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">eval_05_copy_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="s2">&quot;somefile&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;somefile&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">read_ts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;read ts is </span><span class="si">%s</span><span class="s2">, gen is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">read_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">read_ts</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span>
                    <span class="s2">&quot;The timestamp read from the file we copied from &quot;</span>
                    <span class="s2">&quot;the target (</span><span class="si">%s</span><span class="s2">) differs from the one we generated (</span><span class="si">%s</span><span class="s2">)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">read_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;File created with SSH command copied back ok&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_06_copy_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># test copying file relative to the script source</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="s1">&#39;data/beep.wav&#39;</span><span class="p">)</span>
        <span class="n">base_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>	<span class="c1"># this file</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">base_file</span><span class="p">)</span>
        <span class="n">copied_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">base_file</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">base_file</span><span class="p">,</span> <span class="n">copied_file</span><span class="p">)</span>

        <span class="n">orig_hash</span> <span class="o">=</span> <span class="n">commonl</span><span class="o">.</span><span class="n">hash_file</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(),</span> <span class="vm">__file__</span><span class="p">)</span>
        <span class="n">copied_hash</span> <span class="o">=</span> <span class="n">commonl</span><span class="o">.</span><span class="n">hash_file</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(),</span> <span class="n">copied_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig_hash</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span> <span class="o">!=</span> <span class="n">copied_hash</span><span class="o">.</span><span class="n">digest</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;Hashes in copied files changed&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;Bigger file copied around is identical&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">eval_07_tree_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">copied_subdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;tmpdir&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/dest&quot;</span>

        <span class="c1"># Copy a tree to remote, then copy it back</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;rm -rf subdir&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">copied_subdir</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;srcdir_abs&#39;</span><span class="p">],</span> <span class="s2">&quot;subdir&quot;</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="s2">&quot;subdir&quot;</span><span class="p">,</span> <span class="n">copied_subdir</span><span class="p">,</span> <span class="n">recursive</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

        <span class="c1"># Generate MD5 signatures of the python files in the same order</span>
        <span class="n">local_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;find </span><span class="si">%(srcdir)s</span><span class="s2"> -type f -iname \*.py&quot;</span>
            <span class="s2">&quot; | sort | xargs cat | md5sum&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">copied_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;find </span><span class="si">%(tmpdir)s</span><span class="s2">/dest -type f -iname \*.py&quot;</span>
            <span class="s2">&quot; | sort | xargs cat | md5sum&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;local_md5 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">local_md5</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;copied_md5 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">copied_md5</span><span class="p">,</span> <span class="n">dlevel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">local_md5</span> <span class="o">!=</span> <span class="n">copied_md5</span><span class="p">:</span>
            <span class="n">local_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;find </span><span class="si">%(srcdir)s</span><span class="s2"> -type f -iname \*.py | sort&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">copied_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;find </span><span class="si">%(tmpdir)s</span><span class="s2">/dest -type f -iname \*.py | sort&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span>
                <span class="s2">&quot;local and copied MD5s differ&quot;</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">local_list</span> <span class="o">=</span> <span class="n">local_list</span><span class="p">,</span> <span class="n">copied_list</span> <span class="o">=</span> <span class="n">copied_list</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;tree copy passed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">console_dump_on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_linux_ssh.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>
with (where <em>IMAGE</em> is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in
the server</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -v /usr/share/tcf/examples/test_linux_ssh.py
INFO1/q4ux      ..../test_linux_ssh.py#_test @t7rd-4e2t: will run on target group &#39;ic=jfsotc11/nwk target=jfsotc11/nuc-70k:x86_64&#39;
INFO1/q4uxDPOS  ..../test_linux_ssh.py#_test @t7rd-4e2t|jfsotc11/nuc-70k: POS: rsyncing clear:server:30590::x86_64 from 192.168.107.1::images to /dev/sda6
PASS1/q4ux      ..../test_linux_ssh.py#_test @t7rd-4e2t: evaluation passed
PASS0/  toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:02:20.841000) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<p>where IMAGE is the name of a Linux OS image <a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the
server</span></a>.</p>
</div>
</div>
<div class="section" id="keywords-that-are-available-to-this-testcase-while-running-on-a-target">
<span id="finding-testcase-metadata"></span><h3>4.1.6. Keywords that are available to this testcase while running on a target<a class="headerlink" href="#keywords-that-are-available-to-this-testcase-while-running-on-a-target" title="Permalink to this headline">¶</a></h3>
<p>Any of the keywords reported here can be used in a testcase script, in
multiple places of TCF configuration as Python templates with fields
such as <cite>%(tc_name)s</cite> and in report templates.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">dev</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">something</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="n">KEYWORDZ</span><span class="p">]</span>
        <span class="o">...</span>
        <span class="n">somethingelse</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="n">KEYWORDY</span><span class="p">]</span>
        <span class="o">...</span>
        <span class="n">andthis</span> <span class="o">=</span> <span class="n">target1</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="n">KEYWORDZ</span><span class="p">]</span>
        <span class="o">...</span>
</pre></div>
</div>
<span class="target" id="module-examples.test_dump_kws"></span><div class="section" id="static-testcases-no-targets-run-local">
<h4>4.1.6.1. Static testcases (no targets, run local)<a class="headerlink" href="#static-testcases-no-targets-run-local" title="Permalink to this headline">¶</a></h4>
<p>Notice the test group values are slightly different between the
multiple targets, the single target or no targets (static) cases.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">build_only</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for testcase:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                         <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_dump_kws.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vv /usr/share/tcf/examples/test_dump_kws.py
INFO0/vxmvB   /usr/share/tcf/examples/test_dump_kws.py#_test @localic-localtg: Keywords for testcase:
{&#39;cwd&#39;: &#39;/home/inaky/z/s/local&#39;,
 &#39;runid&#39;: &#39;&#39;,
 &#39;srcdir&#39;: &#39;../../../../../usr/share/tcf/examples&#39;,
 &#39;srcdir_abs&#39;: &#39;/usr/share/tcf/examples&#39;,
 &#39;target_group_info&#39;: &#39;localic-localtg&#39;,
 &#39;target_group_name&#39;: &#39;localic-localtg&#39;,
 &#39;target_group_servers&#39;: &#39;&#39;,
 &#39;target_group_targets&#39;: &#39;&#39;,
 &#39;target_group_types&#39;: &#39;static&#39;,
 &#39;tc_hash&#39;: &#39;vxmv&#39;,
 &#39;tc_name&#39;: &#39;/usr/share/tcf/examples/test_dump_kws.py#_test&#39;,
 &#39;tc_name_short&#39;: &#39;/usr/share/tcf/examples/test_dump_kws.py#_test&#39;,
 &#39;tc_origin&#39;: &#39;/usr/share/tcf/examples/test_dump_kws.py:46&#39;,
 &#39;thisfile&#39;: &#39;/usr/share/tcf/examples/test_dump_kws.py&#39;,
 &#39;tmpdir&#39;: &#39;/tmp/tcf.run-9tJyXx/vxmv&#39;,
 &#39;type&#39;: &#39;static&#39;}
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:00.302539) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_dump_kws_one_target"></span><div class="section" id="testcase-using-one-target">
<h4>4.1.6.2. Testcase using one target<a class="headerlink" href="#testcase-using-one-target" title="Permalink to this headline">¶</a></h4>
<p>Note the data offered for the target is a superse of the testcase’s
augmented with all the target metadata exported by the server</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.target</span><span class="p">()</span>
<span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">build_only</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for testcase:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                         <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for target 0:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                           <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_dump_kws_one_target.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vv /usr/share/tcf/examples/test_dump_kws_one_target.py
INFO0/gcoyBwifr       /usr/share/tcf/examples/test_dump_kws_one_target.py#_test @localhost/qz31b-x86: Keywords for testcase:
{&#39;cwd&#39;: &#39;/home/inaky/z/s/local&#39;,
 &#39;runid&#39;: &#39;&#39;,
 &#39;srcdir&#39;: &#39;../../../../../usr/share/tcf/examples&#39;,
 &#39;srcdir_abs&#39;: &#39;/usr/share/tcf/examples&#39;,
 ...
 &#39;target_group_targets&#39;: u&#39;localhost/qz31b-x86:x86&#39;,
 &#39;target_group_types&#39;: u&#39;qemu-zephyr-x86&#39;,
 &#39;tc_hash&#39;: &#39;gcoy&#39;,
 &#39;tc_name&#39;: &#39;/usr/share/tcf/examples/test_dump_kws_one_target.py#_test&#39;,
 &#39;tc_name_short&#39;: &#39;/usr/share/tcf/examples/test_dump_kws_one_target.py#_test&#39;,
 &#39;tc_origin&#39;: &#39;/usr/share/tcf/examples/test_dump_kws_one_target.py:50&#39;,
 &#39;thisfile&#39;: &#39;/usr/share/tcf/examples/test_dump_kws_one_target.py&#39;,
 &#39;tmpdir&#39;: &#39;/tmp/tcf.run-DmwH93/gcoy&#39;,
 &#39;type&#39;: u&#39;qemu-zephyr-x86&#39;}
INFO0/gcoyBwifr       /usr/share/tcf/examples/test_dump_kws_one_target.py#_test @localhost/qz31b-x86: Keywords for target 0:
{u&#39;board&#39;: u&#39;qemu_x86&#39;,
 &#39;bsp&#39;: u&#39;x86&#39;,
 u&#39;bsp_models&#39;: {u&#39;x86&#39;: [u&#39;x86&#39;]},
 u&#39;bsps&#39;: {u&#39;x86&#39;: {u&#39;board&#39;: u&#39;qemu_x86&#39;,
                    u&#39;console&#39;: u&#39;x86&#39;,
 ...
 u&#39;interconnects&#39;: {u&#39;nwb&#39;: {u&#39;ic_index&#39;: 31,
                             u&#39;ipv4_addr&#39;: u&#39;192.168.98.31&#39;,
                             u&#39;ipv4_prefix_len&#39;: 24,
                             u&#39;ipv6_addr&#39;: u&#39;fc00::62:1f&#39;,
                             u&#39;ipv6_prefix_len&#39;: 112,
                             u&#39;mac_addr&#39;: u&#39;02:62:00:00:00:1f&#39;}},
 u&#39;interfaces&#39;: [u&#39;power&#39;,
                 u&#39;images&#39;,
                 u&#39;console&#39;,
                 u&#39;debug&#39;],
 ...
 &#39;url&#39;: u&#39;https://localhost:5000/ttb-v1/targets/qz31b-x86&#39;,
 u&#39;zephyr_board&#39;: u&#39;qemu_x86&#39;,
 u&#39;zephyr_kernelname&#39;: u&#39;zephyr.elf&#39;}
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:00.302253) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
<span class="target" id="module-examples.test_dump_kws_two_targets"></span><div class="section" id="testcase-using-two-targets">
<h4>4.1.6.3. Testcase using two targets<a class="headerlink" href="#testcase-using-two-targets" title="Permalink to this headline">¶</a></h4>
<p>Note n this case the target group names are listing two targets and
each target obejct has different values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.target</span><span class="p">()</span>
<span class="nd">@tcfl.tc.target</span><span class="p">()</span>
<span class="nd">@tcfl.tc.tags</span><span class="p">(</span><span class="n">build_only</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">ignore_example</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for testcase:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                         <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                         <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for target 0:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                           <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                           <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Keywords for target 1:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">target1</span><span class="o">.</span><span class="n">kws</span><span class="p">),</span>
                            <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Execute <a class="reference download internal" href="../_downloads/test_dump_kws_two_targets.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vv /usr/share/tcf/examples/test_dump_kws_twp_targets.py
INFO0/ato4B   /usr/share/tcf/examples/test_dump_kws_two_targets.py#_test @2psg: Keywords for testcase:
{&#39;cwd&#39;: &#39;/home/inaky/z/s/local&#39;,
 ...}
INFO0/ato4B   /usr/share/tcf/examples/test_dump_kws_two_targets.py#_test @2psg|localhost/qz33b-arm: Keywords for target 0:
{u&#39;board&#39;: u&#39;qemu_cortex_m3&#39;,
 &#39;bsp&#39;: u&#39;arm&#39;,
 u&#39;bsp_models&#39;: {u&#39;arm&#39;: [u&#39;arm&#39;]},
 u&#39;bsps&#39;: {u&#39;arm&#39;: {u&#39;board&#39;: u&#39;qemu_cortex_m3&#39;,
                    u&#39;console&#39;: u&#39;arm&#39;,
                    u&#39;kernelname&#39;: u&#39;zephyr.elf&#39;,
 ...
 u&#39;zephyr_board&#39;: u&#39;qemu_cortex_m3&#39;,
 u&#39;zephyr_kernelname&#39;: u&#39;zephyr.elf&#39;}
INFO0/ato4B   /usr/share/tcf/examples/test_dump_kws_two_targets.py#_test @2psg|localhost/qz31a-x86: Keywords for target 1:
{u&#39;board&#39;: u&#39;qemu_x86&#39;,
 &#39;bsp&#39;: u&#39;x86&#39;,
 u&#39;bsp_models&#39;: {u&#39;x86&#39;: [u&#39;x86&#39;]},
 u&#39;bsps&#39;: {u&#39;x86&#39;: {u&#39;board&#39;: u&#39;qemu_x86&#39;,
                    u&#39;console&#39;: u&#39;x86&#39;,
                    u&#39;kernelname&#39;: u&#39;zephyr.elf&#39;,
                    u&#39;quark_se_stub&#39;: False,
 ...
 u&#39;zephyr_board&#39;: u&#39;qemu_x86&#39;,
 u&#39;zephyr_kernelname&#39;: u&#39;zephyr.elf&#39;}
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:00.417956) - passed
</pre></div>
</div>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
</div>
</div>
<div class="section" id="testcase-drivers">
<h3>4.1.7. Testcase drivers<a class="headerlink" href="#testcase-drivers" title="Permalink to this headline">¶</a></h3>
<p>Testcase drivers load and execute existing testcases.</p>
<span class="target" id="module-examples.test_ptest_runner"></span><div class="section" id="impromptu-testcase-driver-to-execute-and-report-yocto-oe-ptest-runner-testcases">
<span id="example-ptest-runner"></span><h4>4.1.7.1. Impromptu testcase driver to execute and report Yocto/OE ptest-runner testcases<a class="headerlink" href="#impromptu-testcase-driver-to-execute-and-report-yocto-oe-ptest-runner-testcases" title="Permalink to this headline">¶</a></h4>
<p>This is a simple driver for executing Yocto/OE testcases, which are
usually installed in the system already.</p>
<p>The testsuites available can be listed with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ptest</span><span class="o">-</span><span class="n">runner</span> <span class="o">-</span><span class="n">l</span>
<span class="n">Available</span> <span class="n">ptests</span><span class="p">:</span>
<span class="n">acl</span>   <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">acl</span><span class="o">/</span><span class="n">ptest</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">ptest</span>
<span class="n">attr</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">attr</span><span class="o">/</span><span class="n">ptest</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">ptest</span>
<span class="n">bash</span>  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">bash</span><span class="o">/</span><span class="n">ptest</span><span class="o">/</span><span class="n">run</span><span class="o">-</span><span class="n">ptest</span>
<span class="n">bluez5</span>        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">bluez5</span><span class="o">/</span><span class="n">ptest</span><span class="o">/</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Each suite contains one or more subcases, so the layout is like:</p>
<blockquote>
<div><ul class="simple">
<li>TESTSUITE1
- SUBCASE1
- SUBCASE2
- SUBCASE2
- …</li>
<li>TESTSUITE2
- SUBCASE1
- …</li>
<li>TESTSUITE3
- SUBCASE1
- SUBCASE2
- …</li>
<li>…</li>
</ul>
</div></blockquote>
<p>Subcases will be reported as described in :ref:&lt;example_subcases&gt;, but
because we have no way to discover the number of subcases (before or
after provisioning, powering on and contacting the system), the total
number of reported testcases will vary wildly if the system cannot be
provisioned or powered on or if the testcase execution timesout.</p>
<p>Note this also servers as an example of an <a class="reference internal" href="glossary.html#term-impromptu-testcase-driver"><span class="xref std std-term">impromptu test driver</span></a>.</p>
<p>To execute, <a class="reference download internal" href="../_downloads/test_ptest_runner.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">the</span> <span class="pre">testcase</span></code></a>.</p>
<ul>
<li><p class="first">Find and run all the testsuites installed in the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=yocto:core-image-sato-sdk-ptest     tcf run -v test_ptest_runner.py
</pre></div>
</div>
</li>
<li><p class="first">run testsuites <em>zlib</em> and <em>gzip</em> only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=yocto:core-image-sato-sdk-ptest     tcf run -v test_ptest_runner.py#zlib#gzip
</pre></div>
</div>
</li>
<li><p class="first">run testsuites <em>zlib</em> and <em>gzip</em> on one side and <em>valgrind</em> and
<em>bash</em> in another:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=yocto:core-image-sato-sdk-ptest     tcf run -v test_ptest_runner.py#zlib#gzip test_ptest_runner.py#valgrind#bash
</pre></div>
</div>
</li>
</ul>
<p>(where <em>IMAGE</em> is the name of a Yocto Linux OS image
<a class="reference internal" href="03-server-setup.html#pos-list-images"><span class="std std-ref">installed in the server</span></a>).</p>
<p>(depending on your installation method, location might be
<em>~/.local/share/tcf/examples</em>)</p>
<dl class="data">
<dt id="examples.test_ptest_runner.timeouts">
<code class="descclassname">examples.test_ptest_runner.</code><code class="descname">timeouts</code><em class="property"> = {'bash': 120, 'lzo': 60, 'mdadm': 240, 'valgrind': 300}</em><a class="headerlink" href="#examples.test_ptest_runner.timeouts" title="Permalink to this definition">¶</a></dt>
<dd><p>Timeouts per suite name (in seconds)</p>
<p>When the default is too short, or needs ajustment</p>
</dd></dl>

<dl class="data">
<dt id="examples.test_ptest_runner.timeout_default">
<code class="descclassname">examples.test_ptest_runner.</code><code class="descname">timeout_default</code><em class="property"> = 30</em><a class="headerlink" href="#examples.test_ptest_runner.timeout_default" title="Permalink to this definition">¶</a></dt>
<dd><p>Default timeout (seconds) to execute a ptest</p>
</dd></dl>

</div>
</div>
<div class="section" id="creating-a-file-in-the-target-from-the-command-line">
<h3>4.1.8. Creating a file in the target from the command line<a class="headerlink" href="#creating-a-file-in-the-target-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>The following Unix shell construct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat &lt;&lt;EOF &gt; somefile
line1
line2
line3
EOF
</pre></div>
</div>
<p>can also be done in a TCF script:</p>
<p>but since the shell console is actually <em>typing</em> the characters, it is
slightly more reliable to use:</p>
<p><em>x04</em> is the ASCII end-of-transmission character, <em>Ctrl-D</em>. This is
the equivalent of typing the file contents on the command line.</p>
</div>
</div>
<div class="section" id="tcf-client-tricks">
<h2>4.2. TCF client tricks<a class="headerlink" href="#tcf-client-tricks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="where-is-the-tcf-client-configuration-taken-from">
<span id="tcf-client-configuration"></span><h3>4.2.1. Where is the TCF client configuration taken from?<a class="headerlink" href="#where-is-the-tcf-client-configuration-taken-from" title="Permalink to this headline">¶</a></h3>
<p><em>tcf</em> reads configuration files from (in this order):</p>
<ul class="simple">
<li><em>.tcf</em> (a subdirectory of the current working directory)</li>
<li><em>~/.tcf</em></li>
<li><em>~/.local/etc/tcf</em> (if installed in user’s home only with <em>python
setup.py install –user</em> or <em>pip install –user</em>)</li>
<li><em>/etc/tcf</em> (if installed globally, eg with a package manager)</li>
</ul>
<p>Configuration files are called <em>conf_WHATEVER.py</em> and imported in
<strong>alphabetical</strong> order from each directory before proceeding to the
next one. They are written in plain Python code, so you can do
anything, even extend TCF from them. The module <a class="reference internal" href="09-api.html#module-tcfl.config" title="tcfl.config"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tcfl.config</span></code></a>
provides access to functions to set TCF’s configuration.</p>
<p>You can add new paths to parse with <code class="docutils literal notranslate"><span class="pre">--config-path</span></code> and force
specific files to be read with <code class="docutils literal notranslate"><span class="pre">--config-file</span></code>. See <em>tcf –help</em>.</p>
</div>
<div class="section" id="how-do-i-list-which-targets-i-own">
<h3>4.2.2. How do I list which targets I own?<a class="headerlink" href="#how-do-i-list-which-targets-i-own" title="Permalink to this headline">¶</a></h3>
<p>Run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf list -v &#39;owner:&quot;MYNAME&quot;&#39;
</pre></div>
</div>
<p><em>MYNAME</em> is whatever identifier you used to login.</p>
</div>
<div class="section" id="how-do-i-release-a-target-i-don-t-own">
<span id="howto-release-target"></span><h3>4.2.3. How do I release a target I don’t own?<a class="headerlink" href="#how-do-i-release-a-target-i-don-t-own" title="Permalink to this headline">¶</a></h3>
<p>Someone owns the target and they have gone home…:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf release -f TARGETNAME
</pre></div>
</div>
<p>But this only works if you have admin permissions.</p>
<p>The exception is if you have locked yourself the target with a
<em>ticket</em> (used by <em>tcf run</em> and others so that the same user running
different processes in parallel can still exclude itself from
overusing a target). It will say something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span> <span class="mi">400</span><span class="p">:</span> <span class="n">TARGETNAME</span><span class="p">:</span> <span class="n">tried</span> <span class="n">to</span> <span class="n">use</span> <span class="n">busy</span> <span class="n">target</span> <span class="p">(</span><span class="n">owned</span> <span class="n">by</span> <span class="s1">&#39;MYUSERNAME:TICKETSTRING&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As a user, you can always force release any of your own locks with
<cite>-f</cite> or with <cite>-t TICKETSTRING</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t TICKETSTRING release TARGETNAME
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-release-all-the-targets-i-own">
<h3>4.2.4. How do I release all the targets I own?<a class="headerlink" href="#how-do-i-release-all-the-targets-i-own" title="Permalink to this headline">¶</a></h3>
<p>Run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf release -f $(tcf list &#39;owner:&quot;MYNAME&quot;&#39;)
</pre></div>
</div>
<ul class="simple">
<li><em>MYNAME</em> is whatever identifier you used to login</li>
<li><em>tcf list ‘owner:”MYNAME”’</em> lists which targets you currently own</li>
</ul>
</div>
<div class="section" id="how-do-i-keep-a-target-acquired-reserved-after-tcf-run-is-done">
<span id="howto-target-keep-acquired"></span><h3>4.2.5. How do I keep a target acquired/reserved after <em>tcf run</em> is done?<a class="headerlink" href="#how-do-i-keep-a-target-acquired-reserved-after-tcf-run-is-done" title="Permalink to this headline">¶</a></h3>
<p>Giving <em>–no-release</em> to <em>tcf run</em> will keep the target acquired after
the scrip execution concludes. Note however that it will be acquired
by <em>USERNAME::term:`HASHID`</em> (<a class="reference internal" href="glossary.html#term-hash"><span class="xref std std-term">what’s a hashid?</span></a>).</p>
<p>For example, if we were using targets <em>nwa</em> and <em>qu04a</em> to <a class="reference internal" href="#example-pos-boot"><span class="std std-ref">boot
in provisioning mode</span></a>, the hashid could be
<em>ormorh</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run --no-release -vvt &#39;nwa or qu04a&#39; /usr/share/examples/test_pos_boot.py
...
INFO1/ormorh    ..../test_pos_boot.py#_test @3hyt-uo3g: will run on target group &#39;ic=localhost/nwa target=localhost/qu04a:x86_64&#39;
...
</pre></div>
</div>
<p>note how the hashid is <em>ormorh</em> in this case and thus, upon completion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf list -v owner
localhost/nwa [USERNAME:ormorh] ON
localhost/qu04a [USERNAME:ormorh] ON
</pre></div>
</div>
<p>to maintain the target acquired and powered while potentially
debugging or testing other things, use a <em>while loop</em> which keeps
acquiring with the same hashid. This tells the daemon we are actively
using the target and won’t release for us. In a separate console, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ while tcf -t ormorh acquire nwa or qu04a; do sleep 10s; done
</pre></div>
</div>
<p>now you can access the console, do captures or interact with the
target in any other way, remembering to specify the ticket:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t ormorh console-write -i qu04a
$ tcf -t ormorh capture-get qu04a screen screencap.png
...
</pre></div>
</div>
<p>or via SSH, first we have to ask the server to create a tunnel for us
from to the target’s SSH port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf list -vv qu04a | grep ipv4_addr
interconnects.nwa.ipv4_addr: 192.168.97.4
$ tcf tunnel-add qu04a 22 tcp 192.168.97.4
SERVERNAME:19893
$ ssh -p 19893 root@SERVERNAME
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">make sure you specify the user to login as; it likely won’t
be the same as in your client machine.</p>
</div>
<p>Release the target so it can be used by someone else:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kill -9 %1               # kill the while loop that keeps it acquired
$ tcf release -f $(tcf list &#39;owner:&quot;YOURNAME&quot;&#39;)
</pre></div>
</div>
<p>Some details:</p>
<blockquote>
<div><ul class="simple">
<li>use <em>while tcf acquire</em> vs <em>while true; do tcf acquire</em> because
that way, if the server fails, connection drops (eg: you close your
laptop), then the process tops and won’t restart unless you do it
manually.</li>
<li>if you depend on the network, do not forget to also acquire the
network, otherwise it will be powered off and routing won’t work.</li>
</ul>
</div></blockquote>
<div class="section" id="alternative-method-without-hashids">
<h4>4.2.5.1. Alternative method without hashids<a class="headerlink" href="#alternative-method-without-hashids" title="Permalink to this headline">¶</a></h4>
<p>First make sure you are not blocking anyone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ while tcf acquire TARGET1 TARGET2 TARGET3...; do sleep 15s; done &amp;
$ tcf_pid=$!
</pre></div>
</div>
<p>this keeps acquiring the target every 10 seconds, which tells the
server you are actively using it, so it won’t release them nor power
them off.</p>
<p>When done:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kill $tcf_pid
$ tcf release TARGET1 TARGET2 TARGET3...
</pre></div>
</div>
<p>You can <em>tcf run</em> without releasing them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t &quot; &quot; run --no-release -vvt &quot;TARGET1 or TARGET2 or TARGET3 ...&quot; test_mytc.py
</pre></div>
</div>
<p>Note the following:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">-t</span> <span class="pre">&quot;</span> <span class="pre">&quot;</span></code> tells TCF to <em>use no ticket</em>, as we have made the reservation
with no ticket</li>
<li><code class="docutils literal notranslate"><span class="pre">--no-release</span></code> tells TCF to not release the targets when done</li>
</ul>
<p>this way, once the test completes (let’s say, with failure), we can
log in via the serial console to do some debugging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write -i TARGET2
</pre></div>
</div>
<p>Do not forget to kill the <em>while</em> process and release the targets when
done, otherwise others won’t be able to use them. If someone has left
a target taken, it can be released following <a class="reference internal" href="#howto-release-target"><span class="std std-ref">these instructions</span></a></p>
</div>
</div>
<div class="section" id="how-can-i-debug-a-target">
<h3>4.2.6. How can I debug a target?<a class="headerlink" href="#how-can-i-debug-a-target" title="Permalink to this headline">¶</a></h3>
<p>TCF provides for means to connect remote debuggers to targets that
support them; if the target supports the <a class="reference internal" href="09-api.html#module-ttbl.debug" title="ttbl.debug"><code class="xref py py-mod docutils literal notranslate"><span class="pre">debug</span></code></a>
interface (which you can find with <cite>tcf list -vv TARGETNAME | grep
interfaces</cite>).</p>
<p>How it is done and what are the capabilities depends on the target,
but in general, assuming you have a target with an image deployed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf acquire TARGETNAME
$ tcf debug-start TARGETNAME
$ tcf power-on TARGETNAME
$ tcf debug-info TARGETNAME
GDB server: tcp:myhostname:3744 (when target is on; currently ON)
</pre></div>
</div>
<p>at this point, the target is waiting for the debugger to connect
before powering up, so start (in this case) GDB pointing it to the
<em>elf</em> version of the image file uploaded and issue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gdb</span><span class="o">&gt;</span> <span class="n">target</span> <span class="n">remote</span> <span class="n">tcp</span><span class="p">:</span><span class="n">myhostname</span><span class="p">:</span><span class="mi">3744</span>
</pre></div>
</div>
<p>Some targets might support starting debugging after power up.</p>
<p>Find more:</p>
<ul class="simple">
<li><cite>tcf –help | grep debug-</cite></li>
<li>the <a class="reference internal" href="09-api.html#tcfl.target_ext_debug.extension" title="tcfl.target_ext_debug.extension"><code class="xref py py-class docutils literal notranslate"><span class="pre">debug</span> <span class="pre">extension</span> <span class="pre">API</span></code></a> to
<a class="reference internal" href="09-api.html#tcfl.tc.target_c" title="tcfl.tc.target_c"><code class="xref py py-class docutils literal notranslate"><span class="pre">target</span> <span class="pre">objects</span></code></a> for use inside Python testcases</li>
<li>the <code class="xref py py-class docutils literal notranslate"><span class="pre">*ttbd*'s</span> <span class="pre">Debug</span> <span class="pre">interface</span></code></li>
</ul>
<div class="section" id="zephyr-debugging-with-tcf-run">
<h4>4.2.6.1. Zephyr debugging with TCF run<a class="headerlink" href="#zephyr-debugging-with-tcf-run" title="Permalink to this headline">¶</a></h4>
<p>When using targets in a high usage environment, it is easier to use
TCF run and a few switches:</p>
<ul>
<li><p class="first">Make sure the target is acquired for a max of 30min while you work with it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ for ((count = 0; count &lt; 240; count++)); do tcf -t 1234 acquire TARGETNAME; sleep 15s; done &amp;
</pre></div>
</div>
<p>be sure to kill this process when done, to free it for other people;
every 15s this re-acquires, as a way to tell the daemon you are
still using it, to not free it from you.</p>
<p>Note <cite>-t 1234</cite>; this says <em>use ticket 1234</em> to reserve this target;
we’ll use it later.</p>
</li>
<li><p class="first">Create a temporary directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir tmp
</pre></div>
</div>
</li>
<li><p class="first">Build and deploy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t 1234 run -vvvv -E --tmpdir tmp -t TARGETNAME --no-release PATH-TO-TC
</pre></div>
</div>
<p>note the following:</p>
<ul>
<li><p class="first"><cite>-t 1234</cite> says to use ticket 1234, as the one we used for the reservation</p>
</li>
<li><p class="first"><cite>-E</cite> tells it not to evaluate – it will just build and deploy / flash</p>
</li>
<li><p class="first"><cite>–no-release</cite> says do not release the target when done (because
you want to do other stuff, like debug)</p>
</li>
<li><p class="first">In the case of Zephyr, the ELF file will be in
<cite>tmp/1234/outdir-1234-SOMETHING/zephyr/zephyr.elf</cite>, which you can
find with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ find tmp/1234/ -iname zephyr.elf
tmp/1234/outdir-1234-j38h-quark_d2000_crb/zephyr/zephyr.elf
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Tell the target to start debugging:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t 1234 debug-start TARGETNAME
</pre></div>
</div>
</li>
<li><p class="first">Now reset / power cycle it, so it goes fresh to start. Because we
told it to start debugging, it will start but stop the CPU until you
attach a debugger (only for OpenOCD targets or targets that support
debugging, anyway):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -t 1234 reset TARGETNAME
$ tcf -t 1234 debug-info TARGETNAME
OpenOCD telnet server: srrsotc03.iind.intel.com 20944
GDB server: x86: tcp:srrsotc03.iind.intel.com:20946
Debugging available as target is ON
</pre></div>
</div>
</li>
<li><p class="first">Note we now can start the debugger; find it first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ find /opt/zephyr-sdk-0.9.5/ -iname \*gdb
...
/opt/zephyr-sdk-0.9.5/sysroots/x86_64-pokysdk-linux/usr/bin/i586-zephyr-elf/i586-zephyr-elf-gdb
...
</pre></div>
</div>
<p>run the debugger to the ELF file we found above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /opt/zephyr-sdk-0.9.5/sysroots/x86_64-pokysdk-linux/usr/bin/i586-zephyr-elf/i586-zephyr-elf-gdb \
    tmp/1234/outdir-1234-j38h-quark_d2000_crb/zephyr/zephyr.elf
...
Reading symbols from tmp/1234/outdir-1234-j38h-quark_d2000_crb/zephyr/zephyr.elf...done.
</pre></div>
</div>
<p>tell the debugger to connect to the GDB server found by running
<cite>debug-info</cite> before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(gdb) target remote tcp:srrsotc03.iind.intel.com:20946
Remote debugging using tcp:srrsotc03.iind.intel.com:20946
0x0000fff0 in ?? ()
</pre></div>
</div>
<p>Debug away!:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">b</span> <span class="n">_main</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">at</span> <span class="mh">0x180f71</span><span class="p">:</span> <span class="n">file</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">inaky</span><span class="o">/</span><span class="n">z</span><span class="o">/</span><span class="n">kernel</span><span class="o">.</span><span class="n">git</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">line</span> <span class="mf">182.</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">c</span>
<span class="n">Continuing</span><span class="o">.</span>
<span class="n">target</span> <span class="n">running</span>
<span class="n">redirect</span> <span class="n">to</span> <span class="n">PM</span><span class="p">,</span> <span class="n">tapstatus</span><span class="o">=</span><span class="mh">0x08302c1c</span>
<span class="n">hit</span> <span class="n">software</span> <span class="n">breakpoint</span> <span class="n">at</span> <span class="mh">0x00180f71</span>

<span class="n">Breakpoint</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_main</span> <span class="p">(</span><span class="n">unused1</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">unused2</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">unused3</span><span class="o">=</span><span class="n">unused3</span><span class="nd">@entry</span><span class="o">=</span><span class="mh">0x0</span><span class="p">)</span> <span class="n">at</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">inaky</span><span class="o">/</span><span class="n">z</span><span class="o">/</span><span class="n">kernel</span><span class="o">.</span><span class="n">git</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">182</span>
<span class="mi">182</span> <span class="p">{</span>
<span class="p">(</span><span class="n">gdb</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first">on a separate terminal, you can:</p>
<ul>
<li><p class="first">read the target’s console output with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-read --follow TARGETNAME
</pre></div>
</div>
</li>
<li><p class="first">issue CPU resets, halts, resumes or OpenOCD commands (for targets
that support it):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf debug-reset TARGETNAME
$ tcf debug-halt TARGETNAME
$ tcf debug-resume TARGETNAME
$ tcf debug-openocd TARGETNAME OPENOCDCOMMAND
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<p>Note that resetting or power-cycling the board will create a new GDB
target with a different port, so you will have to reconnect that GDB
wo the new target remote reported by <em>tcf debug-info</em>.</p>
</div>
</div>
<div class="section" id="how-can-i-quickly-flash-a-linux-target">
<span id="howto-pos-list-deploy"></span><h3>4.2.7. How can I quickly flash a Linux target<a class="headerlink" href="#how-can-i-quickly-flash-a-linux-target" title="Permalink to this headline">¶</a></h3>
<p>When your server and targets are configured for Provisisoning OS
support (target exports the <em>pos_capable</em> tag in <code class="docutils literal notranslate"><span class="pre">tcf</span> <span class="pre">list</span> <span class="pre">-vv</span>
<span class="pre">TARGET</span></code>), you can quickly flash the target <em>target1A</em>, which is
connected to network <em>nwA</em> with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ IMAGE=fedora::29 tcf run -vvvt &#39;nwA or target1A&#39; /usr/share/tcf/examples/test_pos_deploy.py
</pre></div>
</div>
<p>to find our which images your server has available</p>
<p id="howto-pos-list-images">To find out available images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run /usr/share/tcf/examples/test_pos_list_images.py
server10/nwa clear:live:25550::x86_64
server10/nwa clear:live:25890::x86_64
server10/nwa fedora::29::x86_64
server10/nwa yocto:core-minimal:2.5.1::x86_64
PASS0/        toplevel @local: 1 tests (1 passed, 0 error, 0 failed, 0 blocked, 0 skipped, in 0:00:06.635452) - passed
</pre></div>
</div>
<p>See how to <a class="reference internal" href="03-server-setup.html#ttbd-pos-deploying-images"><span class="std std-ref">install more images</span></a>.</p>
</div>
<div class="section" id="how-can-i-quickly-build-and-deploy-an-image-to-a-zephyr-target">
<h3>4.2.8. How can I quickly build and deploy an image to a Zephyr target?<a class="headerlink" href="#how-can-i-quickly-build-and-deploy-an-image-to-a-zephyr-target" title="Permalink to this headline">¶</a></h3>
<p>You can use the boilerplate testcase <a class="reference download internal" href="../_downloads/test_zephyr_boots.py" download=""><code class="xref download docutils literal notranslate"><span class="pre">test_zephyr_boots.py</span></code></a>, which will build any Zephyr app
and try to boot it and see if it prints the Zephyr boot banner:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ZEPHYR_APP=path/to/source tcf run -t TARGETNAME /usr/share/tcf/examples/test_zephyr_boots.py
$ tcf acquire TARGENAME
$ &lt;work on it&gt; ...
</pre></div>
</div>
<p>TCF will build your code configuring it properly for the chosen target
and deploy it. You want to inmediately acquire so it is not
powered-off by the daemon.</p>
</div>
<div class="section" id="tcf-s-run-says-something-failed-can-i-get-more-detail">
<h3>4.2.9. TCF’s <cite>run</cite> says something failed, can I get more detail?<a class="headerlink" href="#tcf-s-run-says-something-failed-can-i-get-more-detail" title="Permalink to this headline">¶</a></h3>
<p>FIXME: update</p>
<p>TCF’s <code class="docutils literal notranslate"><span class="pre">run</span></code> tries to be quiet to the console, so when you run a lot
of tests on a lot of targets, the forest lets you see the trees.</p>
<p>When you need more detail, you can:</p>
<ul>
<li><p class="first">add <cite>-v</cite>s after <code class="docutils literal notranslate"><span class="pre">run</span></code> (but then it gives you detail everywhere)</p>
</li>
<li><p class="first">log to a file with <cite>–log-file=FILENAME</cite> and when something fails,
grep for it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FAIL0</span><span class="o">/</span><span class="n">kaoe</span> <span class="o">../</span><span class="n">Makefile</span><span class="p">[</span><span class="n">quark</span><span class="p">]</span><span class="o">@.../</span><span class="n">frankie</span><span class="p">:</span> <span class="p">(</span><span class="n">dynamic</span><span class="p">)</span> <span class="n">build</span> <span class="n">failed</span>
<span class="n">PASS1</span><span class="o">/</span><span class="n">tctp</span> <span class="o">../</span><span class="n">Makefile</span><span class="p">[</span><span class="n">x86</span><span class="p">]</span><span class="o">@.../</span><span class="n">mv</span><span class="o">-</span><span class="mi">03</span><span class="p">:</span> <span class="p">(</span><span class="n">dynamic</span><span class="p">)</span> <span class="n">build</span> <span class="n">passed</span>
</pre></div>
</div>
<p>that build failed; take those four letters next to the <code class="docutils literal notranslate"><span class="pre">FAIL0</span></code>
message (<cite>kaoe</cite>) – that’s a unique identifier for each message, and
look for it with <cite>grep</cite>, printing 30 lines of context before the match:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ grep -B 100 kaoe FILENAME
....
FAIL3/iigx ../Makefile[quark]@.../frankie: @build failed [2] (&#39;make -j -C samples/hello_world/nanokernel BOARD=quark_se_sss_ctb  O=outdir-httpsSERVER5000ttb-v0targetsfrankie-quark_se_sss_ctb-quark_se_sss_ctb&#39; from /home/inaky/z/kernel.git/samples/.tcdefaults:48)
FAIL3/iigx ../Makefile[quark]@.../frankie: output: FF make: Entering directory &#39;/home/inaky/z/kernel.git/samples/hello_world/nanokernel&#39;
FAIL3/iigx ../Makefile[quark]@.../frankie: output: FF make[1]: Entering directory &#39;/home/inaky/z/kernel.git&#39;
...
</pre></div>
</div>
<p>most likely, the complete failure message will be right before the
final failure message – and you can now tell what happened. In this
case, there is no good configuration for the chosen target</p>
<p>The output driver can be changed to lay out the information
diferently; look at <a class="reference internal" href="02-guides.html#tcf-guide-report-driver"><span class="std std-ref">more information on report drivers</span></a>.</p>
</li>
</ul>
</div>
<div class="section" id="linux-targets-common-tricks">
<h3>4.2.10. Linux targets: Common tricks<a class="headerlink" href="#linux-targets-common-tricks" title="Permalink to this headline">¶</a></h3>
<div class="section" id="linux-targets-sending-ctrl-c-to-a-target">
<span id="linux-c-c"></span><h4>4.2.10.1. Linux targets: sending Ctrl-C to a target<a class="headerlink" href="#linux-targets-sending-ctrl-c-to-a-target" title="Permalink to this headline">¶</a></h4>
<p>Trick over the serial console is that it is a pure pipe, there is no
special characters. So a quick way to do it is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write TARGETNAME $(echo -e \\x03)
</pre></div>
</div>
<p>where that <em>\x03</em> is the hex code of Ctrl-C. <em>man ascii</em> can tell you
the quick shortcuts for others.</p>
</div>
<div class="section" id="linux-targets-running-a-linux-shell-command">
<span id="linux-send-command-target"></span><h4>4.2.10.2. Linux targets: running a Linux shell command<a class="headerlink" href="#linux-targets-running-a-linux-shell-command" title="Permalink to this headline">¶</a></h4>
<p>Try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write TARGETNAME &quot;ping -c 3 localhost&quot;
</pre></div>
</div>
<p>Note that once the command is sent, the console, for whatever the
target cares, is still connected, even if the <em>console-write</em> command
returned for you. The command might still be executing; see
<a class="reference internal" href="#linux-c-c"><span class="std std-ref">Sending a Ctrl-C</span></a> is not as in a usual, synchronous,
Linux console.</p>
<p>From a script, you can use <a class="reference internal" href="09-api.html#tcfl.target_ext_shell.shell.run" title="tcfl.target_ext_shell.shell.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.target_c.shell.run</span></code></a> or <a class="reference internal" href="09-api.html#tcfl.tc.target_c.send" title="tcfl.tc.target_c.send"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tc.target_c.send()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">some_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;ping localhost&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;3 packets transmitted, 3 received&quot;</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="c1"># better to use</span>
        <span class="o">...</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;ping -c 3 localhost&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;3 packets transmitted, 3 received&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>you can also get the output by adding <code class="docutils literal notranslate"><span class="pre">output</span> <span class="pre">=</span> <span class="pre">True</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;ping -c 3 localhost&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;3 packets transmitted, 3 received&quot;</span><span class="p">,</span>
                          <span class="n">output</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="linux-targets-ssh-login-from-a-testcase-client">
<span id="tunnels-linux-ssh"></span><h4>4.2.10.3. Linux targets: ssh login from a testcase / client<a class="headerlink" href="#linux-targets-ssh-login-from-a-testcase-client" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="glossary.html#term-ttbd"><span class="xref std std-term">ttbd</span></a> server can create tunnels that allow you to reach the
target’s ports, assuming the target is</p>
<ul class="simple">
<li>connected to a network to which the server is also connected</li>
<li>on and listening on a port</li>
</ul>
<p>In your test scripts, use the <a class="reference internal" href="09-api.html#tcfl.target_ext_tunnel.tunnel" title="tcfl.target_ext_tunnel.tunnel"><code class="xref py py-class docutils literal notranslate"><span class="pre">tunnel</span></code></a> extension to create a port
redirection, adding to your script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">some_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1"># ensure target and interconnect is powered up and the</span>
        <span class="c1"># script is logged in.</span>
        <span class="c1"># Indicate to the tunnel system the target&#39;s address in the</span>
        <span class="c1"># interconnect</span>
        <span class="n">target</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">addr_get</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="s2">&quot;ipv4&quot;</span><span class="p">)</span>

        <span class="c1"># create a tunnel from server_name:server_port -&gt; to target:22</span>
        <span class="n">server_name</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">rtb</span><span class="o">.</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span>
        <span class="n">server_port</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">tunnel</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>

        <span class="c1"># use SSH to get the content&#39;s of the target&#39;s /etc/passwd</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                     <span class="s2">&quot;ssh -p </span><span class="si">%d</span><span class="s2"> root@</span><span class="si">%s</span><span class="s2"> cat /etc/passwd&quot;</span>
                     <span class="o">%</span> <span class="p">(</span><span class="n">server_port</span><span class="p">,</span> <span class="n">server_name</span><span class="p">),</span>
                     <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Tunnels can also be created with the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf tunnel-add TARGETNAME 22 tcp TARGETADDR
SERVERNAME:19893
$ ssh -p 19893 root@SERVERNAME cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
...
</pre></div>
</div>
<p>Note you might need first the steps in the next section to allow SSH
to login with a passwordless root.</p>
</div>
<div class="section" id="linux-targets-restarting-the-ssh-daemon">
<h4>4.2.10.4. Linux targets: restarting the SSH daemon<a class="headerlink" href="#linux-targets-restarting-the-ssh-daemon" title="Permalink to this headline">¶</a></h4>
<p>See the examples in <a class="reference internal" href="09-api.html#tcfl.tl.linux_ssh_root_nopwd" title="tcfl.tl.linux_ssh_root_nopwd"><code class="xref py py-func docutils literal notranslate"><span class="pre">tcfl.tl.linux_ssh_root_nopwd()</span></code></a>.</p>
</div>
<div class="section" id="how-do-i-boot-a-target-to-pxe-boot-mode-manually">
<span id="target-pos-manually"></span><h4>4.2.10.5. How do I boot a target to PXE boot mode manually?<a class="headerlink" href="#how-do-i-boot-a-target-to-pxe-boot-mode-manually" title="Permalink to this headline">¶</a></h4>
<p>A target can be told to boot to PXE Provisioning OS by issuing the
following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ while tcf acquire NETWORKNAME TARGETNAME; do sleep 10s; done &amp;
$ tcf power-on NETWORKNAME
$ tcf property-set TARGETNAME pos_mode pxe
$ tcf power-cycle TARGETNAME
</pre></div>
</div>
<p>The <em>while</em> loop in the background keeps the target acquired, do not
forget to release them by killing it. Then we ensure the network is on
and finally, we set the target to <em>POS mode</em> PXE and we power cycle
the target.</p>
<p>To have it boot back in local mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf property-set TARGETNAME pos_mode
$ tcf power-cycle TARGETNAME
</pre></div>
</div>
</div>
<div class="section" id="pos-booting-from-http-or-tftp">
<span id="pos-boot-http-tftp"></span><h4>4.2.10.6. POS: booting from HTTP or TFTP<a class="headerlink" href="#pos-booting-from-http-or-tftp" title="Permalink to this headline">¶</a></h4>
<p>When a target is given a syslinux configuration file to boot from, the
places where it loads the Provisioning OS kernels can be forced with
<a class="reference internal" href="09-api.html#pos-http-url-prefix"><span class="std std-ref">pos_http_url_prefix</span></a>.</p>
<p>By default (no prefix) the boot loader will tend to load with
TFTP. But by specifying an HTTP or FTP URL prefix, it can boot over
any of those protocols (which can be faster).</p>
<p>When specified in an interconnect’s tags, it will be taken as default
for that interconnect, but this can be overriden specifying it for
each target; for the example in <a class="reference internal" href="03-server-setup.html#ttbd-pos-network-config"><span class="std std-ref">POS: Configuring networks</span></a>, we can add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pos_http_url_prefix</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.97.1/ttbd-pos/</span><span class="si">%(bsp)s</span><span class="s2">/&quot;</span>
</pre></div>
</div>
<p>This will replace in the syslinux configuration file any occurrence of
<code class="docutils literal notranslate"><span class="pre">pos_http_url_prefix</span></code> with
<code class="docutils literal notranslate"><span class="pre">http://192.168.97.1/ttbd-pos/ARCHNAME/</span></code>, where <code class="docutils literal notranslate"><span class="pre">ARCHNAME</span></code> is the
architecture of the target.</p>
</div>
<div class="section" id="linux-targets-pos-setting-default-linux-kernel-options">
<span id="linux-target-pos-kernel-options"></span><h4>4.2.10.7. Linux targets: POS: setting default linux kernel options<a class="headerlink" href="#linux-targets-pos-setting-default-linux-kernel-options" title="Permalink to this headline">¶</a></h4>
<p>When a Linux target is botted using <a class="reference internal" href="glossary.html#term-pos"><span class="xref std std-term">POS</span></a>, default kernel
options can be fed to the POS scripts for bootloader consumption by
setting the following tags or properties (all optional):</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">linux_serial_console_default</span></code>: sets which is the default serial
console. For <em>/dev/NAME</em>, specify <em>NAME</em>, as this will be given as
the Linux kernel command line option <em>console=NAME,115200</em></li>
<li><code class="docutils literal notranslate"><span class="pre">linux_options_append</span></code>: a space separated string with any other
Linux kernel command line options to add.</li>
</ul>
<p>For example, when adding the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">target_add</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;linux_serial_console_default&#39;</span><span class="p">:</span> <span class="s1">&#39;ttyS2&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;linux_options_append&#39;</span><span class="p">:</span> <span class="s1">&#39;rw foo=bar&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">})</span>
</pre></div>
</div>
<p>which can also be done once the target is added with
<a class="reference internal" href="09-api.html#ttbl.test_target.tags_update" title="ttbl.test_target.tags_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">tags_update</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;TARGETNAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tags_update</span><span class="p">({</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;linux_serial_console_default&#39;</span><span class="p">:</span> <span class="s1">&#39;ttyS2&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="s1">&#39;linux_options_append&#39;</span><span class="p">:</span> <span class="s1">&#39;rw foo=bar&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="linux-targets-using-proxies">
<span id="tcf-testcase-proxy"></span><h4>4.2.10.8. Linux targets: using proxies<a class="headerlink" href="#linux-targets-using-proxies" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="glossary.html#term-nut"><span class="xref std std-term">NUT</span></a>s to which targets are connected are usually setup very
isolated from upstream or other networks; there is a common practice
to declare a proxy availability in an interconnect by it exporting any
of the following variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf list -vv nwb | grep -i proxy
ftp_proxy: http://192.168.98.1:911
http_proxy: http://192.168.98.1:911
https_proxy: http://192.168.98.1:911
</pre></div>
</div>
<p>so in a test script running a Linux target, one could do:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="s1">&#39;http_proxy&#39;</span> <span class="ow">in</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;export http_proxy=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">))</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;export HTTP_PROXY=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;https_proxy&#39;</span> <span class="ow">in</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;export https_proxy=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">))</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;export HTTPS_PROXY=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">))</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>note however, that those settings will apply only to the shell being
run in that console. You can make more permanent settings in the
target by for example, modifying <code class="docutils literal notranslate"><span class="pre">/etc/bashrc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="s1">&#39;http_proxy&#39;</span> <span class="ow">in</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo http_proxy=</span><span class="si">%s</span><span class="s2"> &gt;&gt; /etc/bashrc&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">))</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo HTTP_PROXY=</span><span class="si">%s</span><span class="s2"> &gt;&gt; /etc/bashrc&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;https_proxy&#39;</span> <span class="ow">in</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo https_proxy=</span><span class="si">%s</span><span class="s2"> &gt;&gt; /etc/bashrc&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">))</span>
           <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;echo HTTPS_PROXY=</span><span class="si">%s</span><span class="s2"> &gt;&gt; /etc/bashrc&quot;</span> <span class="o">%</span> <span class="n">ic</span><span class="o">.</span><span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">))</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>and those will also apply if your script logs in via SSH or other methods.</p>
</div>
<div class="section" id="linux-targets-removing-the-root-password">
<h4>4.2.10.9. Linux targets: removing the root password<a class="headerlink" href="#linux-targets-removing-the-root-password" title="Permalink to this headline">¶</a></h4>
<p>If your target is not connected to any networks or to an isolated
network, you can remove the root password.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">some_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="c1"># ensure target is powered up and the script is logged in</span>
    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;passwd -d root&quot;</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>or from the console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write TARGETNAME &quot;passwd -d root&quot;
$ tcf console-read TARGETNAME
...
# passwd -d root
Removing password for user root.
passwd: Success
</pre></div>
</div>
</div>
<div class="section" id="linux-targets-allowing-ssh-as-root-with-no-passwords">
<span id="linux-ssh-no-root-password"></span><h4>4.2.10.10. Linux targets: allowing SSH as root with no passwords<a class="headerlink" href="#linux-targets-allowing-ssh-as-root-with-no-passwords" title="Permalink to this headline">¶</a></h4>
<p>Most Linux deployments default configure SSH to be very conservative;
for testing, you might want to open it up.</p>
<p>To allow login in with SSH, add to your test script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">some_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="c1"># ensure target is powered up and the script is logged in</span>
    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">cat &lt;&lt;EOF &gt;&gt; /etc/ssh/sshd_config</span>
<span class="s2">PermitRootLogin yes</span>
<span class="s2">PermitEmptyPasswords yes</span>
<span class="s2">EOF&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;systemctl restart sshd&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>or using the <a class="reference internal" href="09-api.html#tcfl.tl.linux_ssh_root_nopwd" title="tcfl.tl.linux_ssh_root_nopwd"><code class="xref py py-func docutils literal notranslate"><span class="pre">library</span> <span class="pre">function</span> <span class="pre">tcfl.tl.linux_ssh_root_nopwd</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="o">...</span>
<span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s2">&quot;linux&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">some_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="c1"># ensure target is powered up and the script is logged in</span>
    <span class="k">def</span> <span class="nf">eval_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">linux_ssh_root_nopwd</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="n">target</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;systemctl restart sshd&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>or even having that done in deployment time when flashing with POS:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@tcfl.tc.interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl.tc.target</span><span class="p">(</span><span class="s1">&#39;pos_capable&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="c1"># ensure network, DHCP, TFTP, etc are up and deploy</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">on</span><span class="p">()</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;powered on&quot;</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_image</span><span class="p">(</span>
            <span class="n">ic</span><span class="p">,</span> <span class="s2">&quot;clear&quot;</span><span class="p">,</span>
            <span class="n">extra_deploy_fns</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">deploy_linux_ssh_root_nopwd</span> <span class="p">])</span>
</pre></div>
</div>
<p>or from the shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write TARGETNAME &quot;echo PermitRootLogin yes &gt;&gt; /etc/ssh/sshd_config&quot;
$ tcf console-write TARGETNAME &quot;echo PermitEmptyPasswords yes &gt;&gt; /etc/ssh/sshd_config&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-do-i-change-the-default-timeout-in-my-test-scripts">
<span id="tcf-client-timetout"></span><h3>4.2.11. How do I change the default timeout in my test scripts<a class="headerlink" href="#how-do-i-change-the-default-timeout-in-my-test-scripts" title="Permalink to this headline">¶</a></h3>
<p>The default timeout different parts of the <em>tcf run</em> engines wait for
the target to respond can be changed by setting the variable
<em>self.tls.expecter.timeout</em> (note <em>self</em> is a testcase class):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">some_tc</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">eval_some</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># wait a max of 40 seconds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">expecter</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>It is a bit awkward and we’ll make a better way to do it. Other places
that take a <em>timeout</em> parameter that has to be less than
<em>self.tls.expecter.timeout</em>:</p>
<ul class="simple">
<li><a class="reference internal" href="09-api.html#tcfl.target_ext_shell.shell.up" title="tcfl.target_ext_shell.shell.up"><code class="xref py py-func docutils literal notranslate"><span class="pre">target.shell.up</span></code></a></li>
<li><a class="reference internal" href="09-api.html#tcfl.tc.target_c.on_console_rx" title="tcfl.tc.target_c.on_console_rx"><code class="xref py py-func docutils literal notranslate"><span class="pre">target.on_console_rx</span></code></a>
and <code class="xref py py-func docutils literal notranslate"><span class="pre">target.on_console_rx_cm</span></code></li>
<li><a class="reference internal" href="09-api.html#tcfl.tc.target_c.wait" title="tcfl.tc.target_c.wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">target.wait</span></code></a></li>
<li><a class="reference internal" href="09-api.html#tcfl.tc.target_c.expect" title="tcfl.tc.target_c.expect"><code class="xref py py-func docutils literal notranslate"><span class="pre">target.expect</span></code></a></li>
</ul>
</div>
<div class="section" id="making-the-client-always-generate-report-files">
<span id="report-always"></span><h3>4.2.12. Making the client always generate report files<a class="headerlink" href="#making-the-client-always-generate-report-files" title="Permalink to this headline">¶</a></h3>
<p><em>tcf run</em> will normally generate a report file if a testcase does not
<em>pass</em>. If you want report files generated always, you can add to any
<a class="reference internal" href="#tcf-client-configuration"><span class="std std-ref">configuration file</span></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tcfl</span><span class="o">.</span><span class="n">report_jinja2</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">][</span><span class="s1">&#39;report_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Reporting is handled by the <a class="reference internal" href="09-api.html#tcfl.tc.reporter_c" title="tcfl.tc.reporter_c"><code class="xref py py-mod docutils literal notranslate"><span class="pre">reporting</span> <span class="pre">API</span></code></a>
and the <em>report</em> files are created by the Jinja2 <a class="reference internal" href="02-guides.html#module-tcfl.report_jinja2" title="tcfl.report_jinja2"><code class="xref py py-mod docutils literal notranslate"><span class="pre">reporter</span></code></a> based on a template called <em>text</em>.</p>
</div>
<div class="section" id="splitting-report-files-by-domain">
<span id="report-domain-breakup"></span><h3>4.2.13. Splitting report files by domain<a class="headerlink" href="#splitting-report-files-by-domain" title="Permalink to this headline">¶</a></h3>
<p>You could want to break your testcases by a domain, mapping to any
categories and you can want the report files to be stored in specific
subdirectories.</p>
<p>You can define a hook that calculates that domain and generates
metadata for it, so the templating engine can use it</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="o">.</span><span class="n">hook_pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_my_hook_fn</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filename</span> <span class="o">=</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">report_jinja2</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="s2">&quot;output_file_name&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tcfl</span><span class="o">.</span><span class="n">report_jinja2</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">][</span><span class="s2">&quot;output_file_name&quot;</span><span class="p">]</span> <span class="o">=</span> \
<span class="gp">&gt;&gt;&gt; </span>    <span class="s2">&quot;</span><span class="si">%(category)s</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">file_name</span>
</pre></div>
</div>
<p>The <cite>_my_hook_fn()</cite> would look as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">_my_hook_fn</span><span class="p">(</span><span class="n">testcase</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1"># define some calculations that generates category</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">testcase</span><span class="o">.</span><span class="n">tag_set</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">categoryvalue</span><span class="p">)</span>
</pre></div>
</div>
<p>If the data needed is not available until after the testcase executes,
you can use <a class="reference internal" href="02-guides.html#tcfl.report_jinja2.driver.hooks" title="tcfl.report_jinja2.driver.hooks"><code class="xref py py-class docutils literal notranslate"><span class="pre">reporting</span> <span class="pre">hooks</span></code></a>.</p>
</div>
<div class="section" id="capturing-network-traffic">
<h3>4.2.14. Capturing network traffic<a class="headerlink" href="#capturing-network-traffic" title="Permalink to this headline">¶</a></h3>
<p>TCF servers (<em>ttbd</em>) can capture the traffic in a :term:NUT network if
they are connected to it.</p>
<p>For this to happen, when the network is powered up, it must contain a
property called <em>tcpdump</em> set to a file name where to capture it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf property-set nwb tcpdump somename.cap
$ tcf power-cycle nwb
</pre></div>
</div>
<p>when all the network traffic is done, it can be downloaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf power-off nwb
$ tcf store-dnload nwb somename.cap local_somename.cap
</pre></div>
</div>
<p>which now can be opened with wireshark to see what happened (or
analyzed with other tools).</p>
<p>In a script, ensure your start routine contains:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">sometest</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">start_something</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="c1"># before powering up the interconnect</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">property_set</span><span class="p">(</span><span class="s1">&#39;tcpdump&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;tc_hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.cap&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
</pre></div>
</div>
<p>and on teardown:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">teardown_whatever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">dnload</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>             <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;tc_hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.cap&quot;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>             <span class="s2">&quot;report-</span><span class="si">%(runid)s</span><span class="s2">:</span><span class="si">%(tc_hash)s</span><span class="s2">.tcpdump&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;tcpdump available in file &quot;</span>
<span class="gp">&gt;&gt;&gt; </span>                         <span class="s2">&quot;report-</span><span class="si">%(runid)s</span><span class="s2">:</span><span class="si">%(tc_hash)s</span><span class="s2">.tcpdump&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
</pre></div>
</div>
<p>the file will be made available in the same directory where <em>tcf run</em>
was executed from.</p>
</div>
<div class="section" id="continuous-integration">
<span id="tcf-ci"></span><h3>4.2.15. Continuous Integration<a class="headerlink" href="#continuous-integration" title="Permalink to this headline">¶</a></h3>
<p><em>TCF run</em> can be used in a CI system to run testcases as part of the
continuous integration process. A few helpful tricks:</p>
<div class="section" id="generate-a-unique-id-for-each-run-and-feed-it-to-tcf">
<h4>4.2.15.1. Generate a unique ID for each run and feed it to TCF<a class="headerlink" href="#generate-a-unique-id-for-each-run-and-feed-it-to-tcf" title="Permalink to this headline">¶</a></h4>
<p>It is common practice to generate a unique ID for each build or
continuous integration run. It should include:</p>
<ul class="simple">
<li>timestamp (YYMMDD-HHMM): allows to tell when the build happened and
to map to logs in other parts of the system; might not be sufficient
if more than one build can be started in the same hour/minute/second</li>
<li>monotonic counter (BBB): CI engines like Jenkins will refer to
builds by their internal build monotonic counter–it also helps
distinguish in the unlikely case two builds were started on the same
second (or minute)</li>
<li>branch/project identifier (PROJECT-BRANCH): if a single build might
be running on multiple branches or projects, it helps to add a short
version of it – thus, when the Unique ID is propagated to other
parts of the CI system, we can see who is causing whatever action.</li>
</ul>
<p><em>tcf run</em> supports the concept of a <a class="reference internal" href="02-guides.html#tcf-run-runid"><span class="std std-ref">RunID</span></a>,
which will be then used in all the reports.</p>
<p>A good RunID specification for <em>TCF run</em> would be something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROJECT</span><span class="o">-</span><span class="n">BRANCH</span><span class="o">-</span><span class="n">YYMMDD</span><span class="o">-</span><span class="n">HHMM</span><span class="o">-</span><span class="n">BBB</span>
</pre></div>
</div>
<p>it is a good idea to also give it to the hashing engine as salt so
that the <a class="reference internal" href="glossary.html#term-hash"><span class="xref std std-term">hash</span></a> identifiers used to acquire targets don’t
conflict with other projects that might be using the same
testcase. e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run --hash-salt PROJECT-BRANCH-YYMMDD-HHMM-BBB \
    --runid PROJECT-BRANCH-YYMMDD-HHMM-BBB -v path/to/testcases
</pre></div>
</div>
<p>add to the hash salt any other factors that might contribute to the
same testcase/target combination being run as the same but that shall
be considered different (eg: using a different toolchain).</p>
</div>
<div class="section" id="splitting-in-multiple-shards">
<h4>4.2.15.2. Splitting in multiple shards<a class="headerlink" href="#splitting-in-multiple-shards" title="Permalink to this headline">¶</a></h4>
<p>When running CI in multiple slaves in parallel, the CI engine can tell
<em>tcf run</em> to only run an specific shard of the whole list of
testcases. Assuming all the slaves have the same list of testcases,
the list will be evenly split:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>slave1$ tcf run --shard 1-3 --runid X path/to/testcases
slave2$ tcf run --shard 2-3 --runid X path/to/testcases
slave3$ tcf run --shard 3-3 --runid X path/to/testcases
</pre></div>
</div>
<p>will split the deck of testcases in 3 shards and run one on each slave
in parallel.</p>
<p>Note that if the availability of targets to run the shards doesn’t
allow them to run testcases in parallel, you might not gain much by
the paralallelization of <em>tcf run</em>.</p>
</div>
<div class="section" id="controlling-output-location">
<h4>4.2.15.3. Controlling output location<a class="headerlink" href="#controlling-output-location" title="Permalink to this headline">¶</a></h4>
<p><em>tcf run</em> can be given <code class="docutils literal notranslate"><span class="pre">--log-dir</span></code> to specify the location where
most default output files will be placed, including:</p>
<ul class="simple">
<li>failure/error/block/skip reports</li>
<li>tcpdump outputs</li>
</ul>
<p>this defaults to the directory where <em>tcf run</em> was invoked from.</p>
</div>
</div>
</div>
<div class="section" id="general-catchas">
<span id="id1"></span><h2>4.3. General catchas<a class="headerlink" href="#general-catchas" title="Permalink to this headline">¶</a></h2>
<p>Some common issues that make it automating hard</p>
<div class="section" id="hidden-characters-in-console-output-ansi-menus">
<h3>4.3.1. Hidden characters in console output, ANSI menus<a class="headerlink" href="#hidden-characters-in-console-output-ansi-menus" title="Permalink to this headline">¶</a></h3>
<p>This happens very commonly when console prompts or text produce ANSI
escape sequences to colorize output; as a human on the console, we see
clearly the <em>root&#64;hostname:DIR</em> prompt, but our regex for the console
is expecting:</p>
<p><code class="docutils literal notranslate"><span class="pre">root&#64;SOMETHING:DIR</span></code></p>
<p>however, the chain of bytes that the serial port is reading might be</p>
<p><code class="docutils literal notranslate"><span class="pre">ESC[</span> <span class="pre">38;5;2rootESC[</span> <span class="pre">38;5;2SOMETHING:DIR</span></code></p>
<p>(where ESC is the escape character, ASCII 0x1b dev 27) and hence why
the regular expression is not working.</p>
<p>Parsing ANSI escape sequences is quite tricky and if this is a command
prompt, a more simple sollution is to remove them from the prompt
configuration.</p>
<p>An option to see them is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcf</span> <span class="n">console</span><span class="o">-</span><span class="n">read</span> <span class="o">--</span><span class="n">follow</span> <span class="n">TARGET</span> <span class="o">|</span> <span class="n">cat</span> <span class="o">-</span><span class="n">A</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">-A</span></code> in cat will escape the ANSI characters for you.</p>
<p>When trying to automate an application that implements an ANSI TUI
(Text User Interface) with menus and such, it becomes quite
complicated. For example, BIOS over serials.</p>
<p>The application might be sending strings such as:</p>
<blockquote>
<div><ul class="simple">
<li><em>^[[X;YHSTRING</em> put <em>STRING</em> in X,Y</li>
<li><em>^[[0m</em> normal letters</li>
<li><em>^[[1m</em> bold letters</li>
<li><em>^[[37m</em> white FG</li>
<li><em>^[[40m</em> black BG</li>
</ul>
</div></blockquote>
<p>sometimes text is intersped in ANSI escape sequences (especially with
very awkward software) that print <strong>STRING</strong> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mS</span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mT</span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mR</span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mI</span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mN</span><span class="o">^</span><span class="p">[[</span><span class="mi">1</span><span class="n">mSG</span>
</pre></div>
</div>
<p>to match this against a regular expression, you need to do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x1b</span><span class="s2">\[1mS</span><span class="se">\x1b</span><span class="s2">\[1mT</span><span class="se">\x1b</span><span class="s2">\[1mR</span><span class="se">\x1b</span><span class="s2">\[1mI</span><span class="se">\x1b</span><span class="s2">\[1mN</span><span class="se">\x1b</span><span class="s2">\[1mSG&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>for example</p>
<p>Another problem is the sequence of characters you will see on the
screen menu but how they come out in the serial port might be
different; it usually helps to open two terminals, side by side and in
one open the TUI via the TCF console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-write -i TARGET
</pre></div>
</div>
<p>and on another, just the byte stream:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf console-read --follow TARGET | cat -A
</pre></div>
</div>
<p>interacting with it on the first console will give you an idea of what
is actually printed that can be used to latch on.</p>
</div>
<div class="section" id="newlines-when-reading-output-of-a-command">
<h3>4.3.2. Newlines when reading output of a command<a class="headerlink" href="#newlines-when-reading-output-of-a-command" title="Permalink to this headline">¶</a></h3>
<p>Let’s say we are reading the top level tree of a git directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tree</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>     <span class="p">[</span>
<span class="gp">&gt;&gt;&gt; </span>         <span class="s1">&#39;git&#39;</span><span class="p">,</span> <span class="s1">&#39;rev-parse&#39;</span><span class="p">,</span> <span class="s1">&#39;--flags&#39;</span><span class="p">,</span> <span class="s1">&#39;--show-toplevel&#39;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>         <span class="s1">&#39;SOMEFILENAME&#39;</span>
<span class="gp">&gt;&gt;&gt; </span>     <span class="p">],</span>
<span class="gp">&gt;&gt;&gt; </span>     <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>     <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="s1">&#39;SOMEFILENAME&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">)</span>
</pre></div>
</div>
<p>then we try to use <em>tree</em> and it does not exist. Why? because:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git rev-parse --flags --show-toplevel SOMEFILENAME
SOMEPATH
$
</pre></div>
</div>
<p>which means that after <em>SOMEPATH</em> there is a newline and thus the
output we are getting is <em>SOMEPATH\n</em>. So <a class="reference external" href="https://docs.python.org/2.7/library/string.html#string.strip" title="(in Python v2.7)"><code class="xref py py-func docutils literal notranslate"><span class="pre">strip</span></code></a> it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="general-linux-system">
<h2>4.4. General Linux system<a class="headerlink" href="#general-linux-system" title="Permalink to this headline">¶</a></h2>
<div class="section" id="setup-proxies">
<span id="id2"></span><h3>4.4.1. Setup proxies<a class="headerlink" href="#setup-proxies" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this applies to setting the proxy for the server; if you
need to set proxies during testcase execution, see
<a class="reference internal" href="#tcf-testcase-proxy"><span class="std std-ref">here</span></a></p>
</div>
<p>If your network requires proxy support:</p>
<ul>
<li><p class="first">From the GUI: log in as a normal user to the graphical interface</p>
<ol class="arabic">
<li><p class="first">On the top right click the configuration arrow, select * →
configuration icon → select network → select proxies*</p>
</li>
<li><p class="first">Set:</p>
<ul class="simple">
<li>Method <em>Manual</em></li>
</ul>
<ul class="simple">
<li>Ignore Hosts: 127.0.0.1, localhost, 192.168.0.0/16</li>
</ul>
</li>
</ol>
</li>
<li><p class="first">From the terminal, (when remotedly logged in, optional) add to
<code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> or to <code class="docutils literal notranslate"><span class="pre">/etc/bashrc</span></code> (for system wide, headless
machines):</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">NO_PROXY</span><span class="o">=</span><span class="si">${</span><span class="nv">NO_PROXY</span><span class="k">:-</span><span class="s1">&#39;localhost,192.168.0.0/16,127.0.0.0/8,::1&#39;</span><span class="si">}</span>
<span class="nb">export</span> <span class="nv">no_proxy</span><span class="o">=</span><span class="nv">$NO_PROXY</span>
</pre></div>
</div>
</div></blockquote>
<p>(note the <code class="docutils literal notranslate"><span class="pre">${VAR:-DEFAULT}</span></code> syntax is so to avoid these settings
to interfere with those that might be set when you login via the GUI).</p>
</li>
</ul>
<p>Configure <em>sudo</em> to pass proxy configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat &lt;&lt;EOF &gt; /etc/sudoers.d/proxy</span>
<span class="c1"># Keep proxy configuration through sudo, so we don&#39;t need to specify -E</span>
<span class="c1"># to carry it</span>
<span class="n">Defaults</span> <span class="n">env_keep</span> <span class="o">+=</span> <span class="s2">&quot;ALL_PROXY FTP_PROXY HTTP_PROXY HTTPS_PROXY NO_PROXY&quot;</span>
<span class="n">Defaults</span> <span class="n">env_keep</span> <span class="o">+=</span> <span class="s2">&quot;all_proxy ftp_proxy http_proxy https_proxy no_proxy&quot;</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>This ensures the proxy configuration is kept by <em>sudo</em> (versus having
to run <em>sudo -E</em>) so tools that use the network don’t get stuck with
network access.</p>
<p>Why?</p>
<ul class="simple">
<li><em>127.0.0.1/8</em> and <em>192.168.0.0/16</em> will be all networks we’ll use
internally from our server, so they don’t need to be proxyed.</li>
</ul>
</div>
<div class="section" id="how-do-i-update-my-tcf-installation">
<span id="tcf-update"></span><h3>4.4.2. How do I update my TCF installation?<a class="headerlink" href="#how-do-i-update-my-tcf-installation" title="Permalink to this headline">¶</a></h3>
<p>You can check if there is a new version available with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf check-update --refresh | grep TCF</span>
</pre></div>
</div>
<p>if so, you can update to it with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf update --best ttbd ttbd-zephyr tcf tcf-zephyr</span>
<span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
<p>Note that if there is a major version change (from <em>v0</em> to <em>v1</em>, or
<em>v1</em> to <em>v2</em>, etc), more steps have to be done, which will be like
(example is from <em>v0</em> to <em>v1</em>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># rpm -e tcf-repo-v0</span>
<span class="c1"># rpm -i https://RPMREPOHOST/repo/tcf-repo-v0.11-1-1.noarch.rpm</span>
<span class="c1"># dnf update --best</span>
</pre></div>
</div>
<p>This is so because we release the TCF stable branches as separate RPM
repositories, for simplicity.</p>
<p>Note you might need to clean the metadata caches with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf clean all</span>
</pre></div>
</div>
<p>to force an update of the metadata to be pulled from the servers.</p>
</div>
<div class="section" id="configuring-a-usb-or-other-network-adapter-for-an-infrastructure-network">
<span id="internal-network"></span><h3>4.4.3. Configuring a USB or other network adapter for an infrastructure network<a class="headerlink" href="#configuring-a-usb-or-other-network-adapter-for-an-infrastructure-network" title="Permalink to this headline">¶</a></h3>
<p>Test targets or infrastructure (like power control switches) that
require IP connectivity can be connected to your server via a
dedicated network interface and switch.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">do not connect infrastructure and test devices to the
same network! You have to <a class="reference internal" href="05-RFAQs.html#separated-networks"><span class="std std-ref">keep them separated</span></a>.</p>
</div>
<p>You will need:</p>
<ul class="simple">
<li>a network interface (USB, PCI, etc)</li>
<li>its MAC address</li>
<li>an IP address range (recommended <em>192.168.X.0/24</em>)</li>
</ul>
<ol class="arabic">
<li><p class="first">Identify the network interface you will use, using tools such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ifconfig -a</span>
<span class="c1"># ip addr</span>
</pre></div>
</div>
</li>
<li><p class="first">Now configure it as described in <a class="reference internal" href="#howto-nm-config-static"><span class="std std-ref">Configuring a static interface
Via NetworkManager’s nmcli</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nmcli con add type ethernet con-name TCF-infrastructure ifname IFNAME ip4 192.168.0.20X/24</span>
<span class="c1"># nmcli con up TCF-infrastructure</span>
</pre></div>
</div>
<p>note that you can also use VLANs if you add with <strong>type vlan id NN
dev IFNAME</strong> for VLAN number <code class="docutils literal notranslate"><span class="pre">NN</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nmcli con add type vlan con-name TCF-Infrastructure dev enp0s20u4 id 4 ip4 192.168.4.209/24</span>
</pre></div>
</div>
</li>
</ol>
<p>Conventions for assignment of addresses in the infastructure network:</p>
<ul class="simple">
<li>use IPv4 (easier)</li>
<li>use a local network (eg: 192.168.x.0/24)</li>
<li>servers get IP addresses &gt; 192.168.x.200 (try to establish a server
naming conventions where numbers are assigned, <em>server1</em>, <em>server2</em>,
etc) and thus their IP addresses are <em>.201</em>, <em>.202</em>, etc…</li>
<li>PDUs and other equipment use IP addresses &gt; 192.168.x.100</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Keep this switch isolated from upstream routers; connect
only test-targets OR infrastructure elements to it.</p>
</div>
</div>
<div class="section" id="configuring-network-interfaces-with-networkmanager-and-nmcli">
<h3>4.4.4. Configuring network interfaces with NetworkManager and nmcli<a class="headerlink" href="#configuring-network-interfaces-with-networkmanager-and-nmcli" title="Permalink to this headline">¶</a></h3>
<p>NetworkManager will by default take control of most network interfaces
in the system; some adjustments might be needed.</p>
<div class="section" id="disabling-networkmanager-from-controlling-an-interface">
<span id="howto-nm-disable-control"></span><h4>4.4.4.1. Disabling NetworkManager from controlling an interface<a class="headerlink" href="#disabling-networkmanager-from-controlling-an-interface" title="Permalink to this headline">¶</a></h4>
<p>Network interfaces which connect the server to a NUT (network under
test) need to be left alone by NetworkManager. NetworkManager can be
told to ignore a network device in two ways:</p>
<ul>
<li><p class="first">run the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nmcli dev set IFNAME managed no</span>
</pre></div>
</div>
</li>
<li><p class="first">or create a configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo tee /etc/NetworkManager/conf.d/disabled.conf &lt;&lt;EOF
[keyfile]
unmanaged-devices=mac:00:10:60:31:a4:ba
EOF
</pre></div>
</div>
<p>Or edit said file and add <em>mac:MACADDR</em> statements separated by
semicolons to the <em>unmanaged-devices</em> line.</p>
</li>
</ul>
</div>
<div class="section" id="configuring-a-static-interface-via-networkmanager-s-nmcli">
<span id="howto-nm-config-static"></span><h4>4.4.4.2. Configuring a static interface Via NetworkManager’s nmcli<a class="headerlink" href="#configuring-a-static-interface-via-networkmanager-s-nmcli" title="Permalink to this headline">¶</a></h4>
<p>To configure an internal network interface <em>IFNAME</em> for internal
network for infrastructure control <em>192.168.2.0/24</em> with IP <em>.205</em> ,
run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nmcli con add type ethernet con-name NETWORKNAME ifname IFNAME ip4 192.168.2.205/24</span>
<span class="c1"># nmcli con up NETWORKNAME</span>
</pre></div>
</div>
<p>note that you can also use VLANs if you add with <strong>id NN</strong> for VLAN
number <code class="docutils literal notranslate"><span class="pre">NN</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nmcli con add type vlan con-name NETWORKNAME dev IFNAME id NN ip4 192.168.2.205/24</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="generating-an-ssl-certificate">
<span id="generate-ssl-certificate"></span><h3>4.4.5. Generating an SSL certificate<a class="headerlink" href="#generating-an-ssl-certificate" title="Permalink to this headline">¶</a></h3>
<p>To use secure layers HTTPS connections between daemon and client, you
must have a valid certificate and key, or use an autosigned
certificate. This can be fed to the target server with the options
<code class="docutils literal notranslate"><span class="pre">--ssl-crt</span></code> and <code class="docutils literal notranslate"><span class="pre">--ssl-key</span></code>.</p>
<p>If  you want to create your own certificate you must have installed
OpenSSL:</p>
<ol class="arabic">
<li><p class="first">Generate a private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl genrsa -des3 -out server.key 1024
</pre></div>
</div>
</li>
<li><p class="first">Generate a CSR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl req -new -key server.key -out server.csr
</pre></div>
</div>
</li>
<li><p class="first">Remove Passphrase from key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp server.key server.key.org
$ openssl rsa -in server.key.org -out server.key
</pre></div>
</div>
</li>
<li><p class="first">Generate self signed certificate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>Instructions taken from:
<a class="reference external" href="http://kracekumar.com/post/54437887454/ssl-for-flask-local-development">http://kracekumar.com/post/54437887454/ssl-for-flask-local-development</a></div></blockquote>
</div>
<div class="section" id="configuring-and-reloading-udev">
<span id="configure-udev"></span><h3>4.4.6. Configuring and reloading UDEV<a class="headerlink" href="#configuring-and-reloading-udev" title="Permalink to this headline">¶</a></h3>
<p><em>udev</em> is the Linux low-level service that acts when devices are
added/removed from/to the system to set them up. TCF relies on it to
create device alias named after the targets to make administration
easier.</p>
<ul>
<li><p class="first"><em>udev</em> rule configuration files are stored in <em>/etc/udev/rules.d/</em>
and are called <em>NN-FILENAME.rules</em>, where <em>NN</em> is a number to sort
inclusion. Most commonly you can use <em>90-ttbd.rules</em></p>
</li>
<li><p class="first">When the rule file is changed, it can be reloaded with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm control --reload-rules</span>
</pre></div>
</div>
</li>
<li><p class="first">Information about a given device can be obtained with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ udevadm info /dev/snd/controlC0
P: /devices/pci0000:00/0000:00:1f.3/sound/card0/controlC0
N: snd/controlC0
S: snd/by-path/pci-0000:00:1f.3
E: DEVLINKS=/dev/snd/by-path/pci-0000:00:1f.3
E: DEVNAME=/dev/snd/controlC0
E: DEVPATH=/devices/pci0000:00/0000:00:1f.3/sound/card0/controlC0
E: ID_PATH=pci-0000:00:1f.3
E: ID_PATH_TAG=pci-0000_00_1f_3
E: MAJOR=116
E: MINOR=11
E: SUBSYSTEM=sound
E: TAGS=:uaccess:
E: USEC_INITIALIZED=30391111
</pre></div>
</div>
<p>those <em>KEYS=</em> we can use to match in the <em>udev</em> rule files to do
actions.</p>
</li>
<li><p class="first">Verbosity can be controlled with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm control -l LEVEL    (see --help)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="finding-usb-device-information">
<span id="find-usb-info"></span><h3>4.4.7. Finding USB device information<a class="headerlink" href="#finding-usb-device-information" title="Permalink to this headline">¶</a></h3>
<p>To find information about USB devices (serial numbers, paths) use any
of these methods.</p>
<p>Note it is also possible that a device declares a serial number but it
is all the same for every device (for example, in the FlySwatter2 and
other FTDI based hardware). In FTDI based case, it is possible to
re-flash a new serial number with <a class="reference internal" href="#fs2-serial-update"><span class="std std-ref">these instructions</span></a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">use these methods in a Linux machine that is not running
<em>TTBD</em> actively, as it will keep producing messages in the
kernel output and it will be difficult to tell which device
is the right one.</p>
</div>
<div class="section" id="finding-usb-device-information-with-dmesg">
<h4>4.4.7.1. Finding USB device information with dmesg<a class="headerlink" href="#finding-usb-device-information-with-dmesg" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">disconnect the device</p>
</li>
<li><p class="first">run <cite>dmesg -w</cite> in a console to see the kernel log, hit <code class="docutils literal notranslate"><span class="pre">enter</span></code> a
few times to create space</p>
</li>
<li><p class="first">plug the device, see a message pop up with device data from the
kernel</p>
</li>
<li><p class="first">Note the device data, along:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">new</span> <span class="n">full</span><span class="o">-</span><span class="n">speed</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">62</span> <span class="n">using</span> <span class="n">ehci</span><span class="o">-</span><span class="n">pci</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">New</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">found</span><span class="p">,</span> <span class="n">idVendor</span><span class="o">=</span><span class="mi">2</span><span class="n">a03</span><span class="p">,</span> <span class="n">idProduct</span><span class="o">=</span><span class="mi">003</span><span class="n">d</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">New</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">strings</span><span class="p">:</span> <span class="n">Mfr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Product</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="o">=</span><span class="mi">220</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Product</span><span class="p">:</span> <span class="n">Arduino</span> <span class="n">Due</span> <span class="n">Prog</span><span class="o">.</span> <span class="n">Port</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">Manufacturer</span><span class="p">:</span> <span class="n">Arduino</span> <span class="p">(</span><span class="n">www</span><span class="o">.</span><span class="n">arduino</span><span class="o">.</span><span class="n">org</span><span class="p">)</span>
<span class="n">usb</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">1</span><span class="p">:</span> <span class="n">SerialNumber</span><span class="p">:</span> <span class="mf">85439303033351E06162</span>
</pre></div>
</div>
<p>in this example, ignore the <em>SerialNumber</em> where it says <em>New USB
device Strings</em> and focus on the following one.</p>
<p>If there is no serial number, there will be something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">strings</span><span class="p">:</span> <span class="n">Mfr</span><span class="o">=</span><span class="n">XYZ</span><span class="p">,</span> <span class="n">Product</span><span class="o">=</span><span class="n">XYZ</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>and no line with just <em>SerialNumber</em> on its own will appear.</p>
</li>
</ol>
</div>
<div class="section" id="finding-usb-device-information-with-lsusb-py">
<h4>4.4.7.2. Finding USB device information with lsusb.py<a class="headerlink" href="#finding-usb-device-information-with-lsusb-py" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">lsusb.py</span> <span class="pre">-iu</span></code> provides a tree display of the USB connected devices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usb1</span>            <span class="mi">1</span><span class="n">d6b</span><span class="p">:</span><span class="mi">0002</span> <span class="mi">09</span>  <span class="mf">2.00</span>  <span class="mi">480</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">0</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">ehci_hcd</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">1</span><span class="n">a</span><span class="o">.</span><span class="mi">7</span><span class="p">)</span> <span class="n">hub</span>
 <span class="mi">1</span><span class="o">-</span><span class="mi">1</span>            <span class="mf">05e3</span><span class="p">:</span><span class="mi">0608</span> <span class="mi">09</span>  <span class="mf">2.00</span>  <span class="mi">480</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">Genesys</span> <span class="n">Logic</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">Hub</span><span class="p">)</span> <span class="n">hub</span>
  <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span>         <span class="mi">2001</span><span class="p">:</span><span class="n">f103</span> <span class="mi">09</span>  <span class="mf">2.00</span>  <span class="mi">480</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">0</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">D</span><span class="o">-</span><span class="n">Link</span> <span class="n">Corp</span><span class="o">.</span> <span class="n">DUB</span><span class="o">-</span><span class="n">H7</span> <span class="mi">7</span><span class="o">-</span><span class="n">port</span> <span class="n">USB</span> <span class="mf">2.0</span> <span class="n">hub</span><span class="p">)</span> <span class="n">hub</span>
   <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">1</span>      <span class="mi">0424</span><span class="p">:</span><span class="mi">2514</span> <span class="mi">09</span>  <span class="mf">2.00</span>  <span class="mi">480</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">2</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">Standard</span> <span class="n">Microsystems</span> <span class="n">Corp</span><span class="o">.</span> <span class="n">USB</span> <span class="mf">2.0</span> <span class="n">Hub</span><span class="p">)</span> <span class="n">hub</span>
    <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">1.1</span>   <span class="mi">2</span><span class="n">a03</span><span class="p">:</span><span class="mi">003</span><span class="n">d</span> <span class="mi">02</span>  <span class="mf">1.10</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">2</span><span class="n">IFs</span> <span class="p">(</span><span class="n">Arduino</span> <span class="p">(</span><span class="n">www</span><span class="o">.</span><span class="n">arduino</span><span class="o">.</span><span class="n">org</span><span class="p">)</span> <span class="n">Arduino</span> <span class="n">Due</span> <span class="n">Prog</span><span class="o">.</span> <span class="n">Port</span> <span class="mf">85439303033351E01192</span><span class="p">)</span>
   <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">2</span>      <span class="mi">0424</span><span class="p">:</span><span class="mi">2514</span> <span class="mi">09</span>  <span class="mf">2.00</span>  <span class="mi">480</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">2</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">Standard</span> <span class="n">Microsystems</span> <span class="n">Corp</span><span class="o">.</span> <span class="n">USB</span> <span class="mf">2.0</span> <span class="n">Hub</span><span class="p">)</span> <span class="n">hub</span>
    <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.4</span>   <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK20946</span><span class="p">)</span>
     <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mf">2.4</span><span class="p">:</span><span class="mf">1.0</span><span class="p">(</span><span class="n">IF</span><span class="p">)</span> <span class="mi">03</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="mi">2</span><span class="n">EPs</span> <span class="p">(</span><span class="n">Human</span> <span class="n">Interface</span> <span class="n">Device</span><span class="p">:</span><span class="n">No</span> <span class="n">Subclass</span><span class="p">:</span><span class="kc">None</span><span class="p">)</span>
   <span class="mi">1</span><span class="o">-</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">5</span>      <span class="mi">0403</span><span class="p">:</span><span class="mi">6001</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">90</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IFs</span> <span class="p">(</span><span class="n">FTDI</span> <span class="n">FT232R</span> <span class="n">USB</span> <span class="n">UART</span> <span class="n">A5026SO1</span><span class="p">)</span>
</pre></div>
</div>
<p>if we know the brand of our device, we can look it up; in the excerpt
tree below, we can see, for example, a YKUSH on <em>1-1.1.2.4</em>; next to
the name of the device is the serial number (if available), <em>YK20946</em>
(in this example).</p>
</div>
<div class="section" id="finding-usb-device-information-with-udevadm">
<h4>4.4.7.3. Finding USB device information with udevadm<a class="headerlink" href="#finding-usb-device-information-with-udevadm" title="Permalink to this headline">¶</a></h4>
<p>Once we know a device node of any time has been established (eg:
<code class="file docutils literal notranslate"><span class="pre">/dev/ttyUSB9</span></code>), use <code class="docutils literal notranslate"><span class="pre">udevadm</span> <span class="pre">info</span></code> to find information about
it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm info /dev/ttyUSB0   # or whichever device node (eg: /dev/video or /dev/snd/XYZ)</span>
<span class="n">P</span><span class="p">:</span> <span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">pci0000</span><span class="p">:</span><span class="mi">00</span><span class="o">/</span><span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">14.0</span><span class="o">/</span><span class="n">usb1</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mf">1.0</span><span class="o">/</span><span class="n">ttyUSB0</span><span class="o">/</span><span class="n">tty</span><span class="o">/</span><span class="n">ttyUSB0</span>
<span class="n">N</span><span class="p">:</span> <span class="n">ttyUSB0</span>
<span class="n">S</span><span class="p">:</span> <span class="n">serial</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="nb">id</span><span class="o">/</span><span class="n">pci</span><span class="o">-</span><span class="n">Prolific_Technology_Inc</span><span class="o">.</span><span class="n">_USB</span><span class="o">-</span><span class="n">Serial_Controller</span><span class="o">-</span><span class="n">if00</span><span class="o">-</span><span class="n">port0</span>
<span class="n">S</span><span class="p">:</span> <span class="n">serial</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">path</span><span class="o">/</span><span class="n">pci</span><span class="o">-</span><span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">14.0</span><span class="o">-</span><span class="n">usb</span><span class="o">-</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mf">1.0</span><span class="o">-</span><span class="n">port0</span>
<span class="o">...</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_SERIAL_SHORT</span><span class="o">=</span><span class="n">OR0497598</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_PATH</span><span class="o">=</span><span class="n">pci</span><span class="o">-</span><span class="mi">0000</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mf">14.0</span><span class="o">-</span><span class="n">usb</span><span class="o">-</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="mf">1.0</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_PATH_TAG</span><span class="o">=</span><span class="n">pci</span><span class="o">-</span><span class="mi">0000</span><span class="n">_00_14_0</span><span class="o">-</span><span class="n">usb</span><span class="o">-</span><span class="mi">0</span><span class="n">_2_1_0</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_PCI_CLASS_FROM_DATABASE</span><span class="o">=</span><span class="n">Serial</span> <span class="n">bus</span> <span class="n">controller</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_PCI_INTERFACE_FROM_DATABASE</span><span class="o">=</span><span class="n">XHCI</span>
<span class="n">E</span><span class="p">:</span> <span class="n">ID_PCI_SUBCLASS_FROM_DATABASE</span><span class="o">=</span><span class="n">USB</span> <span class="n">controller</span>
<span class="o">...</span>
</pre></div>
</div>
<p>those values can be used to match in udev</p>
</div>
</div>
<div class="section" id="udev-configuration-of-serial-port">
<span id="usb-tty"></span><h3>4.4.8. udev configuration of serial port<a class="headerlink" href="#udev-configuration-of-serial-port" title="Permalink to this headline">¶</a></h3>
<p>Methods for configuring a serial port by name. When a USB serial port
is connected to the system, it is assigned a non-predictable name (eg:
<em>/dev/ttyUSB14</em> or <em>/dev/ttyACM3</em>) which will change each time is
plugged (or not).</p>
<p>In order to have an stable name that consistently represents the
device we are connecting, follow any of the following recipes, based
on the capabilities of the USB device you are plugging to the system.</p>
<div class="section" id="udev-configuration-of-serial-port-based-on-serial-number">
<span id="usb-tty-serial"></span><h4>4.4.8.1. udev configuration of serial port based on serial number<a class="headerlink" href="#udev-configuration-of-serial-port-based-on-serial-number" title="Permalink to this headline">¶</a></h4>
<p>Given a target name (TARGETNAME) we are going to name a serial port
assigned to it <cite>/dev/tty-TARGETNAME</cite> based on the <em>serial number</em> of
the USB device (that can be found using the <a class="reference internal" href="#find-usb-info"><span class="std std-ref">tricks above</span></a>) in <code class="file docutils literal notranslate"><span class="pre">/etc/udev/rules.d/90-ttbd.rules</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SUBSYSTEM</span> <span class="o">==</span> <span class="s2">&quot;tty&quot;</span><span class="p">,</span> <span class="n">ENV</span><span class="p">{</span><span class="n">ID_SERIAL_SHORT</span><span class="p">}</span> <span class="o">==</span> <span class="s2">&quot;SERIALNUMBER&quot;</span><span class="p">,</span> \
  <span class="n">SYMLINK</span> <span class="o">+=</span> <span class="s2">&quot;tty-TARGETNAME&quot;</span>
</pre></div>
</div>
<p>Remember to <a class="reference internal" href="#configure-udev"><span class="std std-ref">update udev</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm control --reload-rules</span>
</pre></div>
</div>
</div>
<div class="section" id="udev-configuration-of-serial-port-without-serial-number-based-on-path">
<span id="usb-tty-path"></span><h4>4.4.8.2. udev configuration of serial port without serial number based on path<a class="headerlink" href="#udev-configuration-of-serial-port-without-serial-number-based-on-path" title="Permalink to this headline">¶</a></h4>
<p>This is used for USB serial dongles that have no unique USB serial number.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This approach is very risky–any physical changes in the
positions of cables or logical changes in enumeration
order when kernel boots will change the path and might
render your configuration inoperative or working incorrectly.</p>
</div>
<p>Given a target name (TARGETNAME) we are going to name a serial port
assigned to it <cite>/dev/tty-TARGETNAME</cite> based on the <em>path</em> the USB
device is connected, as most serial cables have no serial number; in
<code class="file docutils literal notranslate"><span class="pre">/etc/udev/rules.d/90-ttbd.rules</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SUBSYSTEM</span> <span class="o">==</span> <span class="s2">&quot;tty&quot;</span><span class="p">,</span> <span class="n">ENV</span><span class="p">{</span><span class="n">ID_PATH</span><span class="p">}</span> <span class="o">==</span> <span class="s2">&quot;*-usb-0:1.2.2:1.0&quot;</span><span class="p">,</span> \
  <span class="n">SYMLINK</span> <span class="o">+=</span> <span class="s2">&quot;tty-TARGETNAME&quot;</span>
</pre></div>
</div>
<p>find the path by plugging the device, using <cite>dmesg -w</cite> to find which
<cite>/dev/ttyUSBX</cite> (or <cite>/dev/ttyACMX</cite>) name is given and then running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm info /dev/ttyUSBX | grep ID_PATH=</span>
<span class="n">ID_PATH</span><span class="o">=</span><span class="n">pciblahblah</span><span class="o">-</span><span class="n">usb</span><span class="o">-</span><span class="mi">0</span><span class="p">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">2</span><span class="p">:</span><span class="mf">1.0</span>
</pre></div>
</div>
<p><a class="reference internal" href="#configure-udev"><span class="std std-ref">reload udev config</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm control --reload-rules</span>
</pre></div>
</div>
<p>replug the USB dongle or device and verify the symlink
<cite>/dev/tty-TARGETNAME</cite> is there.</p>
<p>If not found, use syslog or <cite>journalctl -r</cite> and <cite>udevadm
control –log-level debug</cite> to find our what is going on when the
device is plugged.</p>
</div>
<div class="section" id="udev-configuration-of-serial-port-based-on-sibling-s-serial-number">
<span id="usb-tty-sibling"></span><h4>4.4.8.3. udev configuration of serial port based on sibling’s serial number<a class="headerlink" href="#udev-configuration-of-serial-port-based-on-sibling-s-serial-number" title="Permalink to this headline">¶</a></h4>
<p>This is used for USB-to-TTY serial dongles that have no unique USB
serial number.</p>
<p>Given a target name (TARGETNAME) we are going to name a USB-to-TTY
serial port assigned to it <cite>/dev/tty-TARGETNAME</cite> based on the USB
serial number of another device (the sibling) connected to the same
USB hub.</p>
<p>The sibling USB device has to have a unique USB serial number. By
knowing in which port our the USB-to-TTY serial dongle is, we can
piggy back on the other sibling device’s USB serial number.</p>
<p>Thus, if we move the USB hub around, it’ll still have the same name,
as long as we don’t change the port to which it is connected.</p>
<p>In <code class="file docutils literal notranslate"><span class="pre">/etc/udev/rules.d/90-ttbd.rules</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># When the USB-TTL port is connected to the hub with serial number</span>
<span class="c1"># YKXXXXX</span>
<span class="n">SUBSYSTEM</span> <span class="o">==</span> <span class="s2">&quot;tty&quot;</span><span class="p">,</span> \
    <span class="n">PROGRAM</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/usb-sibling-by-serial YKXXXXX&quot;</span><span class="p">,</span> \
    <span class="n">ENV</span><span class="p">{</span><span class="n">ID_PATH</span><span class="p">}</span> <span class="o">==</span> <span class="s2">&quot;*2:1.0&quot;</span><span class="p">,</span> \
    <span class="n">SYMLINK</span> <span class="o">+=</span> <span class="s2">&quot;tty-TARGETNAME&quot;</span>
</pre></div>
</div>
<p>note the <code class="docutils literal notranslate"><span class="pre">*2:1.0</span></code>; that selects port 2, where we connect the
serial port adapter. Port 1 would be <code class="docutils literal notranslate"><span class="pre">*1:1.0</span></code>, etc.</p>
<p>Remember to <a class="reference internal" href="#configure-udev"><span class="std std-ref">update udev</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># udevadm control --reload-rules</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="finding-the-serial-number-of-a-devantech-usbrly08b-relay-controller">
<span id="usbrly08b-serial-number"></span><h3>4.4.9. Finding the serial number of a Devantech USBRLY08B relay controller<a class="headerlink" href="#finding-the-serial-number-of-a-devantech-usbrly08b-relay-controller" title="Permalink to this headline">¶</a></h3>
<p>Plug your board to the system and list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb.py | grep -i Devantech
 1-1.1.1       04d8:ffee 02  2.00   12MBit/s 100mA 2IFs (Devantech Ltd. USB-RLY08 00023456)
</pre></div>
</div>
<p><em>00023456</em> is the serial number; if there are multiple devices and you
are not sure which one is it, disconnect the one you care for and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb.py | grep -i Devantech &gt; before
</pre></div>
</div>
<p>now reconnect it and run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb.py | grep -i Devantech &gt; after
</pre></div>
</div>
<p>diff the files <em>before</em> and <em>after</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ diff before after
3d2
&lt;  1-1.1.1       04d8:ffee 02  2.00   12MBit/s 100mA 2IFs (Devantech Ltd. USB-RLY08 00023456)
</pre></div>
</div>
<p>or run <cite>dmesg -w</cite> on the terminal, unplug and plug the device, see the
kernel message about the new USB device, note the serial number.</p>
</div>
<div class="section" id="finding-the-serial-number-of-an-ykush-hub">
<span id="ykush-serial-number"></span><h3>4.4.10. Finding the serial number of an YKUSH hub<a class="headerlink" href="#finding-the-serial-number-of-an-ykush-hub" title="Permalink to this headline">¶</a></h3>
<p>Methods to find the serial number of an YKUSH hub:</p>
<ul>
<li><p class="first">plug your YKush hub to the system and list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># lsusb.py | grep YKUSH | tee before</span>
  <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">1.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21297</span><span class="p">)</span>
  <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">2.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21292</span><span class="p">)</span>
  <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">3.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21290</span><span class="p">)</span>
  <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">4.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21294</span><span class="p">)</span>
 <span class="mi">2</span><span class="o">-</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">4</span>       <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21293</span><span class="p">)</span>
</pre></div>
</div>
<p>you might have many; to tell which one is the one in your hand, you
can just unplug it and list again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># lsusb.py | grep YKUSH | tee after</span>
 <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">1.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21297</span><span class="p">)</span>
 <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">2.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21292</span><span class="p">)</span>
 <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">4.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21294</span><span class="p">)</span>
<span class="mi">2</span><span class="o">-</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">4</span>       <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21293</span><span class="p">)</span>
</pre></div>
</div>
<p>to (quickly) find out which one was unplugged, diff the files
<em>before</em> and <em>after</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># diff before after</span>
<span class="mi">3</span><span class="n">d2</span>
<span class="o">&lt;</span>     <span class="mi">2</span><span class="o">-</span><span class="mf">2.1</span><span class="o">.</span><span class="mf">3.4</span>    <span class="mi">04</span><span class="n">d8</span><span class="p">:</span><span class="n">f2f7</span> <span class="mi">00</span>  <span class="mf">2.00</span>   <span class="mi">12</span><span class="n">MBit</span><span class="o">/</span><span class="n">s</span> <span class="mi">100</span><span class="n">mA</span> <span class="mi">1</span><span class="n">IF</span>  <span class="p">(</span><span class="n">Yepkit</span> <span class="n">Lda</span><span class="o">.</span> <span class="n">YKUSH</span> <span class="n">YK21290</span><span class="p">)</span>
</pre></div>
</div>
<p>the line that was removed when we unplugged was the one for <em>YK21290</em>,
which is the serial number of the hub.</p>
</li>
<li><p class="first">run <cite>dmesg -w</cite> on a terminal and plug the device, see the kernel
message about the new USB device, note the serial number</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the hub itself has no serial number, but an internal device
connected to its downstream port number 4 does have the
<em>YK34567</em> serial number.</p>
</div>
</div>
</div>
<div class="section" id="ttbd-tcf-server-configuration-and-tricks">
<h2>4.5. <em>ttbd</em>: TCF server configuration and tricks<a class="headerlink" href="#ttbd-tcf-server-configuration-and-tricks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="starting-more-that-one-instance">
<span id="ttbd-config-multiple-instances"></span><h3>4.5.1. Starting more that one instance<a class="headerlink" href="#starting-more-that-one-instance" title="Permalink to this headline">¶</a></h3>
<p>Most setups will only have one instance, the <em>production</em> instance;
however, two more are recommended:</p>
<ul class="simple">
<li><em>infrastructure</em>: handles power to USB hubs, equipment, normal and
power switching to reset them in case) of issues, individual raw
access to all the power switching units connected throughout the
system, network switches, etc</li>
<li><em>staging</em>: targets whose drivers are being developed before moving
into production (optional)</li>
</ul>
<p>To bring up an instance (repeat these steps replacing <em>production</em> with
<em>INSTANCENAME</em> for other instances):</p>
<ol class="arabic">
<li><p class="first">Create the instance’s configuration directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># install -d -m 2775 -o ttbd -g ttbd /etc/ttbd-production</span>
</pre></div>
</div>
<p>systemd will create the runtime directories needed when starting
<em>ttbd</em> in <cite>/var/run/ttbd-production</cite> and
<cite>/var/cache/ttbd-production</cite> as they will be wiped by the system
on restart.</p>
</li>
<li><p class="first">Each instance listens on a different port, so we create the initial
server configuration <cite>/etc/ttbd-production/conf_00_bind.py</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>           <span class="c1"># Listen on all interfaces</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5000</span>
</pre></div>
</div>
<p><em>infrastructure</em> is usually assigned 4999, <em>staging</em> 5001. Enable
access through the firewall to said ports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># firewall-cmd --add-port=4999-5001/tcp --permanent</span>
</pre></div>
</div>
</li>
</ol>
<ol class="arabic" start="4">
<li><p class="first">Enable and start the instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl enable ttbd@production</span>
<span class="c1"># systemctl start ttbd@production</span>
</pre></div>
</div>
<p><em>systemd</em> runs the daemon run as user <em>ttbd</em>, group <em>ttbd</em> and
the following supplemental groups:</p>
<blockquote>
<div><ul class="simple">
<li><em>root</em>: to be able to scan USB devices</li>
<li><em>dialout</em>: to be able to access serial devices and USB connected
serial devices (for consoles, JTAGs, etc)</li>
<li><em>ttbd</em>: to access configuration and other files</li>
</ul>
</div></blockquote>
<p>See log output with <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">ttbd&#64;NAME</span></code>. Diagnose issues
starting with systemd in <a class="reference internal" href="06-troubleshooting.html#systemd-tips-diagnosis"><span class="std std-ref">troubleshooting</span></a>. Further configuration <a class="reference internal" href="06-troubleshooting.html#systemd-tips-configuring"><span class="std std-ref">tips</span></a>.</p>
</li>
<li><p class="first">At this point you could create or copy existing <code class="docutils literal notranslate"><span class="pre">conf_*.py</span></code>
configuration files to <code class="docutils literal notranslate"><span class="pre">/etc/ttbd-production</span></code> and restart the
service with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
<p>If you have none, that is ok, we’ll add them in the next sections.</p>
</li>
</ol>
<p>Note that now, none can access the server yet because there is no way
to authenticate with it :) Let’s add some configuration.</p>
</div>
<div class="section" id="configure-authentication-for-local-users-optional">
<span id="ttbd-config-auth-local"></span><h3>4.5.2. Configure authentication for local users (optional)<a class="headerlink" href="#configure-authentication-for-local-users-optional" title="Permalink to this headline">¶</a></h3>
<p>A quick way to allow any user in the local machine to use the server
without authenticating is to request local authentication for
127.0.0.1; run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># echo &#39;local_auth.append(&quot;127.0.0.1&quot;)&#39; \</span>
  <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ttbd</span><span class="o">-</span><span class="n">production</span><span class="o">/</span><span class="n">conf_00_auth_local</span><span class="o">.</span><span class="n">py</span>
<span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
<p>Now login in should work with no need to input anything (in this case,
there will be no output either):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf -iu https://localhost:5000 login
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>feel free to ignore the error message about <cite>ZEPHYR_BASE not
being defined</cite>; it is a glitch that will be fixed. You can
work around it by running:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span>$ export ZEPHYR_BASE=
</pre></div>
</div>
</div>
<p>You can configure local TCF clients to access the local instance
by default (<a class="reference internal" href="02-guides.html#tcf-configuring"><span class="std std-ref">more</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkdir -p /etc/tcf</span>
<span class="c1"># echo &quot;tcfl.config.url_add(&#39;https://localhost:5000&#39;, ssl_ignore = True)&quot; \</span>
  <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">tcf</span><span class="o">/</span><span class="n">conf_local</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-simple-authentication-for-jenkins-jobs-optional">
<span id="ttbd-config-authdb"></span><h3>4.5.3. Configure simple authentication / for Jenkins jobs (optional)<a class="headerlink" href="#configure-simple-authentication-for-jenkins-jobs-optional" title="Permalink to this headline">¶</a></h3>
<p>You can setup static accounts for users or Jenkins autobuilders with
hardcoded passwords by creating a file
<code class="docutils literal notranslate"><span class="pre">/etc/ttbd-production/conf_00_auth_localdb.py</span></code> with the contents:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ttbl.auth_localdb</span>

<span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_authenticator</span><span class="p">(</span><span class="n">ttbl</span><span class="o">.</span><span class="n">auth_localdb</span><span class="o">.</span><span class="n">authenticator_localdb_c</span><span class="p">(</span>
     <span class="s2">&quot;Jenkins and other&quot;</span><span class="p">,</span>
     <span class="p">[</span>
         <span class="p">[</span> <span class="s1">&#39;usera&#39;</span><span class="p">,</span> <span class="s1">&#39;PASSWORDA&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">],</span>
         <span class="p">[</span> <span class="s1">&#39;superuserB&#39;</span><span class="p">,</span> <span class="s1">&#39;PASSWORDB&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="p">],</span>
         <span class="p">[</span> <span class="s1">&#39;jenkins1&#39;</span><span class="p">,</span> <span class="s1">&#39;PASSWORD1&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">],</span>
         <span class="p">[</span> <span class="s1">&#39;jenkins2&#39;</span><span class="p">,</span> <span class="s1">&#39;PASSWORD2&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">],</span>
         <span class="o">...</span>
     <span class="p">]))</span>
</pre></div>
</div>
<p>Restart to read the configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-authentication-against-ldap">
<span id="ttbd-config-auth-ldap"></span><h3>4.5.4. Configure authentication against LDAP<a class="headerlink" href="#configure-authentication-against-ldap" title="Permalink to this headline">¶</a></h3>
<p>Copy the configuration example
<cite>/etc/ttbd/production/example_conf_05_auth_ldap.py</cite> and modify it to
suit your LDAP setup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cp /etc/ttbd-production/example_conf_05_auth_ldap.py /etc/ttbd-production/conf_05_auth_ldap.py</span>
<span class="c1"># &lt;edit away&gt;</span>
<span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
<p>Authorized users (users in the declared LDAP groups in the
configurtion file) should now be able to login with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf login LDAPLOGIN
</pre></div>
</div>
<p>This file can be tweaked to fit your authentication needs. For
example, you might want to change the name of the LDAP groups your
users need to be members off.</p>
<p>If this does not work, most likely the configuration files where not
loaded properly; check the daemon output (<a class="reference internal" href="06-troubleshooting.html#systemd-tips-diagnosis"><span class="std std-ref">troubleshooting</span></a> and <a class="reference internal" href="06-troubleshooting.html#ttbd-auth-ldap-invalid-creds"><span class="std std-ref">troubleshooting LDAP</span></a>).</p>
</div>
<div class="section" id="configuring-a-target-for-just-controlling-power-to-something">
<span id="tt-power"></span><h3>4.5.5. Configuring a target for just controlling power to something<a class="headerlink" href="#configuring-a-target-for-just-controlling-power-to-something" title="Permalink to this headline">¶</a></h3>
<p>In your <em>ttbd</em>’s <cite>conf_SOMETHING.py</cite> config file, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">target_add</span><span class="p">(</span>
    <span class="n">ttbl</span><span class="o">.</span><span class="n">tt</span><span class="o">.</span><span class="n">tt_power</span><span class="p">(</span>
      <span class="s2">&quot;TARGETNAME&quot;</span><span class="p">,</span>
      <span class="n">power_control</span> <span class="o">=</span> <span class="n">PC_OBJECT</span><span class="p">,</span>
      <span class="n">power</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">),</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idle_poweroff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>this creates a target called <em>TARGETNAME</em> that you can power on, off
or cycle. The <em>power</em> argument indicates what do do with the power at
startup (<em>True</em> turn it on, <em>False</em> turn it off, <em>None</em>–or omitting
this argument, leave it as is). <em>tags = dict(idle_poweroff = 32)</em> is
used to have <em>TARGETNAME</em> not being powered off when idle.</p>
<p>Now, <em>PC_OBJECT</em> is the actual implementation of power control and you
can make it be things like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">dlwps7</span><span class="p">(</span><span class="s2">&quot;http://admin:1234@sp3/5&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This would make <em>TARGETNAME</em>’s power be controlled by plug #5 of the
<em>Digital Logger Web Power Switch 7</em> named <em>sp3</em> (<a class="reference internal" href="09-api.html#conf_00_lib_pdu.dlwps7_add" title="conf_00_lib_pdu.dlwps7_add"><code class="xref py py-func docutils literal notranslate"><span class="pre">setup</span>
<span class="pre">instructions</span></code></a>). Because this is a normal,
120V plug, if a light bulb were connected to it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">target_add</span><span class="p">(</span>
  <span class="n">ttbl</span><span class="o">.</span><span class="n">tt</span><span class="o">.</span><span class="n">tt_power</span><span class="p">(</span>
    <span class="s2">&quot;Entrance_light&quot;</span><span class="p">,</span>
    <span class="n">power_control</span> <span class="o">=</span> <span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">dlwps7</span><span class="p">(</span><span class="s2">&quot;http://admin:1234@sp3/5&quot;</span><span class="p">),</span>
    <span class="n">power</span> <span class="o">=</span> <span class="kc">True</span>
  <span class="p">),</span>
  <span class="n">tags</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">idle_poweroff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>and like this, the target <em>Entrance_light</em> can be switched on or off
with <em>tcf power-on Entrance_light</em> and <em>tcf power-off Entrance_light</em>.</p>
<p>It could also be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">pc_ykush</span><span class="o">.</span><span class="n">ykush</span><span class="p">(</span><span class="s2">&quot;YK21080&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>which means that power to <em>TARGETNAME</em> would be implemented by
powering on or off port #3 of the YKush power-switching hub with
serial number <em>YK21080</em> (<a class="reference internal" href="09-api.html#conf_00_lib_pdu.ykush_targets_add" title="conf_00_lib_pdu.ykush_targets_add"><code class="xref py py-func docutils literal notranslate"><span class="pre">setup</span> <span class="pre">instructions</span></code></a>).</p>
<p>Other power controller implementations are possible, of course, by
subclassing <code class="xref py py-class docutils literal notranslate"><span class="pre">ttbl.tt_power_control_impl</span></code>.</p>
</div>
<div class="section" id="configuring-a-linux-target-to-power-on-off-with-serial-console">
<span id="tt-linux-simple"></span><h3>4.5.6. Configuring a Linux target to power on/off with serial console<a class="headerlink" href="#configuring-a-linux-target-to-power-on-off-with-serial-console" title="Permalink to this headline">¶</a></h3>
<p>Building on the previous example, we can use the <code class="xref py py-class docutils literal notranslate"><span class="pre">ttbl.tt.tt_serial</span></code>
object to create a target that provides serial consoles, can be
powered on or off and we can interact with the target over the serial
console.</p>
<p>If we have a Linux machine which is installed with a distro that
provides serial console access, then this will work:</p>
<p><strong>Bill of materials</strong></p>
<ul class="simple">
<li>a Linux machine</li>
<li>a serial console to the physical Linux machine (if your machine
doesn’t have serial ports, a <a class="reference external" href="https://www.serialgear.com/Serial-Adapters-USBG-NULL-30.html">USB null modem</a> or
two USB serial dongles with a NULL modem adapter will do.</li>
<li>one available port on a power switch, to turn the physical machine
on/off (eg, a <a class="reference internal" href="09-api.html#conf_00_lib_pdu.dlwps7_add" title="conf_00_lib_pdu.dlwps7_add"><code class="xref py py-func docutils literal notranslate"><span class="pre">DLWPS7</span></code></a>)</li>
</ul>
<p><strong>Connecting the test target fixture</strong></p>
<ol class="arabic">
<li><p class="first">Configure the Linux machine to:</p>
<ul>
<li><p class="first">always power on when AC power is on</p>
</li>
<li><p class="first">provide a serial console on the serial port; this can be done by
adding <code class="docutils literal notranslate"><span class="pre">console=ttyS0,115200</span></code> and/or <code class="docutils literal notranslate"><span class="pre">console=ttyUSB0,115200</span></code>
to the kernel command line.</p>
<p>In modern systemd-enable distributions, also with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemd enable agetty@ttyUSB0</span>
<span class="c1"># systemd enable agetty@ttyS0</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
<ol class="arabic simple" start="3">
<li>Connect the serial dongle cables to the physical target and to the
server</li>
<li>Connect the physical target to port PORT of power switch
POWERSWITCH</li>
</ol>
<p><strong>Configuring the system for the fixture</strong></p>
<ol class="arabic">
<li><p class="first">Choose a name for the target: <em>linux-NN</em> (where NN is a number)</p>
</li>
<li><p class="first">Configure <em>udev</em> to add a name for the serial device for the
board’s serial console so it can be easily found at
<code class="docutils literal notranslate"><span class="pre">/dev/tty-TARGETNAME</span></code>. Follow <a class="reference internal" href="#usb-tty-serial"><span class="std std-ref">these instructions</span></a> using the serial dongle’s <em>serial number</em>.</p>
</li>
<li><p class="first">Add a configuration block to the server configuration file:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">target_add</span><span class="p">(</span>
     <span class="n">ttbl</span><span class="o">.</span><span class="n">tt</span><span class="o">.</span><span class="n">tt_serial</span><span class="p">(</span>
         <span class="s2">&quot;linux-NN&quot;</span><span class="p">,</span>
         <span class="n">power_control</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">cm_serial</span><span class="o">.</span><span class="n">pc</span><span class="p">(),</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">dlwps7</span><span class="p">(</span><span class="s2">&quot;http://admin:1234@POWERSWITCH/PORT&quot;</span><span class="p">),</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
         <span class="p">],</span>
         <span class="n">serial_ports</span> <span class="o">=</span> <span class="p">[</span>
             <span class="s2">&quot;pc&quot;</span><span class="p">,</span>
             <span class="p">{</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/tty-linux-NN&quot;</span><span class="p">,</span> <span class="s2">&quot;baudrate&quot;</span><span class="p">:</span> <span class="mi">115200</span> <span class="p">}</span>
         <span class="p">]),</span>
     <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;linux&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
         <span class="s1">&#39;bsp_models&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="p">},</span>
         <span class="s1">&#39;bsps&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s1">&#39;x86_64&#39;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s1">&#39;linux&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;console&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">,</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="p">},</span>
     <span class="n">target_type</span> <span class="o">=</span> <span class="s2">&quot;linux-DISTRONAME-VERSION&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>where of course, <code class="docutils literal notranslate"><span class="pre">DISTRONAME-VERSION</span></code> matches the linux
distribution and verison installed.</p>
</li>
</ol>
</div>
<div class="section" id="configure-physical-linux-targets-with-a-fixed-live-filesystem">
<span id="ttbd-config-phys-linux-live"></span><h3>4.5.7. Configure physical Linux targets with a fixed Live filesystem<a class="headerlink" href="#configure-physical-linux-targets-with-a-fixed-live-filesystem" title="Permalink to this headline">¶</a></h3>
<p>A physical Linux machine can be booted with the TCF-live image that
will always boot fresh to the same state.</p>
<p>This builds on the <a class="reference internal" href="#tt-linux-simple"><span class="std std-ref">previous section</span></a>.</p>
<p><strong>Bill of materials</strong></p>
<ul class="simple">
<li>a Linux machine w at least 2G RAM (harddrive optional, but recommended)</li>
<li>a USB drive (at least 2G)</li>
<li>a serial console to the physical Linux machine (if your machine
doesn’t have serial ports, a <a class="reference external" href="https://www.serialgear.com/Serial-Adapters-USBG-NULL-30.html">USB null modem</a> or
two USB serial dongles with a NULL modem adapter will do.</li>
<li>one available port on a power switch, to turn the physical machine
on/off (eg, a <a class="reference internal" href="09-api.html#conf_00_lib_pdu.dlwps7_add" title="conf_00_lib_pdu.dlwps7_add"><code class="xref py py-func docutils literal notranslate"><span class="pre">DLWPS7</span></code></a>)</li>
</ul>
<p><strong>Connecting the test target fixture</strong></p>
<ol class="arabic" start="0">
<li><p class="first">Generate a TCF Live ISO image <a class="reference internal" href="03-server-setup.html#generate-tcf-live-iso"><span class="std std-ref">following these steps</span></a></p>
</li>
<li><p class="first">Initialize the USB drive with the image (assuming
it is at <em>/dev/sdb</em>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># livecd-iso-to-disk --format --reset-mbr tcf-live/tcf-live.iso /dev/sdb</span>
</pre></div>
</div>
</li>
<li><p class="first">Plug the USB drive to the physical Linux target, make sure it boots</p>
</li>
<li><p class="first">Configure the Linux machine to:</p>
<ul class="simple">
<li>boot USB first</li>
<li>always power on when AC power is on</li>
</ul>
</li>
<li><p class="first">Create two physical partitions for large file storage during tests
and swap:</p>
<ul>
<li><p class="first">boot the image, connect via standard console or serial console</p>
</li>
<li><p class="first">partition the disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ parted DEVICE -s mklabel gpt                # make a new partition table
$ parted DEVICE -s mkpart logical linux-swap 0% 10G # make a partition
$ parted DEVICE -s name 1 TCF-swap            # name it
$ parted DEVICE -s mkpart logical btrfs 10G 100% # make a partition
$ parted DEVICE -s name 2 TCF-home            # name it
</pre></div>
</div>
</li>
</ul>
<p><em>TCF-home</em> will be always cleaned up and mounted as <em>/home</em> and the
swap will be activated.</p>
</li>
<li><p class="first">Connect the serial dongle cables to the physical target and to the
server</p>
</li>
<li><p class="first">Connect the physical target to port PORT of power switch
POWERSWITCH</p>
</li>
</ol>
<p><strong>Configuring the system for the fixture</strong></p>
<ol class="arabic">
<li><p class="first">Choose a name for the target: <em>linux-NN</em> (where NN is a number)</p>
</li>
<li><p class="first">Configure <em>udev</em> to add a name for the serial device for the
board’s serial console so it can be easily found at
<code class="docutils literal notranslate"><span class="pre">/dev/tty-TARGETNAME</span></code>. Follow <a class="reference internal" href="#usb-tty-serial"><span class="std std-ref">these instructions</span></a> using the board’s <em>serial number</em>.</p>
</li>
<li><p class="first">Add a configuration block to the server configuration file:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">target_add</span><span class="p">(</span>
     <span class="n">ttbl</span><span class="o">.</span><span class="n">tt</span><span class="o">.</span><span class="n">tt_serial</span><span class="p">(</span>
         <span class="s2">&quot;linux-NN&quot;</span><span class="p">,</span>
         <span class="n">power_control</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">cm_serial</span><span class="o">.</span><span class="n">pc</span><span class="p">(),</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">dlwps7</span><span class="p">(</span><span class="s2">&quot;http://admin:1234@POWERSWITCH/PORT&quot;</span><span class="p">),</span>
                <span class="n">ttbl</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
         <span class="p">],</span>
         <span class="n">serial_ports</span> <span class="o">=</span> <span class="p">[</span>
             <span class="s2">&quot;pc&quot;</span><span class="p">,</span>
             <span class="p">{</span> <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/tty-linux-NN&quot;</span><span class="p">,</span> <span class="s2">&quot;baudrate&quot;</span><span class="p">:</span> <span class="mi">115200</span> <span class="p">}</span>
         <span class="p">]),</span>
     <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;linux&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
         <span class="s1">&#39;bsp_models&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="p">},</span>
         <span class="s1">&#39;bsps&#39;</span><span class="p">:</span> <span class="p">{</span>
             <span class="s1">&#39;x86_64&#39;</span><span class="p">:</span> <span class="p">{</span>
                 <span class="s1">&#39;linux&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;console&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">,</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="p">},</span>
     <span class="n">target_type</span> <span class="o">=</span> <span class="s2">&quot;linux-fedora-x86_64&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="adding-tags-to-a-target">
<span id="target-tag"></span><h3>4.5.8. Adding tags to a target<a class="headerlink" href="#adding-tags-to-a-target" title="Permalink to this headline">¶</a></h3>
<p>Once a target is configured, new tags can be added to it using
<a class="reference internal" href="09-api.html#ttbl.test_target.tags_update" title="ttbl.test_target.tags_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ttbl.test_target.tags_update()</span></code></a> in any configuration file
(preferrably next to the target definition); for example, if in
<code class="docutils literal notranslate"><span class="pre">/etc/ttbd-production/conf_10_targets.py</span></code> you had the statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">arduino101_add</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a101-15&quot;</span><span class="p">,</span>
               <span class="n">fs2_serial</span> <span class="o">=</span> <span class="s2">&quot;a101-15-fs2&quot;</span><span class="p">,</span>
               <span class="n">ykush_url</span> <span class="o">=</span> <span class="s2">&quot;http://admin:1234@HOSTNAME/PORT&quot;</span><span class="p">,</span>
               <span class="n">ykush_serial</span> <span class="o">=</span> <span class="s2">&quot;YK24439&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>you can add the tags <code class="docutils literal notranslate"><span class="pre">fixture_spi_basic_0</span></code> (as a boolean that
defaults to <em>True</em> and  <code class="docutils literal notranslate"><span class="pre">tempsetting</span></code> (as an integer) with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">arduino101_add</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;a101-15&quot;</span><span class="p">,</span>
               <span class="n">fs2_serial</span> <span class="o">=</span> <span class="s2">&quot;a101-15-fs2&quot;</span><span class="p">,</span>
               <span class="n">ykush_url</span> <span class="o">=</span> <span class="s2">&quot;http://admin:1234@HOSTNAME/PORT&quot;</span><span class="p">,</span>
               <span class="n">ykush_serial</span> <span class="o">=</span> <span class="s2">&quot;YK24439&quot;</span><span class="p">)</span>
<span class="n">tcfl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;a101-15&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tags_update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">fixture_spi_basic_0</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">tempsetting</span> <span class="o">=</span> <span class="mi">32</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-disable-a-target-by-default">
<span id="target-disable-default"></span><h3>4.5.9. How do I disable a target by default?<a class="headerlink" href="#how-do-i-disable-a-target-by-default" title="Permalink to this headline">¶</a></h3>
<p>When a target has to be disabled by default, add this to the
configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ttbl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;TARGETNAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>the target will be loaded and the configuration will be accesible,
however, <em>tcf</em> clients that select targets automatically (<em>list</em>,
<em>run</em>) will not use it unless <em>-a</em> is given.</p>
<p>This is used for targets that are misbehaving for any reason but still
need to be connected to debug. They can be manually enabled/disabled
with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf disable TARGETNAME
$ tcf enable TARGETNAME
</pre></div>
</div>
<p>The user has to have <em>admin</em> capabilities in the <em>TTBD</em> server to run
this operation.</p>
</div>
<div class="section" id="allowing-the-server-to-be-used-remotely">
<span id="ttbd-config-bind"></span><h3>4.5.10. Allowing the server to be used remotely<a class="headerlink" href="#allowing-the-server-to-be-used-remotely" title="Permalink to this headline">¶</a></h3>
<p>By default, the server is configured to only listen on local ports,
thus only accessible from the server itself.</p>
<p>To allow the server to be accessible on all the network interfaces of
the machine on TCP port 5000, create
<code class="docutils literal notranslate"><span class="pre">/etc/ttbd-production/conf_00_bind.py</span></code> with the content:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">5000</span>
</pre></div>
</div>
<p>Now restart the daemon and verify it restarted properly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart ttbd@production</span>
<span class="c1"># journalctl -eu ttbd@production</span>
</pre></div>
</div>
<p>As well, ensure the server’s firewall allows the given ports to be
accessible. In Fedora 25:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># dnf install -y firewall-config
$ firewall-config
</pre></div>
</div>
<p>In the current firewall zone, add in <em>Ports</em> a range <em>4999-5001</em>, type
TCP.</p>
<p>Now select in the menu <em>Options</em> &gt; <em>Runtime to permanent</em> to ensure
the changes are permanent and next time the server restarts they are
applied.</p>
</div>
<div class="section" id="increasing-the-verbosity-of-the-server">
<h3>4.5.11. Increasing the verbosity of the server<a class="headerlink" href="#increasing-the-verbosity-of-the-server" title="Permalink to this headline">¶</a></h3>
<p>When debugging issues with the server, you might have to increase its
verbosity; for that, more <em>-v</em> have to be given to the command
line. For that, edit <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/ttbd&#64;.service</span></code> to add more
<code class="docutils literal notranslate"><span class="pre">-v</span></code> to the <code class="docutils literal notranslate"><span class="pre">ExecStart</span></code> line.</p>
<p>Reread <em>systemd</em>’s configuration and restart the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl daemon-reload</span>
<span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
<p>Remember to toggle it back to the default <code class="docutils literal notranslate"><span class="pre">-vv</span></code>–it gets chatty.</p>
</div>
</div>
<div class="section" id="manual-installation-of-tcf-from-source">
<span id="manual-install"></span><h2>4.6. Manual installation of TCF from source<a class="headerlink" href="#manual-installation-of-tcf-from-source" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creation-and-setup-of-user-ttbd">
<h3>4.6.1. Creation and setup of user <em>ttbd</em><a class="headerlink" href="#creation-and-setup-of-user-ttbd" title="Permalink to this headline">¶</a></h3>
<p>The <em>ttbd</em> user is used to store TCF’s software and files, and the
<em>ttbd</em> group to give normal user access to said files.</p>
<p>To create it (if not yet created):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># useradd -G kvm ttbd</span>
</pre></div>
</div>
<p>Allow members of group <em>ttbd</em> access to <em>ttbd</em>’s home so they can
write files needed for the deployment in there; never shall need to
login as the <em>ttbd</em> user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chmod g+ws ~ttbd</span>
</pre></div>
</div>
<p>Allow other users access to <em>ttbd</em>’s files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># usermod -aG ttbd USER1 USER2 ….  # Make USERs members of ttbdgroup</span>
</pre></div>
</div>
</div>
<div class="section" id="install-required-software">
<h3>4.6.2. Install required software<a class="headerlink" href="#install-required-software" title="Permalink to this headline">¶</a></h3>
<p>Run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf install -y openocd make gcc-c++ python-ldap pyserial \</span>
  <span class="n">python</span><span class="o">-</span><span class="n">requests</span> <span class="n">git</span> <span class="n">python</span><span class="o">-</span><span class="n">werkzeug</span> <span class="n">python</span><span class="o">-</span><span class="n">tornado</span> <span class="n">python</span><span class="o">-</span><span class="n">flask</span> \
  <span class="n">python</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">login</span> <span class="n">python</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">principal</span> <span class="n">pyusb</span> <span class="n">python</span><span class="o">-</span><span class="n">pexpect</span> \
  <span class="n">pyOpenSSL</span>
</pre></div>
</div>
<p>to install software packages required by TCF’s server:</p>
<ul class="simple">
<li>openocd is used to interact with targets</li>
<li>gcc-c++ and make are used to build</li>
<li>Git is a source control manager we’ll use to obtain TCF’s source</li>
<li>python-ldap, pyserial and python-requests are Python libraries TCF relies on</li>
<li>python-werkzeug, python-flask* and python-tornado are the HTTP
server framework TTBD uses to serve data.</li>
<li>pyusb is the library used to access USB devices from Python</li>
<li>python-pexpect is a expect-like language implementation in Python</li>
</ul>
<p>You might need to <a class="reference internal" href="#install-support-pkgs"><span class="std std-ref">install support packages</span></a> that are not in distributions dependning on
what you want to run with TCF.</p>
</div>
<div class="section" id="remove-conflicting-packages">
<h3>4.6.3. Remove conflicting packages<a class="headerlink" href="#remove-conflicting-packages" title="Permalink to this headline">¶</a></h3>
<p>Remove <em>Modem Manager</em>, as it interferes with the serial ports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf remove -y ModemManager</span>
</pre></div>
</div>
<p>this won’t be needed if you will only use QEMU devices.</p>
</div>
<div class="section" id="install-tcf">
<h3>4.6.4. Install TCF<a class="headerlink" href="#install-tcf" title="Permalink to this headline">¶</a></h3>
<p>Obtain the code</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone git://GITHOST/tcf tcf.git
</pre></div>
</div>
<p id="tcf-install-manual"><strong>Install the TCF client</strong></p>
<p>Follow the steps on the <a class="reference internal" href="../02-QUICKSTART.html#install-tcf-client"><span class="std std-ref">quickstart</span></a> to
install the client from source.</p>
<blockquote>
<div>$ cd tcf.git
$ python setup.py install –user</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>you will also need to install the <a class="reference external" href="https://www.zephyrproject.org/downloads/tools">Zephyr SDK 0.9</a> to
<code class="docutils literal notranslate"><span class="pre">/opt/zephyr-sdk-0.9.5</span></code> if you want to build Zephyr OS
apps and other dependencies:</p>
<p>Fedora:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dnf install -y make python-requests python-ply cmake \</span>
  <span class="n">PyYAML</span> <span class="n">python2</span><span class="o">-</span><span class="n">junit_xml</span> <span class="n">python2</span><span class="o">-</span><span class="n">jinja2</span>
</pre></div>
</div>
<p>Ubuntu:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt-get install -y python-ply python-requests make \</span>
  <span class="n">python</span><span class="o">-</span><span class="n">junit</span><span class="o">.</span><span class="n">xml</span> <span class="n">python</span><span class="o">-</span><span class="n">jinja2</span>
</pre></div>
</div>
</div>
<p><strong>Install the server</strong></p>
<p>Install requirements: sdnotify, a library to help TCF’s server TTBD
integrate with systemd:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pip install sdnotify
</pre></div>
</div>
<p>Now the server itself:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd tcf.git/ttbd
$ sudo python setup.py install
</pre></div>
</div>
<p>Note the server needs configuration of SELinux, kernel credentials,
UIDs and GIDs for operation – so running it off the RPM package can
get complicated.</p>
</div>
</div>
<div class="section" id="manual-installation-of-support-packages">
<span id="install-support-pkgs"></span><h2>4.7. Manual installation of support packages<a class="headerlink" href="#manual-installation-of-support-packages" title="Permalink to this headline">¶</a></h2>
<p>These are dependencies needed when certain kind of test hardware is
going to be connected or certain OSes / testcases are to be used:</p>
<ul class="simple">
<li>Arduino Due boards: <a class="reference internal" href="#bossac"><span class="std std-ref">Bossa command line</span></a></li>
<li>Zephyr SDK for Arduino 101, Intel Quark, FRDM, SAM e70, others:
<a class="reference internal" href="#zephyr-sdk"><span class="std std-ref">Zephyr SDK</span></a></li>
<li><a class="reference internal" href="#xtensa-esp32"><span class="std std-ref">ESP32</span></a></li>
<li>NiosII on Altera MAX10: <code class="xref py py-data docutils literal notranslate"><span class="pre">Quartus</span> <span class="pre">programmer</span></code> and <code class="xref py py-data docutils literal notranslate"><span class="pre">NiosII</span> <span class="pre">CPU</span> <span class="pre">image</span></code></li>
</ul>
<div class="section" id="bossac-arduino-due-flasher">
<span id="bossac"></span><h3>4.7.1. Bossac: Arduino Due flasher<a class="headerlink" href="#bossac-arduino-due-flasher" title="Permalink to this headline">¶</a></h3>
<p>If Arduino Due is going to be used, a special tool for flashing has to
be installed–this has to be built from source as the branch that
supports the Arduino Due hasn’t been merged into mainline as of
writing these instructions:</p>
<ol class="arabic">
<li><p class="first">Get the requiements and the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># sudo dnf install -y gcc-c++ wxGTK-devel
$ git clone https://github.com/shumatech/BOSSA.git bossac.git
$ cd bossac.git
$ git checkout -f 1.6.1-arduino-19-gae08c63
</pre></div>
</div>
</li>
<li><p class="first">Build and install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make bin/bossac
$ sudo install -o root -g root -m 0755 bin/bossac /usr/local/bin
</pre></div>
</div>
</li>
<li><p class="first">(optional) Create a fast RPM with <a class="reference internal" href="#fpm"><span class="std std-ref">FPM</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chmod 0755 bin/bossac
$ fpm  -n bossac -v $(git describe --tags) -s dir -t rpm bin/bossac
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="zephyr-sdk">
<span id="id4"></span><h3>4.7.2. Zephyr SDK<a class="headerlink" href="#zephyr-sdk" title="Permalink to this headline">¶</a></h3>
<p>To build some Zephyr OS apps/testcases or to flash certain hardware,
you will need this SDK:</p>
<ol class="arabic">
<li><p class="first">Download the Zephyr SDK from
<a class="reference external" href="https://www.zephyrproject.org/downloads/tools">https://www.zephyrproject.org/downloads/tools</a></p>
</li>
<li><p class="first">Install in <em>/opt/zephyr-sdk-VERSION</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chmod a+x zephyr-sdk-0.9.5-setup.run</span>
<span class="c1"># ./zephyr-sdk-0.9.5-setup.run -- -y -d /opt/zephyr-sdk-0.9.5</span>
</pre></div>
</div>
</li>
<li><p class="first">(optional) Create a fast RPM with <a class="reference internal" href="#fpm"><span class="std std-ref">FPM</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fpm -n zephyr-sdk-0.9.5 -v 0.9.5 \
&gt;     --rpm-rpmbuild-define &#39;_build_id_links alldebug&#39; \
&gt;     -s dir -C / -t rpm opt/zephyr-sdk-0.9.5
</pre></div>
</div>
<p><em>_build_id_links alldebug</em> is needed to disable generation of build
symlinks in <em>/usr/lib/.build-id</em>. Because the SDK packs a lot of
files that are similar/identical to those present in the system, it
will conflict.</p>
</li>
</ol>
</div>
<div class="section" id="arduino-builder-1-6-13">
<span id="arduino-builder"></span><h3>4.7.3. Arduino Builder 1.6.13<a class="headerlink" href="#arduino-builder-1-6-13" title="Permalink to this headline">¶</a></h3>
<p>The Arduino Builder will be needed by the TCF client to build <em>.ino</em>
files into appplications that can be flashed into targets for test.</p>
<ol class="arabic">
<li><p class="first">Download the Arduino IDE package from
<a class="reference external" href="https://www.arduino.cc/download_handler.php?f=/arduino-1.6.13-linux64.tar.xz">https://www.arduino.cc/download_handler.php?f=/arduino-1.6.13-linux64.tar.xz</a></p>
</li>
<li><p class="first">Extract:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tar xf arduino-1.6.13-linux64.tar.xz -C /opt</span>
</pre></div>
</div>
</li>
<li><p class="first">(optional) Create a fast RPM with <a class="reference internal" href="#fpm"><span class="std std-ref">FPM</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fpm -n tcf-arduino-builder-1.6.13 -v 1.6.13 -s dir -C / -t rpm opt/arduino-1.6.13/
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="tunslip6">
<h3>4.7.4. tunslip6<a class="headerlink" href="#tunslip6" title="Permalink to this headline">¶</a></h3>
<p><em>tunslip6</em> is used to create a SLIP interface for a QEMU virtual
machine and connecting it to a TAP interface. This code has been
floating around for different small OSes that also run in QEMU, so
there is a few versions.</p>
<p>The one we currently use is the one used by the Zephyr project at the
<em>net-tools</em> repository:</p>
<blockquote>
<div><a class="reference external" href="http://github.com/zephyrproject-rtos/net-tools">http://github.com/zephyrproject-rtos/net-tools</a></div></blockquote>
<p>which has added functionality to defer configuration to external
parties (<em>ttbd</em> in this case) and some strenghtening to deal with race
conditions.</p>
<ol class="arabic">
<li><p class="first">Clone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone http://github.com/zephyrproject-rtos/net-tools
</pre></div>
</div>
</li>
<li><p class="first">Build:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd net-tools
$ make tunslip6
# make install
</pre></div>
</div>
</li>
<li><p class="first">(optional) Create a fast RPM with <a class="reference internal" href="#fpm"><span class="std std-ref">FPM</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ install -m 0755 tunslip6 -D root/usr/bin/tunslip6
$ fpm -n tunslip6 -v $(git describe --always) -s dir -C root -t rpm usr/bin
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="xtensa-esp32">
<span id="id5"></span><h3>4.7.5. Xtensa ESP32<a class="headerlink" href="#xtensa-esp32" title="Permalink to this headline">¶</a></h3>
<p>In order to build (TCF client) and deploy/flash (ttbd server) for
ESP32 boards, you will need the <em>xtensa-esp32</em> SDK and the ESP-IDF
libraries:</p>
<ul>
<li><p class="first"><em>xtensa-esp32 SDK</em></p>
<ol class="arabic">
<li><p class="first">Download from
<a class="reference external" href="https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-1.22.0-59.tar.gz">https://dl.espressif.com/dl/xtensa-esp32-elf-linux64-1.22.0-59.tar.gz</a></p>
</li>
<li><p class="first">Extract to <em>/opt/xtensa-esp32-elf</em></p>
<p># tar xf xtensa-esp32-elf-linux64-1.22.0-59.tar.gz -C /opt</p>
</li>
<li><p class="first">Add to <em>/etc/environment</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ESPRESSIF_TOOLCHAIN_PATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">xtensa</span><span class="o">-</span><span class="n">esp32</span><span class="o">-</span><span class="n">elf</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first"><em>ESP-IDF</em>: This is Xtensa’s IOT framework that is used by Zephyr and others</p>
<ol class="arabic">
<li><p class="first">Clone to <em>/opt/esp-idf.git</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ rm -rf /opt/esp-idf.git
$ git clone --recursive https://github.com/espressif/esp-idf.git /opt/esp-idf.git
$ (cd /opt/esp-idf.git &amp;&amp; git checkout -f $(ESP_IDF_REV))
</pre></div>
</div>
</li>
<li><p class="first">Add to <em>/etc/environment</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ESP_IDF_PATH</span><span class="o">=/</span><span class="n">opt</span><span class="o">/</span><span class="n">esp</span><span class="o">-</span><span class="n">idf</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</li>
</ol>
</li>
</ul>
</div>
<div class="section" id="libcoap">
<h3>4.7.6. libcoap<a class="headerlink" href="#libcoap" title="Permalink to this headline">¶</a></h3>
<p>Use the following script to create the RPM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="p">::</span> <span class="n">sh</span>
</pre></div>
</div>
<blockquote>
<div><p># Use absolute dirs, libtool needs it
dir=$PWD/libcoap.git
rootdir=$PWD/root-libcoap.git</p>
<p>rm -rf $dir
git clone –recursive -b dtls <a class="reference external" href="https://github.com/obgm/libcoap.git">https://github.com/obgm/libcoap.git</a> $dir</p>
<p>rm -rf $rootdir
mkdir -p $rootdir</p>
<p>(cd $dir; ./autogen.sh)
sed -i ‘s|prefix = &#64;prefix&#64;|prefix = $(DESTDIR)/&#64;prefix&#64;|g’ $(find $dir/ext/tinydtls -iname Makefile.in)
(cd $dir; ./configure –disable-shared –disable-documentation –prefix=/usr)
make -C $dir all
make -C $dir DESTDIR=$rootdir install
rm -rf $rootdir/usr/share
ver=${ver:-$(git -C $dir describe –tags)}
fpm  -n libcoap -v $ver -s dir -t rpm -C $rootdir</p>
</div></blockquote>
<p>Invoke as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./mklibcoap.sh
</pre></div>
</div>
</div>
<div class="section" id="fpm-fast-package-manager">
<span id="fpm"></span><h3>4.7.7. FPM, fast package manager<a class="headerlink" href="#fpm-fast-package-manager" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">this is only optional and only needed if you are building
RPMs for distribution; please ignore otherwise</p>
</div>
<ol class="arabic">
<li><p class="first">Install dependencies, clone the code, build and install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo dnf install -y ruby-devel rpm-build
$ git clone https://github.com/jordansissel/fpm fpm.git
$ make -C fpm.git install
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="platform-firmware-bios-update-procedures">
<h2>4.8. Platform firmware / BIOS update procedures<a class="headerlink" href="#platform-firmware-bios-update-procedures" title="Permalink to this headline">¶</a></h2>
<div class="section" id="updating-the-serial-number-and-or-description-of-a-ftdi-serial-device">
<span id="fs2-serial-update"></span><h3>4.8.1. Updating the serial number and / or description of a FTDI serial device<a class="headerlink" href="#updating-the-serial-number-and-or-description-of-a-ftdi-serial-device" title="Permalink to this headline">¶</a></h3>
<p>These devices are used in multiple USB to serial dongles and embedded
in a number of devices, for example:</p>
<ul class="simple">
<li>Flyswatter JTAGs, which come all with the same serial number
(usually <em>FS20000</em>).</li>
<li>standalone dongles</li>
<li>MCU boards, embedded computers</li>
</ul>
<p>These usually come as USB vendor ID 0x0403, product ID starting with
0x6NNN.</p>
<p>When there are multiple FTDI devices that have the same serial number,
the system needs to be able to tell them apart, so we can flash a new
serial number in them, which we usually make match the target name, or
whatever is needed.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">this process should be done in a separate machine; if you
do it in a server with multiple of these devices
connected, the tool can’t tell them apart and might flash
the wrong device.</p>
</div>
<p>To flash a new serial number or descriptionusing <code class="docutils literal notranslate"><span class="pre">ftdi_eeprom</span></code> on
your laptop (<a class="reference external" href="https://www.ftdichip.com/Support/Utilities.htm#FT_PROG">Windows utility</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo dnf install -y libftdi-devel
$ cat &gt; file.conf &lt;&lt;EOF
vendor_id=0x0403
product_id=0x6010
serial=&quot;NEWSERIALNUMBER&quot;
use_serial=true
EOF
</pre></div>
</div>
<p>Now plug the USB cable to your server or laptop, making sure it is the
only one and run, as super user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ftdi_eeprom --flash-eeprom file.conf</span>
</pre></div>
</div>
<p>Reconnect it to have the system read the new serial number / description.</p>
<p>Notes:</p>
<blockquote>
<div><ul>
<li><p class="first">if you have the unit you are re-flashing connected to a USB
power switching hub (like a YKush), make sure to power it on and to
power off any other device that has a 0x0403/6010 USB vendor ID /
product ID code, which you can find with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb.py  | grep 0403:6010
  1-1.2.1      0403:6010 00  2.00  480MBit/s 0mA 2IFs (Acme Inc. Flyswatter2 Flyswatter2-galileo-04)
</pre></div>
</div>
</li>
<li><p class="first">make <em>NEWSERIALNUMBER</em> shorter if you receive this error
message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FTDI</span> <span class="n">eeprom</span> <span class="n">generator</span> <span class="n">v0</span><span class="o">.</span><span class="mi">17</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Intra2net</span> <span class="n">AG</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">libftdi</span> <span class="n">developers</span> <span class="o">&lt;</span><span class="n">opensource</span><span class="nd">@intra2net</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="n">opensource</span><span class="o">%</span><span class="mi">40</span><span class="n">intra2net</span><span class="o">.</span><span class="n">com</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">FTDI</span> <span class="n">read</span> <span class="n">eeprom</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">EEPROM</span> <span class="n">size</span><span class="p">:</span> <span class="mi">128</span>
<span class="n">Sorry</span><span class="p">,</span> <span class="n">the</span> <span class="n">eeprom</span> <span class="n">can</span> <span class="n">only</span> <span class="n">contain</span> <span class="mi">128</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">100</span> <span class="nb">bytes</span> <span class="k">for</span> <span class="n">your</span> <span class="n">strings</span><span class="p">)</span><span class="o">.</span>
<span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">short</span> <span class="n">your</span> <span class="n">string</span> <span class="n">by</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="nb">bytes</span>
<span class="n">FTDI</span> <span class="n">close</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p class="first">For <strong>Flyswatter2</strong> devices, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">product</span><span class="o">=</span><span class="s2">&quot;Flyswatter2&quot;</span>
</pre></div>
</div>
<p>to the configuration file so the product name is set to
<em>Flyswatter2</em>, needed for OpenOCD to find the device.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="updating-the-serial-number-and-or-description-of-a-cp210x-serial-device">
<span id="cp210x-serial-update"></span><h3>4.8.2. Updating the serial number and / or description of a CP210x serial device<a class="headerlink" href="#updating-the-serial-number-and-or-description-of-a-cp210x-serial-device" title="Permalink to this headline">¶</a></h3>
<p>Some hardware use serial-to-USB converters based on the CP210x series
by <a class="reference external" href="http://www.silabs.com/">Silicon Labs</a>.</p>
<p>If the serial number programed on it is not unique enough, it can be
programmed with the tool <code class="docutils literal notranslate"><span class="pre">cp120x-program</span></code>, available from
<a class="reference external" href="http://cp210x-program.sourceforge.net/">http://cp210x-program.sourceforge.net/</a>.</p>
<p>Once installed:</p>
<ol class="arabic">
<li><p class="first">identify the device to operate with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb | grep -i CP210x
Bus 002 Device 085: ID 10c4:ea60 Cygnal Integrated Products, Inc. CP210x UART Bridge / myAVR mySmartUSB light
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">your device might show differnt vendor or product ID and
strings, in such case, adjust your grepping.</p>
</div>
</li>
<li><p class="first">take the bus and device numbers (<cite>002/085</cite> in the example) and feed
it to the <cite>cp219x-program</cite> tool with the new serial number you
want:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cp210x-program -m 002/085 -w --set-serial-number &quot;NEWSERIALNUMBER&quot;</span>
</pre></div>
</div>
<p>it is always a good idea to set as new serial number the name of
the target it is going to be assigned to.</p>
</li>
<li><p class="first">Reconnect the device and verify the new serial number is set with
<code class="docutils literal notranslate"><span class="pre">lsusb.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lsusb.py -ciu
...
  2-2.4          10c4:ea60 00  1.10   12MBit/s 100mA 1IF  (Silicon Labs CP2102 USB to UART Bridge Controller esp32-39)
    2-2.4:1.0      (IF) ff:00:00 2EPs (Vendor Specific Class) cp210x ttyUSB0
..
</pre></div>
</div>
<p>in this case, we set <em>esp32-39</em> as new serial number, which is
displayed at the end of the line.</p>
</li>
</ol>
</div>
<div class="section" id="updating-the-firmware-in-an-arduino101-to-factory-settings">
<span id="a101-fw-upgrade"></span><h3>4.8.3. Updating the firmware in an Arduino101 to factory settings<a class="headerlink" href="#updating-the-firmware-in-an-arduino101-to-factory-settings" title="Permalink to this headline">¶</a></h3>
<p>This is needed to operate with Zephyr OS &gt; v1.5.0-349-gecf96d2, which
dropped support for the older Arduino101 Zephyr boot ROM.</p>
<ul>
<li><p class="first">Download from <a class="reference external" href="https://software.intel.com/en-us/node/675552">https://software.intel.com/en-us/node/675552</a> the
package <code class="docutils literal notranslate"><span class="pre">arduino101-factory_recovery-flashpack.tar.bz2</span></code> and
decompress to your home directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd
$ tar xf LOCATION/arduino101-factory_recovery-flashpack.tar.bz2
</pre></div>
</div>
</li>
<li><p class="first">Ensure your TTBD server is &gt;= v0.10 (dated 9/21/16 or later)</p>
</li>
<li><p class="first">Disable you Arduino101 target (to avoid it being used by other
automated runs) and acquire it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf disable arduino101-NN
$ tcf acquire arduino101-NN
</pre></div>
</div>
</li>
<li><p class="first">Flash the new Boot ROM and bootloader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf images-upload-set arduino101-NN \
  rom:$HOME/arduino101-factory_recovery-flashpack/images/firmware/FSRom.bin \
  bootloader:$HOME/arduino101-factory_recovery-flashpack/images/firmware/bootloader_quark.bin
</pre></div>
</div>
</li>
<li><p class="first">Release the target and enable it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf release arduino101-NN
$ tcf enable arduino101-NN
</pre></div>
</div>
</li>
<li><p class="first">Test with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd LOCATION/OF/ZEPHYR/KERNEL
$ export ZEPHYR_BASE=$PWD
$ tcf run -v -t arduino101-NN samples/hello_world
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="updating-the-firmware-in-an-quark-c1000-reference-boards">
<h3>4.8.4. Updating the firmware in an Quark C1000 reference boards<a class="headerlink" href="#updating-the-firmware-in-an-quark-c1000-reference-boards" title="Permalink to this headline">¶</a></h3>
<p>This updates to the QSMI v1.3 bootrom support, needed to operate with
Zephyr OS &gt; v1.5.0, which dropps support older ROMs.</p>
<ul>
<li><p class="first">Download from <a class="reference external" href="https://github.com/quark-mcu/qmsi/releases/tag/v1.3.0">https://github.com/quark-mcu/qmsi/releases/tag/v1.3.0</a> the
file <code class="docutils literal notranslate"><span class="pre">quark_se_rom-v1.3.0.bin</span></code> to your home directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://github.com/quark-mcu/qmsi/releases/download/v1.3.0/quark_se_rom.bin \
    -O ~/quark_se_rom-v1.3.0.bin
</pre></div>
</div>
</li>
<li><p class="first">Ensure your TTBD server is &gt;= v0.10 (dated 11/01/16 or later)</p>
</li>
<li><p class="first">Disable you Quark C1000 target (to avoid it being used by other
automated runs), maybe wait for no still-running jobs are using it
(use <cite>tcf list -v qc1000-NN</cite> to see if it is acquired by anyone):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf disable qc1000-NN
</pre></div>
</div>
</li>
</ul>
<p>For the actual flashing process, there is a list of steps that have to
be performed that are needed to wipe the flash and reset the board in
such a way that it puts it in a receptive state. This implies running
specific OpenOCD commands and modifying the way the OpenOCD driver
operates on the board to maintain those settings.</p>
<ol class="arabic">
<li><p class="first">Use the script <cite>tcf-qc1000-fw-upload.sh TARGETNAME FWFILE</cite> to
update the Boot ROM:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf-qc1000-fw-upload.sh qc1000-NN $HOME/quark_se_rom.bin
</pre></div>
</div>
<p>In case of failure, retry one or two times, as some commands get
stuck. If after the retries it still fails, it might be time to try
remediation steps as described below.</p>
</li>
<li><p class="first">Verify operation with running a Zephyr test case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd LOCATION/OF/ZEPHYR/KERNEL
$ export ZEPHYR_BASE=$PWD
$ tcf run -vat qc1000-NN  /usr/share/tcf/examples/test_healtcheck.py
</pre></div>
</div>
<p>Testcase should <cite>PASS</cite>. Note the <cite>-a</cite>, so TCF can use a disabled
target. If they fail and <cite>tcf console-read qc1000-NN</cite> reports
garbage instead of some ASCII text, it is possible board timings
are messed up. Go back to flashing the Boot ROM and maybe use the
remediation steps described below.</p>
</li>
<li><p class="first">Re-enable the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf enable qc1000-NN
</pre></div>
</div>
</li>
</ol>
<p>The process is thus concluced</p>
<div class="section" id="remediation-steps">
<h4>4.8.4.1. Remediation steps<a class="headerlink" href="#remediation-steps" title="Permalink to this headline">¶</a></h4>
<p>In some situations it has been seen that the stock OpenOCD version
distributed with the Zephyr SDK or most system cannot flash properly
the QC1000.</p>
<p>In said case, we can try with the ISSM version of OpenOCD:</p>
<ol class="arabic">
<li><p class="first">obtain the ISSM toolchain package for Linux from
<a class="reference external" href="https://software.intel.com/en-us/articles/issm-toolchain-only-download">https://software.intel.com/en-us/articles/issm-toolchain-only-download</a></p>
</li>
<li><p class="first">Install in your system in path opt with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tar xf PATH/TO/issm-toolchain-linux-2016-05-12-pub.tar.gz  -C /opt</span>
</pre></div>
</div>
</li>
<li><p class="first">Disable ISSM’s OpenOCD using a TCL port, otherwise the TCF server,
TTBD, will not be able to talk to it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sed -i &#39;s/tcl_port/#tcl_port/&#39; \</span>
  <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">issm</span><span class="o">-</span><span class="n">toolchain</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="mi">2016</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">12</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">debugger</span><span class="o">/</span><span class="n">openocd</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">board</span><span class="o">/</span><span class="n">quark</span><span class="o">*.</span><span class="n">cfg</span>
</pre></div>
</div>
</li>
<li><p class="first">Alter the TCF’s configuration of each QC1000 target to be updated
so it uses the OpenOCD from ISSM; in file
<cite>/etc/ttbd-production/conf_FILE.py</cite>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">quark_c1000_add</span><span class="p">(</span>
    <span class="s2">&quot;TARGETNAME&quot;</span><span class="p">,</span>
    <span class="n">serial_number</span> <span class="o">=</span> <span class="s2">&quot;SERIALNUMBER&quot;</span><span class="p">,</span>
    <span class="n">ykush_serial</span> <span class="o">=</span> <span class="s2">&quot;YKUSHHUBSERIALNUMBER&quot;</span><span class="p">,</span>
    <span class="n">ykush_port_board</span> <span class="o">=</span> <span class="n">YKUSHHUBPORT</span><span class="p">,</span>
    <span class="n">openocd_path</span> <span class="o">=</span> <span class="s2">&quot;/opt/issm-toolchain-linux-2016-05-12/tools/debugger/openocd/bin/openocd&quot;</span><span class="p">,</span>
    <span class="n">openocd_scripts</span> <span class="o">=</span> <span class="s2">&quot;/opt/issm-toolchain-linux-2016-05-12/tools/debugger/openocd/scripts&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Restart the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart ttbd@production</span>
</pre></div>
</div>
</li>
<li><p class="first">Run a healthcheck on the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf run -vat TARGETNAME  /usr/share/tcf/examples/test_healtcheck.py
</pre></div>
</div>
<p>In case of trouble, diagnose by looking at the <a class="reference internal" href="06-troubleshooting.html#systemd-tips-diagnosis"><span class="std std-ref">journal</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ journalctl -aeu ttbd@production
</pre></div>
</div>
</li>
</ol>
<ol class="arabic simple" start="6">
<li>Retry the firmware update script</li>
<li>Upon success, revert the configuration change and restart the server</li>
</ol>
</div>
</div>
<div class="section" id="updating-the-firmware-in-an-quark-d2000-reference-boards">
<span id="fw-update-d2000"></span><h3>4.8.5. Updating the firmware in an Quark D2000 reference boards<a class="headerlink" href="#updating-the-firmware-in-an-quark-d2000-reference-boards" title="Permalink to this headline">¶</a></h3>
<p>This is needed to operate with Zephyr OS.</p>
<ul>
<li><p class="first">Download from
<a class="reference external" href="https://github.com/quark-mcu/qm-bootloader/releases/tag/v1.3.0">https://github.com/quark-mcu/qm-bootloader/releases/tag/v1.3.0</a> the
file <code class="docutils literal notranslate"><span class="pre">quark_d2000_rom.bin</span></code> to your home directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://github.com/quark-mcu/qm-bootloader/releases/download/v1.4.0/quark_d2000_rom_fm_hmac.bin
</pre></div>
</div>
</li>
<li><p class="first">Ensure your TTBD server is &gt;= v0.10 (dated 9/21/16 or later)</p>
</li>
<li><p class="first">Disable you Quark D2000 target (to avoid it being used by other
automated runs) and acquire it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf disable qd2000-NN
$ tcf acquire qd2000-NN
</pre></div>
</div>
</li>
<li><p class="first">Flash the new Boot ROM and bootloader:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf images-upload-set qd2000-NN rom:quark_d2000_rom_fm_hmac.bin
</pre></div>
</div>
</li>
<li><p class="first">Release the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf release qd2000-NN
</pre></div>
</div>
</li>
<li><p class="first">Verify operation with running a Zephyr test case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  $ export ZEPHYR_BASE=LOCATION/OF/ZEPHYR/KERNEL
  $ tcf run -vat qd2000-NN  /usr/share/tcf/examples/test_healtcheck.py

Testcase should `PASS`. Note the `-a`, so TCF can use a disabled
target. If they fail and `tcf console-read qc1000-NN` reports
garbage instead of some ASCII text, it is possible board timings
are messed up. Go back to flashing the Boot ROM and maybe use the
remediation steps described below.
</pre></div>
</div>
</li>
<li><p class="first">Enable the target:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tcf enable qd2000-NN
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="updating-the-fpga-image-in-synopsys-emsk-boards">
<h3>4.8.6. Updating the FPGA image in Synopsys EMSK boards<a class="headerlink" href="#updating-the-fpga-image-in-synopsys-emsk-boards" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">You will need a Synopsys account; <a class="reference external" href="https://www.synopsys.com/cgi-bin/dwarcsw/req1.cgi">register</a> and wait for
them to accept you</p>
</li>
<li><p class="first">Use this account to <a class="reference external" href="https://www.synopsys.com/cgi-bin/dwarcsw/arcemsk/menu.cgi">download their newest firmware</a>. Currently
set to v2.2.</p>
</li>
<li><p class="first">Now download the <cite>Lab Tools 14.7</cite> or newer (You may have to create
a Xilinx account <a class="reference external" href="https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/design-tools.html">here</a>
to access this download)</p>
<p>If you need installation instruction you can find them here under
Appendix: C (page 86) of
<a class="reference external" href="https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf">https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf</a>
(important note, when running this it seems you have to use Windows
and the Impact 32 bit version. The 64 bit version seems to fail out
on certain steps you need to use).</p>
</li>
<li><p class="first">Now just go through the flashing instructions located on page 93
towards the bottom, called SPI Flash-Programming Sequence
<a class="reference external" href="https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf">https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf</a></p>
<p>If you need another resource the synopsys instructions can be found
here under (page 86) Appendix: C for installing the tools, and
(page 93 bottom) under SPI Flash-Programming Sequence.
<a class="reference external" href="https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf">https://www.embarc.org/pdf/ARC_EM_Starter_Kit_UserGuide.pdf</a></p>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>the switch configuration we are currently using is ARC_EM9D for the 9D model.</p>
<p>Here is the switch configuration for SW1 (bit 1 is switch one; bit 2 is switch 2)</p>
<table border="1" class="last docutils">
<colgroup>
<col width="23%" />
<col width="18%" />
<col width="59%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>Bit 1</td>
<td>Bit2</td>
<td>Configuration</td>
</tr>
<tr class="row-even"><td>OFF</td>
<td>OFF</td>
<td>ARC_EM7D</td>
</tr>
<tr class="row-odd"><td>ON</td>
<td>OFF</td>
<td>ARC_EM9D</td>
</tr>
<tr class="row-even"><td>OFF</td>
<td>ON</td>
<td>ARC_EM11D</td>
</tr>
<tr class="row-odd"><td>ON</td>
<td>ON</td>
<td>Reserved</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="creating-images-for-the-provisioning-os">
<span id="pos-image-creation"></span><h2>4.9. Creating images for the Provisioning OS<a class="headerlink" href="#creating-images-for-the-provisioning-os" title="Permalink to this headline">¶</a></h2>
<p>For provisioning using <a class="reference internal" href="09-api.html#module-tcfl.pos" title="tcfl.pos"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Provisioning</span> <span class="pre">OS</span></code></a>, images have
to be extracted and installed in the server (or an rsync server as
described in the <a class="reference internal" href="03-server-setup.html#ttbd-pos-deploying-images"><span class="std std-ref">setup guide</span></a>).</p>
<p>The images for provisioning are a flat root filesystem that is
rsync’ed by with <a class="reference internal" href="09-api.html#module-tcfl.pos" title="tcfl.pos"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tcfl.pos</span></code></a>.</p>
<p>Extracting them can be a little bit tricky, but there are different
methodologies that allow automating the process.</p>
<div class="section" id="linux-live-images">
<h3>4.9.1. Linux Live images<a class="headerlink" href="#linux-live-images" title="Permalink to this headline">¶</a></h3>
<p>When images are Linux Live filesystems, they can usually be extracted
easily, using the <a class="reference download internal" href="../_downloads/tcf-image-setup.sh" download=""><code class="xref download docutils literal notranslate"><span class="pre">/usr/share/tcf/tcf-image-setup.sh</span></code></a> script, which understands most Live
images.</p>
<p>See the <a class="reference internal" href="03-server-setup.html#ttbd-pos-deploying-images"><span class="std std-ref">examples</span></a>.</p>
</div>
<div class="section" id="linux-kickstart-images-using-qemu">
<span id="kickstart-install"></span><h3>4.9.2. Linux Kickstart images using QEMU<a class="headerlink" href="#linux-kickstart-images-using-qemu" title="Permalink to this headline">¶</a></h3>
<p>Linux distributions that can be installed via kickstart can use
<a class="reference download internal" href="../_downloads/kickstart-install.sh" download=""><code class="xref download docutils literal notranslate"><span class="pre">/usr/share/tcf/kickstart-install.sh</span></code></a>, which uses QEMU to run the
installation with a built in kickstart, creating a qcow2 file image
that then <em>tcf-image-setup.sh</em> can install.</p>
<p><em>kickstart-install.sh</em> creates a kickstart file in a drive that is
passed to the virtual machine, so there is no need for PXE servers. It
extracts the kernel and initrd from the ISO image as well.</p>
<p>See the <a class="reference internal" href="03-server-setup.html#ttbd-pos-deploying-images"><span class="std std-ref">examples</span></a>.</p>
</div>
<div class="section" id="manual-image-extraction-using-qemu">
<h3>4.9.3. Manual image extraction using QEMU<a class="headerlink" href="#manual-image-extraction-using-qemu" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">create a 20G virtual disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qemu-img create -f qcow2 ubuntu-18.10.qcow2 20G
$ qemu-img create -f qcow2 Fedora-Workstation-29.qcow2 20G
</pre></div>
</div>
</li>
<li><p class="first">Install using QEMU all with default options (click next). Power
off the machine when done instead of power cycling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qemu-system-x86_64 --enable-kvm -m 2048 -hdah ubuntu-18.10.qcow2 -cdrom ubuntu-18.10-desktop-amd64.iso
$ qemu-system-x86_64 --enable-kvm -m 2048 -hda Fedora-Workstation-29.qcow2 -cdrom Fedora-Workstation-Live-x86_64-29-1.2.iso
</pre></div>
</div>
<p>Key thing here is to make sure everything is contained in a
single partition (first partition).</p>
<p>For Ubuntu 18.10:</p>
<blockquote>
<div><ul class="simple">
<li>select install</li>
<li>select any language and keyboard layout</li>
<li>Normal installation</li>
<li>Erase disk and install Ubuntu</li>
<li>Create a user ‘Test User’, with any password</li>
<li>when asked to restart, restart, but close QEMU before it
actually starts again</li>
</ul>
</div></blockquote>
<p>For Fedora:</p>
<blockquote>
<div><ul class="simple">
<li>turn off networking</li>
<li>select install to hard drive</li>
<li>select english keyboard</li>
<li>select installation destination, “CUSTOM” storage configuration
&gt; DONE</li>
<li>Select Standard partition</li>
<li>Click on + to add a partition, mount it on /, 20G in size
(the system later will add boot and swap, we only want what goes
in the root partition).
Select DONE</li>
<li>Click BEGIN INSTALLATION</li>
<li>Click QUIT when done</li>
<li>Power off the VM</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Create image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ /usr/share/tcf/tcf-iamge-setup.sh ubuntu:desktop:18.10::x86_64 ubuntu-18.10.qcow2
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="05-RFAQs.html" class="btn btn-neutral float-right" title="5. Rationales and Frequently Asked Questions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="03-server-setup.html" class="btn btn-neutral" title="3. Server deployment guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Author

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'0.11',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>