

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Guides &mdash; Test Case Framework 0.11 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Test Case Framework 0.11 documentation" href="../index.html"/>
        <link rel="next" title="3. Server deployment guide" href="03-server-setup.html"/>
        <link rel="prev" title="1. Quickstart" href="../02-QUICKSTART.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../README.html" class="icon icon-home"> Test Case Framework
          

          
          </a>

          
            
            
              <div class="version">
                0.11
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../02-QUICKSTART.html">1. Quickstart</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuring-the-tcf-client">2.1. Configuring the TCF client</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuring-access-to-ttbd-servers">2.1.1. Configuring access to <em>ttbd</em> servers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-for-zephyr-os-development">2.1.2. Configuring for Zephyr OS development</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-for-arduino-sketch-development">2.1.3. Configuring for Arduino Sketch development</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-configuration-settings">2.1.4. Other configuration settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-test-cases-with-tcf-run">2.2. Running test cases with <em>tcf run</em></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-zephyr-os-testcases-and-samples">2.2.1. Running Zephyr OS testcases and samples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#options-to-tcf-run">2.2.2. Options to <em>tcf run</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#target-and-tag-filter-specifications">2.2.3. Target and tag filter specifications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examples-of-specifications">2.2.3.1. Examples of specifications</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#interpreting-the-output-of-tcf-run">2.2.4. Interpreting the output of <em>tcf run</em></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#creating-testcases">2.3. Creating testcases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#zephyr-os-s-hello-world">2.3.1. Zephyr OS’s <em>Hello World!</em></a></li>
<li class="toctree-l3"><a class="reference internal" href="#a-test-case-with-multiple-targets">2.3.2. A test case with multiple targets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connecting-to-network-ports">2.3.3. Connecting to network ports</a></li>
<li class="toctree-l3"><a class="reference internal" href="#network-test-cases">2.3.4. Network test cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="#capturing-tcpdumps-of-network-traffic">2.3.5. Capturing <em>tcpdumps</em> of network traffic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saving-data-and-files-to-a-location">2.3.6. Saving data and files to a location</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connecting-things">2.3.7. Connecting things</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testcase-training">2.4. Testcase training</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#a-basic-testcase">2.4.1. A basic testcase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-s-in-a-testcase">2.4.2. What’s in a testcase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#breaking-it-up">2.4.3. Breaking it up</a></li>
<li class="toctree-l3"><a class="reference internal" href="#give-me-a-target">2.4.4. Give me a target</a></li>
<li class="toctree-l3"><a class="reference internal" href="#give-me-a-target-that-can-run-zephyr">2.4.5. Give me a target that can run Zephyr</a></li>
<li class="toctree-l3"><a class="reference internal" href="#give-me-a-target-that-can-run-zephyr-and-is-x86">2.4.6. Give me a target that can run Zephyr and is x86</a></li>
<li class="toctree-l3"><a class="reference internal" href="#but-put-some-zephyr-into-it">2.4.7. But put some Zephyr into it?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#now-we-are-building-all-the-time-some-time-savers">2.4.8. Now we are building all the time, some time savers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#so-is-zephyr-booting">2.4.9. So, is Zephyr booting?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#and-is-the-code-doing-what-i-want-hello-world">2.4.10. And is the code doing what I want? Hello World?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#what-happens-when-it-fails-let-s-make-it-fail">2.4.11. What happens when it fails? Let’s make it fail</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-a-zephyr-sanity-check-testcase">2.4.12. Running a Zephyr sanity check testcase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#double-down">2.4.13. Double down</a></li>
<li class="toctree-l3"><a class="reference internal" href="#double-down-more-efficiently">2.4.14. Double down more efficiently</a></li>
<li class="toctree-l3"><a class="reference internal" href="#double-down-catchas">2.4.15. Double down catchas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#two-interconnected-targets">2.4.16. Two interconnected targets?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#networking-and-the-zephyr-echo-server">2.4.17. Networking and the Zephyr echo server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-on-the-zephyr-echo-client">2.4.18. Add on the Zephyr echo client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cover-more-bases-on-the-zephyr-echo-server-client">2.4.19. Cover more bases on the Zephyr echo server/client</a></li>
<li class="toctree-l3"><a class="reference internal" href="#but-let-s-test-zephyr-s-echo-server-client-better">2.4.20. But let’s test Zephyr’s echo server/client better</a></li>
<li class="toctree-l3"><a class="reference internal" href="#developing-zephyr-apps-with-the-tcf-s-help">2.4.21. Developing Zephyr apps with the TCF’s help</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#evolving-into-a-tc-test-case">2.4.21.1. Evolving into a TC test case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#evolving-into-a-ztest-test-case">2.4.21.2. Evolving into a ztest test case</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#change-of-pace-input-to-a-zephyr-test-case">2.4.22. Change of pace, input to a Zephyr test case</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fixme-missing">2.4.23. FIXME: Missing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#report-drivers">2.5. Report Drivers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-1-reporting-completion-of-testcase-execution">2.5.1. Example 1: reporting completion of testcase execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-2-reporting-failures">2.5.2. Example 2: reporting failures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#app-builders">2.6. App Builders</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overriding-actions">2.6.1. Overriding actions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#contributing">2.7. Contributing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#support-reporting-issues">2.7.1. Support &amp; reporting issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-tcf-client-from-the-source-tree">2.7.2. Running the TCF client from the source tree</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-tcf-server-ttbd-from-the-source-tree">2.7.3. Running the TCF server (ttbd) from the source tree</a></li>
<li class="toctree-l3"><a class="reference internal" href="#workflow-for-contributions">2.7.4. Workflow for contributions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="03-server-setup.html">3. Server deployment guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="04-HOWTOs.html">4. HOWTOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="05-RFAQs.html">5. Rationales and Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="06-troubleshooting.html">6. Support &amp; Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="07-Architecture.html">7. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="09-api.html">8. APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="10-Status.html">10. Current status and plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01-CHANGELOG.html">11. TCF release v0.11</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">Test Case Framework</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html">Docs</a> &raquo;</li>
        
      <li>2. Guides</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/doc/02-guides.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="guides">
<h1>2. Guides<a class="headerlink" href="#guides" title="Permalink to this headline">¶</a></h1>
<div class="section" id="configuring-the-tcf-client">
<span id="tcf-configuring"></span><span id="tcf-guide-configuration"></span><h2>2.1. Configuring the TCF client<a class="headerlink" href="#configuring-the-tcf-client" title="Permalink to this headline">¶</a></h2>
<p>The client looks for configuration files named <cite>conf_*.py</cite> in the
following directories:</p>
<ul class="simple">
<li><cite>.tcf/</cite> subdirectory of the current working directory</li>
<li><cite>~/.tcf/</cite>, a per-user configuration directory</li>
<li><cite>/etc/tcf/</cite>, a system wide configuration directory</li>
</ul>
<p>The <cite>conf_*.py</cite> files are parsed in alphabetical order, written in
plain Python code, so you can do anything, even extend TCF from
them. The module <a class="reference internal" href="09-api.html#module-tcfl.config" title="tcfl.config"><code class="xref py py-mod docutils literal"><span class="pre">tcfl.config</span></code></a> provides access to functions to
set TCF’s configuration.</p>
<div class="section" id="configuring-access-to-ttbd-servers">
<span id="tcf-config-servers"></span><h3>2.1.1. Configuring access to <em>ttbd</em> servers<a class="headerlink" href="#configuring-access-to-ttbd-servers" title="Permalink to this headline">¶</a></h3>
<p>Each server you have access to is described by its URL
<cite>https://HOSTNAME.DOMAIN:PORT</cite>, which can be passed to <code class="docutils literal"><span class="pre">tcf</span> <span class="pre">--url</span> <span class="pre">URL</span>
<span class="pre">&lt;COMMAND&gt;</span></code> or more conveniently, set in a configuration file with
<a class="reference internal" href="09-api.html#tcfl.config.url_add" title="tcfl.config.url_add"><code class="xref py py-func docutils literal"><span class="pre">tcfl.config.url_add()</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">tcfl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">url_add</span><span class="p">(</span><span class="s1">&#39;https://HOSTNAME.DOMAIN:PORT&#39;</span><span class="p">,</span> <span class="n">ssl_ignore</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>optionally an argument <em>aka = NAME</em> can be added to add a nickname for
the server (which defaults to <em>HOSTNAME</em>).</p>
<p>In multiple-instance deployments (infrastructure/production/staging),
most users only need access to the production server, so the following
AKAs are recommended:</p>
<ul class="simple">
<li><em>HOSTNAME</em>: production</li>
<li><em>HOSTNAMEi</em>: infrastructure</li>
<li><em>HOSTNAMEs</em>: staging</li>
</ul>
</div>
<div class="section" id="configuring-for-zephyr-os-development">
<span id="tcf-configure-zephyr"></span><h3>2.1.2. Configuring for Zephyr OS development<a class="headerlink" href="#configuring-for-zephyr-os-development" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the <em>tcf-zephyr</em> RPM already provides these settings for
<em>ZEPHYR_SDK_INSTALL_DIR</em>, <em>ZEPHYR_TOOLCHAIN_VARIANT</em> (and
<em>ZEPHYR_GCC_VARIANT</em> for &lt; v1.11 versions of Zephyr) in
<cite>/etc/tcf/config_zephyr.py</cite>, as well as an RPM installation
of the Zephyr SDK.</p>
</div>
<p>To work with Zephyr OS applications without having to set the
environment, a TCF configuration file <cite>conf_zephyr.py</cite> can be created
with these settings:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Set Zephyr&#39;s build environment (use .setdefault() to inherit</span>
<span class="c1"># existing values if present)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ZEPHYR_TOOLCHAIN_VARIANT&#39;</span><span class="p">,</span> <span class="s1">&#39;zephyr&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ZEPHYR_SDK_INSTALL_DIR&#39;</span><span class="p">,</span>
                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;/opt/zephyr-sdk-0.9.3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-for-arduino-sketch-development">
<span id="tcf-configure-sketch"></span><h3>2.1.3. Configuring for Arduino Sketch development<a class="headerlink" href="#configuring-for-arduino-sketch-development" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">installing the <em>tcf-sketch</em> RPM package will bring in
dependencies to build Arduino sketches that can be deployed
in MCUs (such as Arduino Builder v1.6.13).</p>
</div>
<p>The corresponding board support packages need to be manually setup
into the system using the Arduino IDE in a location that all users who
are going to need it can access:</p>
<ol class="arabic">
<li><p class="first">As your user, start the Arduino IDE and install the support
packages for the boards you will build for; in this case we only do
the Arduino Due and the Arduino 101:</p>
<ul class="simple">
<li>In the menu, select <cite>Tools &gt; Board (ANY) &gt; Boards Manager</cite></li>
<li>Search for <em>Arduino Due</em>, <em>Intel Curie Boards</em> (for <em>Arduino
101</em>) or any other boards you need support for</li>
<li>Install</li>
</ul>
</li>
<li><p class="first">Packages appear in <cite>~/.arduino15/packages</cite></p>
<p>Any other user that needs access to those board definitions has to
repeat those steps or copy those files. For example, for an
autobuilder such as Jenkins, those files would have to be copied to
the build slaves.</p>
</li>
<li><p class="first">Ensure the targets are configured to expose Sketch information by
declaring a tag:</p>
<ul class="simple">
<li><cite>sketch_fqbn</cite>: <cite>sam:1.6.9:arduino_due_x_dbg</cite> for Arduino Due</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="other-configuration-settings">
<h3>2.1.4. Other configuration settings<a class="headerlink" href="#other-configuration-settings" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Ignoring directory names when <a class="reference internal" href="09-api.html#tcfl.tc.tc_c.dir_ignore_add_regex" title="tcfl.tc.tc_c.dir_ignore_add_regex"><code class="xref py py-func docutils literal"><span class="pre">scanning</span> <span class="pre">for</span> <span class="pre">test</span> <span class="pre">cases</span></code></a>:</p>
<p>will tell the scanner to ignore any directory called <em>docANYTHING</em></p>
</li>
</ul>
</div>
</div>
<div class="section" id="running-test-cases-with-tcf-run">
<h2>2.2. Running test cases with <em>tcf run</em><a class="headerlink" href="#running-test-cases-with-tcf-run" title="Permalink to this headline">¶</a></h2>
<p><em>tcf run</em> builds and runs one or more testcases in one or more targets
(or in none if the testcase does not require any):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run
</pre></div>
</div>
<p>will recursively look for testcases from the current working directory
and try to run them in as many targets as possible. The scanner will
look for files that describe testcases:</p>
<blockquote>
<div><ul class="simple">
<li><em>test*.py</em> <a class="reference internal" href="#tcf-guide-tests"><span class="std std-ref">testcases</span></a> written in Python</li>
<li><em>testcase.ini</em> Zephyr Sanity Check test cases</li>
</ul>
</div></blockquote>
<p>it can also be pointed to one or more files or directories:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run ../test1.py sub/dir/1 bat/file/testcase.ini
</pre></div>
</div>
<p>for each testcase, if it needs targets, it evaluates which ones are
available (from the <a class="reference internal" href="#tcf-config-servers"><span class="std std-ref">configured *ttbd* servers</span></a>, filtered with <em>-t</em> command line options and
more filtering requirements the testcase might impose). Then it
decides in how many it has to run it based on:</p>
<ul class="simple">
<li>are we asking to run on any target, one of each type, or all</li>
<li>multiple random permutations of targets doing different roles that
satisfy the testcase’s specifications</li>
</ul>
<p>Each testcase and unique target (or group of targets) where it is
going to be run is assigned a unique 4 letter identifier (called
<em>HASH</em>) which is used to prefix all the messages regarding to it. This
is useful to grep in long logs of multiple testcases and targets.</p>
<p id="tcf-run-test-file-exists">Consider a simple testcase that checks if there is a file called
<em>thisfile</em> in the current working directory (and thus requires no
targets):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017 Intel Corporation</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>
<span class="c1"># pylint: disable = missing-docstring</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;testfile&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: exists! test passes&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: does not exist&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>we run it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run /usr/share/tcf/examples/test_file_exists.py
FAIL0/2kdb    /usr/share/tcf/examples/test_file_exists.py#_test @local: evaluation failed
FAIL0/        toplevel @local: 1 tests (0 passed, 1 failed, 0 blocked, 0 skipped) - failed
/tmp/tcf-Dw7AGw.mk:2: recipe for target &#39;tcf-jobserver-run&#39; failed
make: *** [tcf-jobserver-run] Error 1
</pre></div>
</div>
<p>you can ignore the messages from <em>make</em>, they just say <em>tcf</em> returned
with an error code–because a testcase failed, as the file <em>thisfile</em>
doesn’t exist; if you add more <em>-v</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv /usr/share/tcf/examples/test_file_exists.py
INFO2/        toplevel @local: scanning for test cases
INFO2/2kdb    /usr/share/tcf/examples/test_file_exists.py#_test @local: will run on target group &#39;local&#39;
FAIL2/2kdbE#1 /usr/share/tcf/examples/test_file_exists.py#_test @local: eval failed: file &#39;testfile&#39;: does not exist
FAIL0/2kdb    /usr/share/tcf/examples/test_file_exists.py#_test @local: evaluation failed
FAIL0/        toplevel @local: 1 tests (0 passed, 1 failed, 0 blocked, 0 skipped) - failed
</pre></div>
</div>
<p><em>tcf</em> is shy by default, it will only print about something having
failed. See below for a more detailed <a class="reference internal" href="#tcf-run-output-groking"><span class="std std-ref">description</span></a> of the output.</p>
<p>Note the <a class="reference internal" href="09-api.html#tc-id"><span class="std std-ref">*HASH*</span></a>, in this case <em>2kdb</em>, which uniquely
identifies the testcase/local-target combination. If the testcase
fails, a <em>report-HASH.txt</em> file is created with failure information
and instructions for reproduction.</p>
<p>Let’s create <em>testfile</em>, so the test passes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ touch testfile
$ tcf run /usr/share/tcf/examples/test_file_exists.py
PASS0/  toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>If some error happens while running the testcase (network connection
failure, or bug in the testcase code), the testcase will be <em>blocked</em>;
to diagnose why, add <em>-v</em>’s or look at the logfile (if <em>–logfile</em> was
given) for all the details; let’s copy the example and introduce a
Python error:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cp /usr/share/examples/test_file_exists.py .
$ echo error &gt;&gt; test_file_exists.py
$ tcf run test_file_exists.py
BLCK0/        test_file_exists.py @local: blocked: Cannot import: name &#39;error&#39; is not defined (NameError)
E tc.testcases_discover():4484: WARNING! No testcases found
BLCK0/        toplevel @local: 0 tests (0 passed, 0 failed, 0 blocked, 0 skipped) - / nothing ran
</pre></div>
</div>
<div class="section" id="running-zephyr-os-testcases-and-samples">
<h3>2.2.1. Running Zephyr OS testcases and samples<a class="headerlink" href="#running-zephyr-os-testcases-and-samples" title="Permalink to this headline">¶</a></h3>
<p>Because we installed the <em>tcf-zephyr</em> package, it brings the
dependencies needed to run Zephyr OS testcases and samples; let’s run
Zephyr OS’s <em>Hello World</em> sample:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git clone http://github.com/zephyrproject-rtos/zephyr
$ cd zephyr
$ export ZEPHYR_BASE=$PWD
$ tcf run /usr/share/tcf/examples/test_zephyr_hello_world.py
PASS0/  toplevel @local: 7 tests (7 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>This will now build the Zephyr OS’s <em>Hello World</em> sample app for as
many different Zephyr OS capable targets as it might find, try to run
it there and verify it got the “Hello World!” string back. Note this
might involve a lot of compilation based on how many targets you can
access and it will take more or less based on your machine’s power.</p>
</div>
<div class="section" id="options-to-tcf-run">
<h3>2.2.2. Options to <em>tcf run</em><a class="headerlink" href="#options-to-tcf-run" title="Permalink to this headline">¶</a></h3>
<p>There are many options to <em>tcf run</em> which you can find with <em>tcf run
–help</em>; here is a summary of the most frequent ones:</p>
<ul>
<li><p class="first"><strong>-v</strong> Increases the verbosity of the console output, can be
repeated for more information</p>
</li>
<li><p class="first"><strong>-i</strong> adds a <cite>Run ID</cite> (<code class="docutils literal"><span class="pre">-i</span> <span class="pre">RUNID</span></code>), which will be prefixed in
most messages and reports; it’ll also generate a logfile called
<code class="docutils literal"><span class="pre">RUNID.log</span></code> with lots of low-level details about the
process. Failure reports will be created in files called
<code class="docutils literal"><span class="pre">report-RUNID:HASH.txt</span></code>, where <cite>HASH</cite> is the code that uniquely
identifies the test case name and the target where it ran.</p>
<p>This is very useful when running <em>tcf</em> from a continuous integration
engine, such as Jenkins, to identify the reports and runs.</p>
</li>
<li><p class="first"><strong>–log-file LOGDILE</strong> file to which to dump the log</p>
</li>
<li><p class="first"><strong>–logdir LOGDIR</strong> directory where to place the log and failure report
files.</p>
</li>
<li><p class="first"><strong>-y</strong>: just run once on any target that is available and suitable;
there is also <strong>-U</strong> to run only in one target of each type and
<strong>-u</strong> to run on every target, plus a more detailed explanation
<a class="reference internal" href="09-api.html#tcf-target-modes"><span class="std std-ref">here</span></a>.</p>
</li>
</ul>
<span id="tcf-target-specs"></span><ul id="target-specification">
<li><p class="first"><strong>-t</strong> allows <em>tcf run</em> to filter which targets are available to
select when determining where to run; see <a class="reference internal" href="#tcf-evaluation-expressions"><span class="std std-ref">specifications</span></a>.</p>
</li>
<li><p class="first"><strong>-s</strong> allows <em>tcf run</em> to filter which testcases are to be run; see
<a class="reference internal" href="#tcf-evaluation-expressions"><span class="std std-ref">specifications</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -s slow
</pre></div>
</div>
<p>This selects all testcases that have a <em>slow</em> tag; to select
testcases that don’t sport the <em>slow</em> tag:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -s &quot;not slow&quot;
</pre></div>
</div>
<p>you can also select a tag by value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -s &#39;slow == &quot;very&quot;&#39;
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="target-and-tag-filter-specifications">
<span id="tcf-evaluation-expressions"></span><h3>2.2.3. Target and tag filter specifications<a class="headerlink" href="#target-and-tag-filter-specifications" title="Permalink to this headline">¶</a></h3>
<p>TCF incorporates a simple expression language parser to allows to
express boolean filters to select targets and tags in a programatic
way, such as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span> <span class="ow">and</span> <span class="n">bsp</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;x86&#39;</span><span class="p">,</span> <span class="s1">&#39;arm&#39;</span> <span class="p">]</span>
</pre></div>
</div>
<p>and is used by <em>tcf run</em>’s <em>-t</em> and <em>-s</em> options, to select targets
and testcases, respectively. As well, testcases can use in the
<a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.target()</span></code></a> and <a class="reference internal" href="09-api.html#tcfl.tc.interconnect" title="tcfl.tc.interconnect"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.interconnect()</span></code></a> decorators to
select tags.</p>
<p>The grammar is formally defined in <a class="reference internal" href="09-api.html#module-commonl.expr_parser" title="commonl.expr_parser"><code class="xref py py-mod docutils literal"><span class="pre">commonl.expr_parser</span></code></a>, but in
general an valid expressions are:</p>
<ul class="simple">
<li><em>symbol</em></li>
<li><em>symbol operator CONSTANT</em></li>
<li><em>symbol in [ CONTANT1, CONSTANT2 … ]</em></li>
<li><em>[not] ( [not] expresion1 and|or [not] expression2 )</em></li>
<li>operators are <em>and</em>, <em>or</em>, <em>not</em>, ==, !=, &lt;, &gt;, &gt;= and &lt;=</li>
<li>Python regex matching can be done with <em>:</em></li>
</ul>
<p>For targets, the target’s name and full IDs are made symbols that
evaluate as True; other symboles added are the active <a class="reference internal" href="glossary.html#term-bsp-model"><span class="xref std std-term">BSP
model</span></a> and (if any) active BSP are also made symbols, so for given a
target named <em>z3</em> with the following tags:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf list -vvv z3
  https://SERVER:5000/ttb-v0/targets/z3
    ...
    fullid: SERVER/z3
    id: z3
    consoles: [u&#39;arm&#39;]
    fullid: https://SERVER:5000/z3
    owner: None
    bsps: {
      u&#39;arm&#39;: {
        u&#39;console&#39;: u&#39;arm&#39;,
        u&#39;zephyr_board&#39;: u&#39;qemu_cortex_m3&#39;,
        u&#39;zephyr_kernelname&#39;: u&#39;zephyr.elf&#39;,
      }
    }
    ....
</pre></div>
</div>
<p>The following expressions could be used to match it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>- ``bsp == &#39;arm&#39;``
- ``z3 or z1``
- ``zephyr_board in [ &#39;qemu_cortex_m3&#39;, &#39;frdm_k64f&#39; ]``
</pre></div>
</div>
<p>The same system applies for tag; the tag itself is a symbol that
evaluates to true if available. It’s contents are available for
matching.</p>
<div class="section" id="examples-of-specifications">
<h4>2.2.3.1. Examples of specifications<a class="headerlink" href="#examples-of-specifications" title="Permalink to this headline">¶</a></h4>
<p>these examples can be passed to <em>tcf run -t</em> or <a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.target()</span></code></a>
and <a class="reference internal" href="09-api.html#tcfl.tc.interconnect" title="tcfl.tc.interconnect"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.interconnect()</span></code></a> in their <em>spec</em> parameter:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;type == &quot;arduino101&quot;&#39;</span>
</pre></div>
</div>
<p>filters to any target that declare’s its type is <em>Arduino 101</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;bsp == &quot;x86&quot;&#39;</span>
</pre></div>
</div>
<p>any target (and <a class="reference internal" href="glossary.html#term-bsp-model"><span class="xref std std-term">BSP model</span></a> of said target) that sports an x86
BSP–if the target supports multiple BSPs and BSP models, then it will
select all the BSP models that expose at least an ‘x86’ BSP):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;zephyr_board : &quot;quark_.*&quot;&#39;</span>
</pre></div>
</div>
<p>this selects any target that contains a BSP that exposes a
<em>zephyr_board</em> tag whose content matches the Python regex <em>quark_.*</em>;
this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;bsp == &quot;x86&quot; or bsp == &quot;arm&quot;&#39;</span>
<span class="s1">&#39;bsp in [ &quot;x86&quot;, &quot;arm&quot; ]&#39;</span>
</pre></div>
</div>
<p>would run on any target that contains a BSP that declares itself as
<em>x86</em> or <em>ARM</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;TARGETNAME&#39;</span>
</pre></div>
</div>
<p>would match a target called <em>TARGETNAME</em> (in any server):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;server/TARGETNAME&#39;</span>
</pre></div>
</div>
<p>would match <em>TARGETNAME</em> on server <em>server</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;nwa or qz31a or ql06a&#39;</span>
</pre></div>
</div>
<p>This will allow only to run in network <em>nwa</em> and in targets <em>qz31a</em>
and <em>ql06a</em>; this effectively limits the testcase to run only in
permutations of targets that fit those limitations.</p>
</div>
</div>
<div class="section" id="interpreting-the-output-of-tcf-run">
<span id="tcf-run-output-groking"></span><h3>2.2.4. Interpreting the output of <em>tcf run</em><a class="headerlink" href="#interpreting-the-output-of-tcf-run" title="Permalink to this headline">¶</a></h3>
<p>In an output such as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv -t local/qz39c-arm test_zephyr_hello_world.py
INFO2/        toplevel @local: scanning for test cases
INFO2/n9gc    test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: will run on target group &#39;xqkw (target=local/qz39c-arm:arm)&#39;
PASS1/n9gc    test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: configure passed
PASS1/n9gc    test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: build passed
PASS2/n9gc    test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: deploy passed
INFO2/n9gcE#1 test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: Reset
PASS2/n9gcE#1 test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: found expected `Hello World! arm` in console `default` at 0.03s
PASS2/n9gcE#1 test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: eval pass: found expected `Hello World! arm` in console `default` at 0.03s
PASS1/n9gc    test_zephyr_hello_world.py#_test @local/qz39c-arm:arm: evaluation passed
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>FIXME: verify</p>
<p>Note the columns and the messages:</p>
<ul>
<li><p class="first"><em>INFO</em>, information, <em>PASS</em>, <em>FAIL</em>, <em>BLCK</em>, something passed,
failed to pass or an error/condition disallows the system from
telling if there is a <em>PASS</em> or a <em>FAIL</em>; all followed by a number
that indicates the depth ofthe message (0 most general, 1 more
detailed, 2 more verbose, etc)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">/XYZW[CBDEL].NN</span></code>, the message ID. this <strong>four</strong> character code is
a unique identifier of the test case name and when it applies of the
testcase name and the name of the target where it is being ran along
with its <a class="reference internal" href="glossary.html#term-bsp-model"><span class="xref std std-term">BSP model</span></a>. It stays stable across different runs. The
letters <code class="docutils literal"><span class="pre">CBDEL</span></code> describe which phase it us running (Configure,
Build, Deploy, Evaluation, cLean), followed by the step number when
they are being executed. Each <cite>&#64;build</cite> command in the markup
description would be a different step; such would it be each <cite>&#64;eval</cite>
markup for evaluation.</p>
<p>What is this useful for? Well, you can ask the system to generate a
log file (using <cite>–log-file FILE.log</cite>) and just let it print the
most high level information to the console. The log has <em>way</em> more
information than you would ever care for, but when something fails,
grep for the message ID in the logfile (for example, if the build
had failed, <code class="docutils literal"><span class="pre">grep</span> <span class="pre">33afB</span> <span class="pre">FILE.log</span></code> would give you the full build
output for you to determine what is wrong. It is also passed to the
server, so we can identify what the target was doing when.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">TCF also generates reports when something fails (look for
<code class="docutils literal"><span class="pre">report-MSGID.txt</span></code>) with all that detailed information.</p>
</div>
</li>
<li><p class="first">Testcase name, target name and <a class="reference internal" href="glossary.html#term-bsp-model"><span class="xref std std-term">BSP model</span></a>.</p>
</li>
<li><p class="first">A message indicating what happened</p>
</li>
</ul>
</div>
</div>
<div class="section" id="creating-testcases">
<span id="tcf-guide-tests"></span><h2>2.3. Creating testcases<a class="headerlink" href="#creating-testcases" title="Permalink to this headline">¶</a></h2>
<p>Most of the testcases use the APIs provided with <a class="reference internal" href="09-api.html#tcfl.tc.tc_c" title="tcfl.tc.tc_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.tc.tc_c</span></code></a>
and <a class="reference internal" href="09-api.html#tcfl.tc.target_c" title="tcfl.tc.target_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.tc.target_c</span></code></a>, plus any other Python module library.</p>
<p>Going back to the very simple testcase used <a class="reference internal" href="#tcf-run-test-file-exists"><span class="std std-ref">here</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017 Intel Corporation</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>
<span class="c1"># pylint: disable = missing-docstring</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;testfile&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: exists! test passes&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: does not exist&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>this is a testcase that just checks for a file existing in the local
directory. It inherits from <a class="reference internal" href="09-api.html#tcfl.tc.tc_c" title="tcfl.tc.tc_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.tc.tc_c</span></code></a> to create a
testcase:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
</pre></div>
</div>
<p>this providing the basic glue to the meta test runner. The class can
be name whatever suits your needs.</p>
<p>Note this testcase declares no targets; it is an <em>static</em> testcase,
which evaluates by running on the local system with an <em>eval()</em>
function:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>   <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>       <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;testfile&quot;</span>
<span class="gp">&gt;&gt;&gt; </span>       <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>           <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: exists! test passes&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>       <span class="k">else</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>           <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;file &#39;</span><span class="si">%s</span><span class="s2">&#39;: does not exist&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>Multiple evaluation functions may be specified, as long as they are
called <em>evalSOMETHING</em>. You could add:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="bp">self</span><span class="o">.</span><span class="n">shcmd_local</span><span class="p">(</span><span class="s2">&quot;cat /etc/passwd&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>this would use <a class="reference internal" href="09-api.html#tcfl.tc.tc_c.shcmd_local" title="tcfl.tc.tc_c.shcmd_local"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.tc_c.shcmd_local()</span></code></a> to run a system
command. If it fails, it will raise a <a class="reference internal" href="09-api.html#tcfl.tc.failed_e" title="tcfl.tc.failed_e"><code class="xref py py-exc docutils literal"><span class="pre">tcfl.tc.failed_e</span></code></a>
exception that will fail the testcase. When running again, it will run
both functions in <em>alphabetical</em> order. For the testcase to pass, both
functions have to pass.</p>
<p>Running the modified version:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cp /usr/share/tcf/examples/test_file_exists.py .
# Edit test_file_exists.py to add eval_2
$ tcf run -vv test_file_exists.py
INFO2/        toplevel @local: scanning for test cases
INFO2/ryvi    test_file_exists.py#_test @local: will run on target group &#39;local&#39;
FAIL2/ryviE#1 test_file_exists.py#_test @local: eval failed: file &#39;testfile&#39;: does not exist
FAIL0/ryvi    test_file_exists.py#_test @local: evaluation failed
FAIL0/        toplevel @local: 1 tests (0 passed, 1 failed, 0 blocked, 0 skipped) - failed
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ignore git errors/warnings, they are harmless and is a
known issue.</p>
</div>
<p>It fails because the file <em>testfile</em> does not exist; <em>eval()</em> comes
before <em>eval_02()</em> in alphabetical order, so it is run first. As soon
as it fails the testcase execution is terminated, so <em>eval_2()</em> never
gets to run.</p>
<p>Create <em>testfile</em> in the local directory and re-run it, so <em>eval()</em>
passes and <em>eval_2()</em> also runs:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ touch testfile
INFO2/        toplevel @local: scanning for test cases
INFO2/ryvi    test_file_exists.py#_test @local: will run on target group &#39;local&#39;
INFO2/ryviE#1 test_file_exists.py#_test @local: file &#39;testfile&#39;: exists! test passes
PASS2/ryviE#1 test_file_exists.py#_test @local: eval passed: &#39;cat /etc/passwd&#39; @test_file_exists.py:14
PASS1/ryvi    test_file_exists.py#_test @local: evaluation passed
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>that <em>E#1</em>? those are messages relative to the <em>E</em>valuation phase; the
number means the index of the evaluation. We can ask <em>tcf run</em> to
repeat the evaluation two times adding <em>-r 2</em>.</p>
<div class="section" id="zephyr-os-s-hello-world">
<h3>2.3.1. Zephyr OS’s <em>Hello World!</em><a class="headerlink" href="#zephyr-os-s-hello-world" title="Permalink to this headline">¶</a></h3>
<p>Let’s move on now to testcases that use targets, using the Zephyr OS
as a test subject. Ensure the <em>tcf-zephyr</em> package was installed (with
<em>dnf install -y tcf-zephyr</em>) and clone the Zephyr OS (or used an
existing cloned tree):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span># dnf install -y tcf-zephyr   # If not yet installed
$ git clone http://github.com/zephyrproject-rtos/zephyr
$ cd zephyr
$ export ZEPHYR_BASE=$PWD
</pre></div>
</div>
<p>This is a very simple test case that cheks that the target where it
runs prints <em>Hello World!</em>; :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017 Intel Corporation</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># We don&#39;t care for documenting all the interfaces, names should be</span>
<span class="c1"># self-descriptive:</span>
<span class="c1">#</span>
<span class="c1"># - pylint: disable = missing-docstring</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>

<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="o">**</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">zephyr_tags</span><span class="p">())</span>
<span class="c1"># Ask for a target that defines an zephyr_board field, which indicates</span>
<span class="c1"># it can run the Zephyr OS</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;hello_world&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;Hello World! </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>running it on whichever suitable target (<em>-y</em>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cp /usr/share/tcf/examples/test_zephyr_hello_world.py .
$ tcf run -vvy test_zephyr_hello_world.py
INFO2/        toplevel @local: scanning for test cases
INFO2/9orv    test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: will run on target group &#39;ixgq (target=server2/arduino2-01:arm)&#39;
PASS2/9orv    test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: configure passed
PASS1/9orv    test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: build passed
PASS2/9orv    test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: deploy passed
INFO2/9orvE#1 test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: Reset
PASS2/9orvE#1 test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: found expected `Hello World! arm` in console `default` at 1.23s
PASS2/9orvE#1 test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: eval pass: found expected `Hello World! arm` in console `default` at 1.23s
PASS1/9orv    test_zephyr_hello_world.py#_test @server2/arduino2-01:arm: evaluation passed
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>This testcase:</p>
<ul>
<li><p class="first">declares it needs a target on which to run with the
<a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.target()</span></code></a> class decorator, which by default will be
called <em>target</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>                                          <span class="s2">&quot;samples/hello_world&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>the target will need to satisfy the <a class="reference internal" href="#target-specification"><span class="std std-ref">specification</span></a> given in the first parameter (<em>spec</em>) which
requires it exposes a tag <em>zephyr_board</em> (which indicates it can run
Zephyr Apps and gives the name of board for the Zephyr’s build
system with the <em>BOARD</em> parameter).</p>
</li>
<li><p class="first">the target will be loaded with a Zephyr app which is available in
<em>$ZEPHYR_BASE/samples/hello_world</em>. Note how <em>ZEPHYR_BASE</em> is defined,
instead of pulling it out straight from the environment with
<em>os.environ[ZEPHYR_BASE]</em>–this makes it easier to tell when the
testcase is ignored because <em>ZEPHYR_BASE</em> is not defined.</p>
<p><em>app_zephyr</em> is a plugin that indicates <em>tcf</em> how to build
applications for different environments, how to load them into
targets and how to start the targets.</p>
</li>
<li><p class="first">creates an evaluation function to be ran during the evaluation phase:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;Hello World! </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">bsp_model</span><span class="p">)</span>
</pre></div>
</div>
<p>This function is passed arguments that represent the targets it has
to operate on. Because we only declared a single target with
<a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.target()</span></code></a> and we didn’t specify a name with the
<em>name</em> argument, it defaults to <em>target</em> (if you pass an argument
that cannot be recognized like the name of a declared target, it
will error out).</p>
<p>For evaluating, we use <a class="reference internal" href="09-api.html#tcfl.tc.target_c.expect" title="tcfl.tc.target_c.expect"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.expect()</span></code></a> which
expects to receive in the target’s console the string <em>Hello World!
BSPMODEL</em>; the <a class="reference internal" href="glossary.html#term-bsp-model"><span class="xref std std-term">BSP model</span></a> describes in which mode we are running
the target when it has multiple cores/BSPs incorporated (such as the
<em>Arduino 101</em>, which includes an <em>x86</em> and <em>arc</em> BSPs).</p>
<p>So for a target with an ARM BSP declared on its tags, it will expect
to receive <em>Hello World! ARM</em>; if the string is received, the
function returns and the testcase is considered to pass. Otherwise,
it raises a failure exception <a class="reference internal" href="09-api.html#tcfl.tc.failed_e" title="tcfl.tc.failed_e"><code class="xref py py-exc docutils literal"><span class="pre">tcfl.tc.failed_e</span></code></a>, which is used
by the test runner to mark the test case as a failure. If any other
exception is raised (or <a class="reference internal" href="09-api.html#tcfl.tc.blocked_e" title="tcfl.tc.blocked_e"><code class="xref py py-exc docutils literal"><span class="pre">tcfl.tc.blocked_e</span></code></a>), the meta test
runner will consider the test blocked.</p>
</li>
</ul>
</div>
<div class="section" id="a-test-case-with-multiple-targets">
<h3>2.3.2. A test case with multiple targets<a class="headerlink" href="#a-test-case-with-multiple-targets" title="Permalink to this headline">¶</a></h3>
<p>Consider the following made up test case, where we have two Zephyr
applications in two subdirectories of where the testcase file is
located. They are a simple (and fake) apps that allow one board to
connect to another (for simplicity of argument, we’ll omit how they
connect).</p>
<p>Declare the need for two Zephyr OS capable targets that are
interconnected and indicate where to go to build the sources for them:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span> <span class="n">app_zephyr</span> <span class="o">=</span> <span class="s2">&quot;node1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span> <span class="n">app_zephyr</span> <span class="o">=</span> <span class="s2">&quot;node0&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
</pre></div>
</div>
<p>Setup some hooks – if when receiving from the console on any target
it prints a fatal fault, fail the test (this will be evaluated when
calling <a class="reference internal" href="09-api.html#tcfl.tc.target_c.expect" title="tcfl.tc.target_c.expect"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.expect()</span></code></a> or the full testcase expect
loop calling <a class="reference internal" href="09-api.html#tcfl.expecter.expecter_c.run" title="tcfl.expecter.expecter_c.run"><code class="xref py py-meth docutils literal"><span class="pre">run()</span></code></a> on
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.expecter" title="tcfl.tc.tc_c.expecter"><code class="xref py py-attr docutils literal"><span class="pre">tcfl.tc.tc_c.expecter</span></code></a></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="s2">&quot;FAILURE&quot;</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="s2">&quot;FAILURE&quot;</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>When the evaluation phase is to start, power cycle the interconnect
(to ensure it is fresh). Note we don’t do such with the Zephyr
targets, as the <em>app_zephyr</em> plugin has inserted two <em>start()</em>
functions to do it for us. Why? because he knows how to do start them
better (as some boards might lose the flashed image if we power cycle
them). It is possible to <a class="reference internal" href="#tcf-guide-app-builder-override"><span class="std std-ref">override</span></a> the default actions that
<em>app_zephyr</em> (and other Application Builders introduce).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
</pre></div>
</div>
<p>Now we are going to wait for both targets to boot and report readiness</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval_0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;I am ready&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;target ready&quot;</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;I am ready&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;target1 ready&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we are going to do the actual connection test by requesting
<em>target</em> to connect to <em>target1</em> and then <em>target1</em> is told to  to
accept the connection request–note each target exposes its address in
the network in a tag called <em>address</em> – we can use
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.kws" title="tcfl.tc.target_c.kws"><code class="xref py py-attr docutils literal"><span class="pre">tcfl.tc.target_c.kws</span></code></a> to format messages:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval_3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;connect to </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target1</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;connecting to </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target1</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;connect request from </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;connect accept from </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="go">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;accepted connect from </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;connected to </span><span class="si">%(address)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target1</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we wait for both targets to print a heartbeat that they emit
every five seconds–if we have to wait more than ten seconds for both
heartbeats, it will consider it a failure:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">eval_4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;heartbeat #[0-9]+ ok&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">target1</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;heartbeat #[0-9]+ ok&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="bp">self</span><span class="o">.</span><span class="n">expecter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="09-api.html#tcfl.tc.tc_c.expecter" title="tcfl.tc.tc_c.expecter"><code class="xref py py-attr docutils literal"><span class="pre">tcfl.tc.tc_c.expecter</span></code></a> is a generic expectation loop to
which anything can be attach to poll and check while the loop
runs. It will run until all the things it has been asked to expect
have ocurred or fail with a timeout.</p>
<p>It can be also used with context managers:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>   <span class="k">def</span> <span class="nf">eval_5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">times</span> <span class="o">=</span> <span class="mi">4</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">with</span> <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx_cm</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;heartbeat #[0-9]+ failure&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>                                    <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;do_some_lengthy_operation&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">target1</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;do_some_lengthy_operation&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;completed&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">target1</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;completed&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="bp">self</span><span class="o">.</span><span class="n">expecter</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>APIs <a class="reference internal" href="09-api.html#tcfl.tc.target_c.expect" title="tcfl.tc.target_c.expect"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.expect()</span></code></a> and <a class="reference internal" href="09-api.html#tcfl.tc.target_c.wait" title="tcfl.tc.target_c.wait"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.wait()</span></code></a>
are an example of doing something similar to this.</p>
<p>With the test concluded, we power down all the targets in reverse
order:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="k">for</span> <span class="n">_n</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()):</span>
<span class="gp">&gt;&gt;&gt; </span>            <span class="n">target</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>
</div>
<p>Or not, it can also be left to <em>ttbd</em> to decide if they have to be
powered down and when.</p>
</div>
<div class="section" id="connecting-to-network-ports">
<h3>2.3.3. Connecting to network ports<a class="headerlink" href="#connecting-to-network-ports" title="Permalink to this headline">¶</a></h3>
<p>A well designed target setup will have the test targets in an isolated
network, so the client cannot access remotely. However, using the
<a class="reference internal" href="09-api.html#tcfl.target_ext_tunnel.tunnel" title="tcfl.target_ext_tunnel.tunnel"><code class="xref py py-class docutils literal"><span class="pre">IP</span> <span class="pre">tunnel</span></code></a> extension, the
client can access the target’s network ports. This also allows to
establish <a class="reference internal" href="09-api.html#tcfl.target_ext_ssh.ssh" title="tcfl.target_ext_ssh.ssh"><code class="xref py py-class docutils literal"><span class="pre">SSH</span> <span class="pre">connections</span></code></a>.</p>
<p>Consider this example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">r</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s2">&quot;echo -n </span><span class="si">%s</span><span class="s2"> &gt; somefile&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ts</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="bp">self</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;created a file with SSH command&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is an excerpt of a longer <a class="reference download internal" href="../_downloads/test_linux_ssh.py" download=""><code class="xref download docutils literal"><span class="pre">example</span></code></a> that shows how to do different SSH
and SCP operations.</p>
<p>Tunnels are only valid while the target is acquired.</p>
</div>
<div class="section" id="network-test-cases">
<h3>2.3.4. Network test cases<a class="headerlink" href="#network-test-cases" title="Permalink to this headline">¶</a></h3>
<p>FIXME: this needs a good intro</p>
</div>
<div class="section" id="capturing-tcpdumps-of-network-traffic">
<h3>2.3.5. Capturing <em>tcpdumps</em> of network traffic<a class="headerlink" href="#capturing-tcpdumps-of-network-traffic" title="Permalink to this headline">¶</a></h3>
<p>When using the network setups controlled by the TCF server, <em>ttbd</em>, it
is possible to capture the network traffic that the server sees for
further analysis.</p>
<p>A well designed test network will interconnect one or more targets and
also will include one server interface, which usually is associated to
the <em>interconnect</em> target that defines said test network.</p>
<p>Using in the server the <a class="reference internal" href="09-api.html#conf_00_lib.vlan_pci" title="conf_00_lib.vlan_pci"><code class="xref py py-class docutils literal"><span class="pre">conf_00_lib.vlan_pci</span></code></a> to bring up the
network, like with the configuration functions
<a class="reference internal" href="09-api.html#conf_00_lib.nw_default_targets_add" title="conf_00_lib.nw_default_targets_add"><code class="xref py py-func docutils literal"><span class="pre">conf_00_lib.nw_default_targets_add()</span></code></a> to create networks, those
targets will have the tcpdump capability.</p>
<p>To use, you would, declare a test that uses an interconnect and before
powering the interconnect, in any <em>start()</em> method, you would set the
<em>tcpdump</em> property in the interconnect to unique file name:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">something</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="c1"># Tell the interconnect we want to capture network data to a</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="c1"># file named after self.kws[&#39;tc_hash&#39;] (to avoid conflicts)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">property_set</span><span class="p">(</span><span class="s1">&#39;tcpdump&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;tc_hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.cap&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="o">...</span>
</pre></div>
</div>
<p>Later on, in the <em>teardown()</em> methods, bring the data back from the
server to a file in the current work directory called
<em>tcpdump-RUNID:HASHID.cap</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>      <span class="c1"># ensure tcpdump flushes</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="c1"># Get the TCP dump from the interconnect to a file in the CWD</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="c1"># called tcpdump-HASH.cap</span>
<span class="gp">&gt;&gt;&gt; </span>        <span class="n">ic</span><span class="o">.</span><span class="n">broker_files</span><span class="o">.</span><span class="n">dnload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;tc_hash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.cap&quot;</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>                               <span class="s2">&quot;tcpdump-</span><span class="si">%(runid)s</span><span class="s2">:</span><span class="si">%(tc_hash)s</span><span class="s2">.cap&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
</pre></div>
</div>
<p>From the command line, this would be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf acquire NETWORKTARGET
$ tcf propert-set NETWORKTARGET tcpdump CAPTURENAME
$ tcf power-cycle NETWORKTARGET
... do network operations ...
$ tcf power-off NETWORKTARGET
$ tcf broker-file-dnload NETWORKTARGET CAPTURENAME myfile.cap
$ tcf release NETWORKTARGET
</pre></div>
</div>
<p>now <em>myfile.cap</em> can be opened with <em>Wireshark</em> or processed with any
other tool for further analysis.</p>
</div>
<div class="section" id="saving-data-and-files-to-a-location">
<h3>2.3.6. Saving data and files to a location<a class="headerlink" href="#saving-data-and-files-to-a-location" title="Permalink to this headline">¶</a></h3>
<p>Sometimes there is a need to keep files around for post analysis,
there are different ways to do this:</p>
<ul class="simple">
<li>provide <code class="docutils literal"><span class="pre">--no-remove-tmpdir</span></code> to <em>tcf run</em>; it will provide the
name of the temporary directory where all the temporary files are
maintained and will not delete it upon exit (as it does by default)</li>
<li>provide <code class="docutils literal"><span class="pre">--tmpdir=DIR</span></code>, where <code class="docutils literal"><span class="pre">DIR</span></code> is an existing, empty
directory where <em>tcf run</em> will place all the temporary files.</li>
</ul>
<p>Whichever is the temporary directory (autogenerated or specified), the
files are placed in subdirectories named after each test case run’s
<a class="reference internal" href="09-api.html#tc-id"><span class="std std-ref">*HASH*</span></a>.</p>
<p>If you need to create files (or copy files, etc) in the testcase,
use to the <a class="reference internal" href="09-api.html#tcfl.tc.tc_c.tmpdir" title="tcfl.tc.tc_c.tmpdir"><code class="xref py py-attr docutils literal"><span class="pre">tmpdir</span></code></a> variable to generate
or copy files to the directory assigned to the testcase, for example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;somefile.orig&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
   <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;original file&quot;</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_from</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">,</span> <span class="s2">&quot;somefile.orig&quot;</span><span class="p">))</span>
<span class="c1"># ... do something on the target</span>
<span class="n">target</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="s2">&quot;somefile&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
<span class="c1"># compare files</span>
</pre></div>
</div>
</div>
<div class="section" id="connecting-things">
<span id="id1"></span><h3>2.3.7. Connecting things<a class="headerlink" href="#connecting-things" title="Permalink to this headline">¶</a></h3>
<p>Some targets supports things (other targets) that can be connected or
disconnected. If they do, their tags will show:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf list -vv qlf04a
...
things: [u&#39;a101-05&#39;, u&#39;usb-key0&#39;]
...
</pre></div>
</div>
<p>How this is done is specific to the driver given in the configuration,
but it might be a target that is physically connected to another via a
USB cutter. The USB cutter is an object implementing a <a class="reference internal" href="09-api.html#ttbl.thing_plugger_mixin" title="ttbl.thing_plugger_mixin"><code class="xref py py-class docutils literal"><span class="pre">plugger</span>
<span class="pre">interface</span></code></a> which is given to the
configuration method <a class="reference internal" href="09-api.html#ttbl.test_target.thing_add" title="ttbl.test_target.thing_add"><code class="xref py py-meth docutils literal"><span class="pre">ttbl.test_target.thing_add()</span></code></a> in the config
files.</p>
<ul class="simple">
<li>to find available things to connect, use the <cite>tcf thing-list</cite> or
within a test script, <a class="reference internal" href="09-api.html#tcfl.tc.target_c.thing_list" title="tcfl.tc.target_c.thing_list"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.thing_list()</span></code></a></li>
<li>to connect, use <cite>thing-plug</cite> or within a test script,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.thing_plug" title="tcfl.tc.target_c.thing_plug"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.thing_plug()</span></code></a></li>
<li>to disconnect, use <cite>thing-unplug</cite> or within a test script,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.thing_unplug" title="tcfl.tc.target_c.thing_unplug"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.thing_unplug()</span></code></a></li>
</ul>
<p>Note you must own both the target and the thing to be able to plug one
into another.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">orphan:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="testcase-training">
<span id="tcf-guide-test-training"></span><h2>2.4. Testcase training<a class="headerlink" href="#testcase-training" title="Permalink to this headline">¶</a></h2>
<p>Before you get started, this training guide assumes:</p>
<blockquote>
<div><ul class="simple">
<li>You have <a class="reference internal" href="../02-QUICKSTART.html#install-tcf-client"><span class="std std-ref">installed</span></a> the client software</li>
<li>have access to a server (local or remote)</li>
<li>you know your way around: Linux, Git, building the Zephyr kernel</li>
<li>you know some basics of Python</li>
</ul>
</div></blockquote>
<div class="section" id="a-basic-testcase">
<h3>2.4.1. A basic testcase<a class="headerlink" href="#a-basic-testcase" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Inherit the basic class and create an evaluation method (where we run
the test), just print something</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run test_01.py
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<ul>
<li><p class="first">Quite succint? append one more more <code class="docutils literal"><span class="pre">-v</span></code> to <em>tcf run</em>.</p>
</li>
<li><p class="first">Increase its verbosity, add <code class="docutils literal"><span class="pre">dlevel</span> <span class="pre">=</span> <span class="pre">-1</span></code> or <code class="docutils literal"><span class="pre">-2</span></code> to <em>self.report_info()</em></p>
</li>
<li><p class="first">Why not use Python’s <em>print()</em> instead of <em>self.report_info()</em>? it
sidesteps TCF’s login mechanism and if you you want stuff logged and
reported with proper verbosity control, you need to use TCF’s
reporting system.</p>
<p>As well, when running many testcases and targets at the same time,
it helps to keep the information organized; more on that later.</p>
</li>
</ul>
</div>
<div class="section" id="what-s-in-a-testcase">
<h3>2.4.2. What’s in a testcase<a class="headerlink" href="#what-s-in-a-testcase" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A testcase has six phases (which can be individually inhibited)<ul>
<li>configuration</li>
<li>build</li>
<li>assignment of targets</li>
<li>deployment</li>
<li>evaluation (subphases setup/start/teardown)</li>
<li>cleanup</li>
</ul>
</li>
<li>Can be written in any language, as long as there is a driver to plug
it into the framework (Python scripting driver by default, also
available driver for Zephyr Sanitycheck’s testcase.ini)</li>
<li>Can need zero or more targets<ul>
<li>example of no targets: static checkers, checkpatch, things that
can run locally</li>
<li>one target: Zephyr Sanity Checks, some network testcases</li>
<li>multiple targets: device driver I/O testcases, most network
testcases</li>
</ul>
</li>
<li><em>Testcase</em> is just a name, it can be used during development for
fast flashing and whatever suits you</li>
</ul>
</div>
<div class="section" id="breaking-it-up">
<h3>2.4.3. Breaking it up<a class="headerlink" href="#breaking-it-up" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 1&quot;</span><span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 2&quot;</span><span class="p">)</span>
</span></pre></div>
</div>
<ul class="simple">
<li>You can have multiple evaluation functions, as long as they are
called <em>eval_*()</em></li>
<li>They are executed sequentially in <strong>alphabetical</strong> order</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv test_02.py
INFO2/       toplevel @local: scanning for test cases
INFO1/gixj   test_02.py#_test @local: will run on target group &#39;localic-localtg&#39;
INFO2/gixjE#1        test_02.py#_test @local: Hello 1
INFO2/gixjE#1        test_02.py#_test @local: Hello 2
PASS1/gixj   test_02.py#_test @local: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="give-me-a-target">
<h3>2.4.4. Give me a target<a class="headerlink" href="#give-me-a-target" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span><span class="p">)</span>
</span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 1&quot;</span><span class="p">)</span>
<span class="hll">
</span><span class="hll">    <span class="nd">@staticmethod</span>
</span>    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;tcfl.tc.target()</span></code> allows the testcase to request a target..or
two, or seven hundred. By default they are called <em>target</em>, <em>target1</em>…
but you can use <code class="docutils literal"><span class="pre">name</span> <span class="pre">=</span> <span class="pre">&quot;NAME&quot;</span></code> to give your own name.</li>
<li>The only arguments you can pass to the <em>eval_*()</em> methods are target
names. Note how we pass that to <em>eval_01()</em> and use it to report;
this will have an impact when using multiple targets.</li>
<li>Targets can be selected to run a tescase on in any of three ways
(which you can set with teh <code class="docutils literal"><span class="pre">mode</span> <span class="pre">=</span> <span class="pre">&quot;MODE&quot;</span></code> parameter):<ul>
<li><em>any</em>: pick one, any one will do</li>
<li><em>all</em>: pick all</li>
<li><em>one-per-type</em>: pick one of each type</li>
</ul>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv test_03.py
INFO2/       toplevel @local: scanning for test cases
INFO1/taqq   test_03.py#_test @local/qz46a-riscv32:riscv32: will run on target group &#39;target=local/qz46a-riscv32:riscv32&#39;
INFO2/taqqE#1        test_03.py#_test @local/qz46a-riscv32:riscv32: Hello 1
INFO2/taqqE#1        test_03.py#_test @local/qz46a-riscv32:riscv32: Hello 2
PASS1/taqq   test_03.py#_test @local/qz46a-riscv32:riscv32: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="give-me-a-target-that-can-run-zephyr">
<h3>2.4.5. Give me a target that can run Zephyr<a class="headerlink" href="#give-me-a-target-that-can-run-zephyr" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span><span class="p">)</span>
</span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 1&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">&#64;tcfl.tc.target()</span></code>’s first argument is a <a class="reference internal" href="#tcf-evaluation-expressions"><span class="std std-ref">logical expression</span></a> which can use the tags a target
exports (which you can see with <code class="docutils literal"><span class="pre">tcf</span> <span class="pre">list</span> <span class="pre">-vv</span> <span class="pre">TARGETNAME</span></code>)</li>
<li><em>zephyr_board</em> means any target that exports a tag called
zephyr_board with a value. That maps to the <em>BOARD</em> arg to the
Zephyr build.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv test_04.py
INFO2/       toplevel @local: scanning for test cases
INFO1/vzqp   test_04.py#_test @local/qz39a-arm:arm: will run on target group &#39;target=local/qz39a-arm:arm&#39;
INFO2/vzqpE#1        test_04.py#_test @local/qz39a-arm:arm: Hello 1
INFO2/vzqpE#1        test_04.py#_test @local/qz39a-arm:arm: Hello 2
PASS1/vzqp   test_04.py#_test @local/qz39a-arm:arm: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="give-me-a-target-that-can-run-zephyr-and-is-x86">
<h3>2.4.6. Give me a target that can run Zephyr and is x86<a class="headerlink" href="#give-me-a-target-that-can-run-zephyr-and-is-x86" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board and bsp == &quot;x86&quot;&#39;</span><span class="p">)</span>
</span><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 1&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Hello 2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li><p class="first">many combinations are possible with logical expressions.</p>
<p>Can get tricky, though; <code class="docutils literal"><span class="pre">-vvvv</span></code> will give you lots of details of the selection
process; also the same expression can be passed to <em>tcf list</em> to
figure out how it works.</p>
</li>
<li><p class="first">Removing <code class="docutils literal"><span class="pre">mode</span> <span class="pre">=</span> <span class="pre">&quot;any&quot;</span></code> defaults to running on one target of each
type..which might result on a lot of execution if you have many
different types of targets.</p>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -v test_05.py
INFO1/1qvi   test_05.py#_test @srrsotc03/ti-01:x86+arc+arm/x86: will run on target group &#39;target=srrsotc03/ti-01:x86+arc+arm&#39;
INFO1/lwq8   test_05.py#_test @srrsotc03/qc1000-01:x86+arc/x86: will run on target group &#39;target=srrsotc03/qc1000-01:x86+arc&#39;
INFO1/dvj6   test_05.py#_test @jfsotc03/a101-16:x86: will run on target group &#39;target=jfsotc03/a101-16:x86&#39;
INFO1/gjfa   test_05.py#_test @jfsotc02/qz34l-x86:x86: will run on target group &#39;target=jfsotc02/qz34l-x86:x86&#39;
INFO1/luzj   test_05.py#_test @jfsotc03/qc1000-24:x86: will run on target group &#39;target=jfsotc03/qc1000-24:x86&#39;
INFO1/nycw   test_05.py#_test @jfsotc03/a101-16:x86+arc/x86: will run on target group &#39;target=jfsotc03/a101-16:x86+arc&#39;
INFO1/ra1f   test_05.py#_test @jfsotc02/mv-09:x86: will run on target group &#39;target=jfsotc02/mv-09:x86&#39;
...
PASS0/       toplevel @local: 9 tests (9 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="but-put-some-zephyr-into-it">
<h3>2.4.7. But put some Zephyr into it?<a class="headerlink" href="#but-put-some-zephyr-into-it" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="hll"><span class="kn">import</span> <span class="nn">os</span>
</span><span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
</span><span class="hll">                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
</span>                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s1">&#39;Hello 1&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s1">&#39;Hello 2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>feed <code class="docutils literal"><span class="pre">&#64;target()</span></code> a path to a Zephyr App.</li>
<li><code class="docutils literal"><span class="pre">app_zephyr</span></code> enables a plugin that will monkey patch methods in
your test class that tells it how to build, flash and startup a
target running Zephyr (functions called
<code class="docutils literal"><span class="pre">(configure|build|deploy|start)_50_for_target()</span></code>)</li>
<li>The app is built, flashed and the target reset before <em>eval_*()</em> are
called</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run -vv test_06.py
INFO1/bxot   test_06.py#_test @jfsotc02/a101-01:x86: will run on target group &#39;target=jfsotc02/a101-01:x86&#39;
PASS2/bxot   test_06.py#_test @jfsotc02/a101-01:x86: configure passed
PASS1/bxot   test_06.py#_test @jfsotc02/a101-01:x86: build passed
PASS2/bxot   test_06.py#_test @jfsotc02/a101-01:x86: deploy passed
INFO2/bxotE#1        test_06.py#_test @jfsotc02/a101-01:x86: Reset
INFO2/bxotE#1        test_06.py#_test @jfsotc02/a101-01:x86: Hello 1
INFO2/bxotE#1        test_06.py#_test @jfsotc02/a101-01:x86: Hello 2
PASS1/bxot   test_06.py#_test @jfsotc02/a101-01:x86: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="now-we-are-building-all-the-time-some-time-savers">
<h3>2.4.8. Now we are building all the time, some time savers<a class="headerlink" href="#now-we-are-building-all-the-time-some-time-savers" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">create a temporary directory to save the build products:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ mkdir tmp
</pre></div>
</div>
</li>
<li><p class="first">add <code class="docutils literal"><span class="pre">--tmpddir</span> <span class="pre">tmp</span></code> to <code class="docutils literal"><span class="pre">tcf</span> <span class="pre">run</span></code>–this way the builder will be
able to reuse those build products</p>
<p>by default, a temporary directory is created and removed when
done–this helps when you have a lot of code being run in many
targets and you just care about the results.</p>
</li>
<li><p class="first">as a bonus, in <code class="docutils literal"><span class="pre">tmp/run.log</span></code> you’ll get a log file with all the
step by step details, <code class="docutils literal"><span class="pre">--log-file</span></code> also gets you that.</p>
</li>
<li><p class="first">work just with one target–this means that we don’t have to
recompile for new targets constantly (as they are assigned randomly)
and reuse what is already built in the temporary directory:</p>
<p>Let a target be assigned running normally:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp test_06.py
...
INFO1/bxot  test_06.py#_test @jfsotc02/a101-01:x86: will run on target group &#39;target=jfsotc02/a101-01:x86&#39;
</pre></div>
</div>
<p>Save that <em>jfsotc02/a101-01</em>, that’s your target ID that you feed to
<code class="docutils literal"><span class="pre">tcf</span> <span class="pre">run</span></code> with <code class="docutils literal"><span class="pre">-t</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -t jfsotc02/a101-01 test_06.py
INFO1/bxot  test_06.py#_test @jfsotc02/a101-01:x86: will run on target group &#39;target=jfsotc02/a101-01:x86&#39;...
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="so-is-zephyr-booting">
<h3>2.4.9. So, is Zephyr booting?<a class="headerlink" href="#so-is-zephyr-booting" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
<span class="hll">    <span class="nd">@staticmethod</span>
</span>    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s1">&#39;banner_config&#39;</span><span class="p">,</span>
</span>                                        <span class="s1">&#39;CONFIG_BOOT_BANNER=y&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;***** BOOTING ZEPHYR OS&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s1">&#39;Hello 2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><em>build*()</em> are build methods, things that have to happen when we
build (akin to <em>eval*()</em>)</li>
<li>Use the target’s <a class="reference internal" href="09-api.html#tcfl.app_zephyr.zephyr" title="tcfl.app_zephyr.zephyr"><code class="xref py py-class docutils literal"><span class="pre">zephyr</span></code></a> API
extension to enable the boot banner with a config fragment
introduced with <a class="reference internal" href="09-api.html#tcfl.app_zephyr.zephyr.config_file_write" title="tcfl.app_zephyr.zephyr.config_file_write"><code class="xref py py-meth docutils literal"><span class="pre">config_file_write</span></code></a></li>
<li>Use <em>expect()</em> to wait for something on the default console; in this
case, Zephyr’s boot banner (it can be a <a class="reference external" href="https://docs.python.org/2.7/library/re.html#module-re" title="(in Python v2.7)"><code class="xref py py-mod docutils literal"><span class="pre">Python</span> <span class="pre">regex</span></code></a>
<code class="docutils literal"><span class="pre">re.compile(REGEX)</span></code>) and if it timeouts, it raises a failure
exception, no more <em>eval*()</em> will execute.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_08.py
</pre></div>
</div>
</div>
<div class="section" id="and-is-the-code-doing-what-i-want-hello-world">
<h3>2.4.10. And is the code doing what I want? Hello World?<a class="headerlink" href="#and-is-the-code-doing-what-i-want-hello-world" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s1">&#39;banner_config&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;CONFIG_BOOT_BANNER=y&#39;</span><span class="p">)</span>
<span class="hll">
</span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;***** BOOTING ZEPHYR OS&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Same as before, use <em>expect()</em> to require the console to print
<em>Hello World!</em> to determine if the testcase is passing.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_08.py
INFO2/       toplevel @local: scanning for test cases
INFO1/lyse   test_08.py#_test @local/qz36b-arm:arm: will run on target group &#39;target=local/qz36b-arm:arm&#39;
PASS2/lyse   test_08.py#_test @local/qz36b-arm:arm: configure passed
PASS1/lyse   test_08.py#_test @local/qz36b-arm:arm: build passed
PASS2/lyse   test_08.py#_test @local/qz36b-arm:arm: deploy passed
INFO2/lyseE#1        test_08.py#_test @local/qz36b-arm:arm: Reset
PASS2/lyseE#1        test_08.py#_test @local/qz36b-arm:arm: found expected `***** BOOTING ZEPHYR OS` in console `local/qz36b-arm:default` at 0.05s
PASS2/lyseE#1        test_08.py#_test @local/qz36b-arm:arm: eval pass: found expected `***** BOOTING ZEPHYR OS` in console `local/qz36b-arm:default` at 0.05s
PASS2/lyseE#1        test_08.py#_test @local/qz36b-arm:arm: found expected `Hello World!` in console `local/qz36b-arm:default` at 0.04s
PASS2/lyseE#1        test_08.py#_test @local/qz36b-arm:arm: eval pass: found expected `Hello World!` in console `local/qz36b-arm:default` at 0.04s
PASS1/lyse   test_08.py#_test @local/qz36b-arm:arm: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="what-happens-when-it-fails-let-s-make-it-fail">
<h3>2.4.11. What happens when it fails? Let’s make it fail<a class="headerlink" href="#what-happens-when-it-fails-let-s-make-it-fail" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s1">&#39;banner_config&#39;</span><span class="p">,</span> <span class="s1">&#39;CONFIG_BOOT_BANNER=y&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<span class="hll">    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;***** BOOTING ZEPHYR OS&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_01</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;Hello Kitty!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Instead of <em>Hello World</em>, look for <em>Hello Kitty</em></li>
<li>After waiting for sixy seconds to receive <em>Hello Kitty</em>, it raises
an exception and fails.<ul>
<li>This will generate a file called <code class="docutils literal"><span class="pre">report-HASHID.txt</span></code> in the current
directory with detailed information</li>
<li><code class="docutils literal"><span class="pre">HASHID</span></code> is a UUID from the testcase name and the target(s) where it
ran, <em>azus</em> in the example below.</li>
</ul>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_09.py
INFO2/       toplevel @local: scanning for test cases
INFO1/azus   test_09.py#_test @local/qz36a-arm:arm: will run on target group &#39;target=local/qz36a-arm:arm&#39;
PASS2/azus   test_09.py#_test @local/qz36a-arm:arm: configure passed
PASS1/azus   test_09.py#_test @local/qz36a-arm:arm: build passed
PASS2/azus   test_09.py#_test @local/qz36a-arm:arm: deploy passed
INFO2/azusE#1        test_09.py#_test @local/qz36a-arm:arm: Reset
PASS2/azusE#1        test_09.py#_test @local/qz36a-arm:arm: found expected `***** BOOTING ZEPHYR OS` in console `local/qz36a-arm:default` at 0.05s
PASS2/azusE#1        test_09.py#_test @local/qz36a-arm:arm: eval pass: found expected `***** BOOTING ZEPHYR OS` in console `local/qz36a-arm:default` at 0.05s
FAIL2/azusE#1        test_09.py#_test @local/qz36a-arm:arm: eval failed: expected console output &#39;Hello Kitty!&#39; from console &#39;qz36a-arm:default&#39; NOT FOUND after 60.1 s
FAIL0/azus   test_09.py#_test @local/qz36a-arm:arm: evaluation failed
FAIL0/       toplevel @local: 1 tests (0 passed, 1 failed, 0 blocked, 0 skipped) - failed
/tmp/tcf-k9WBkM.mk:2: recipe for target &#39;tcf-jobserver-run&#39; failed
make: *** [tcf-jobserver-run] Error 1
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ignore the make messages at the bottom, it is a subproduct of
using <em>make</em>’s jobserver.</p>
</div>
</div>
<div class="section" id="running-a-zephyr-sanity-check-testcase">
<h3>2.4.12. Running a Zephyr sanity check testcase<a class="headerlink" href="#running-a-zephyr-sanity-check-testcase" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A <a class="reference internal" href="09-api.html#module-tcfl.tc_zephyr_sanity" title="tcfl.tc_zephyr_sanity"><code class="xref py py-mod docutils literal"><span class="pre">builtin</span> <span class="pre">driver</span></code></a> understand’s Zephyr’s
Sanity Check <em>testcase.ini</em> files and by default runs them on all
available targets (one of each type)</li>
<li>You can use <code class="docutils literal"><span class="pre">-u</span></code> to override and force it to run on <em>all</em> targets
(stress test) or <code class="docutils literal"><span class="pre">-y</span></code> to run on any.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd $ZEPHYR_BASE
$ mkdir tmp
$ tcf run --tmpdir tmp -v tests/kernel/common
INFO1/ihuu   tests/kernel/common/testcase.ini#test @local/qz35a-arm:arm: will run on target group &#39;target=local/qz35a-arm:arm&#39;
INFO1/7jbr   tests/kernel/common/testcase.ini#test @local/qz42a-nios2:nios2: will run on target group &#39;target=local/qz42a-nios2:nios2&#39;
INFO1/hegm   tests/kernel/common/testcase.ini#test @local/qz32b-x86:x86: will run on target group &#39;target=local/qz32b-x86:x86&#39;
INFO1/c8y1   tests/kernel/common/testcase.ini#test @local/qz45b-riscv32:riscv32: will run on target group &#39;target=local/qz45b-riscv32:riscv32&#39;
PASS1/c8y1   tests/kernel/common/testcase.ini#test @local/qz45b-riscv32:riscv32: build passed
PASS1/hegm   tests/kernel/common/testcase.ini#test @local/qz32b-x86:x86: build passed
PASS1/7jbr   tests/kernel/common/testcase.ini#test @local/qz42a-nios2:nios2: build passed
PASS1/ihuu   tests/kernel/common/testcase.ini#test @local/qz35a-arm:arm: build passed
PASS1/c8y1   tests/kernel/common/testcase.ini#test @local/qz45b-riscv32:riscv32: evaluation passed
PASS1/hegm   tests/kernel/common/testcase.ini#test @local/qz32b-x86:x86: evaluation passed
PASS1/7jbr   tests/kernel/common/testcase.ini#test @local/qz42a-nios2:nios2: evaluation passed
PASS1/ihuu   tests/kernel/common/testcase.ini#test @local/qz35a-arm:arm: evaluation passed
PASS0/       toplevel @local: 4 tests (4 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="double-down">
<h3>2.4.13. Double down<a class="headerlink" href="#double-down" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
<span class="hll">                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
</span><span class="hll">                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
</span><span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
</span>                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="hll"><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
</span><span class="hll">    <span class="nd">@staticmethod</span>
</span>    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">)</span>
        <span class="n">target1</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Two targets, flashed with <em>Hello World</em></li>
<li>The second one is called, by default <em>target1</em>. You can also use
<em>name = “TARGETNAME”</em>.</li>
<li>Note how the messages update vs running a single target</li>
<li>Wait first for <em>target</em> and then <em>target1</em> to both print <em>Hello
World!</em></li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_10.py
INFO1/zdad   test_10.py#_test @zc7o: will run on target group &#39;target=local/qz40a-nios2:nios2 target1=local/qz48b-riscv32:riscv32&#39;
PASS2/zdad   test_10.py#_test @zc7o: configure passed
PASS1/zdad   test_10.py#_test @zc7o: build passed
PASS2/zdad   test_10.py#_test @zc7o: deploy passed
INFO2/zdadE#1        test_10.py#_test @zc7o|local/qz40a-nios2: Reset
INFO2/zdadE#1        test_10.py#_test @zc7o|local/qz48b-riscv32: Reset
PASS2/zdadE#1        test_10.py#_test @zc7o|local/qz40a-nios2: found expected `Hello World!` in console `local/qz40a-nios2:default` at 0.11s
PASS2/zdadE#1        test_10.py#_test @zc7o|local/qz40a-nios2: eval pass: found expected `Hello World!` in console `local/qz40a-nios2:default` at 0.11s
PASS2/zdadE#1        test_10.py#_test @zc7o|local/qz48b-riscv32: found expected `Hello World!` in console `local/qz48b-riscv32:default` at 0.06s
PASS2/zdadE#1        test_10.py#_test @zc7o|local/qz48b-riscv32: eval pass: found expected `Hello World!` in console `local/qz48b-riscv32:default` at 0.06s
PASS1/zdad   test_10.py#_test @zc7o: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>Note how now the test reports running on <em>&#64;zc7o</em>, a unique identifier for a
set of targets. Log messages specific to an specific target get that
prefixed to the target name (as in <em>&#64;zc7o|local/qz48b-riscv32</em>).</p>
</div>
<div class="section" id="double-down-more-efficiently">
<h3>2.4.14. Double down more efficiently<a class="headerlink" href="#double-down-more-efficiently" title="Permalink to this headline">¶</a></h3>
<p>We were waiting for one to complete, then the other, but they were
running at the same time. We can set expectations and then wait for
them to happen in parallel.</p>
<p><em>Expectation</em>: poll and check</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;any&#39;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;hello_world&#39;</span><span class="p">))</span>
<span class="hll"><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">eval_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">target1</span><span class="p">):</span>
</span><span class="hll">        <span class="k">with</span> <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx_cm</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">),</span> \
</span>             <span class="n">target1</span><span class="o">.</span><span class="n">on_console_rx_cm</span><span class="p">(</span><span class="s1">&#39;Hello World!&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expecter</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li>Asks to expect receiving from each target the same string, but all
at the same time and run the expectation loop until they are all
received or it timesout (meaning failure).</li>
<li>That said, you will only notice speed ups on things that take longer
to execute and thus, parallelize well :)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_11.py
INFO2/       toplevel @local: scanning for test cases
INFO1/0d6z   test_11.py#_test @6hj6: will run on target group &#39;target=local/qz44b-nios2:nios2 target1=local/qz41b-nios2:nios2&#39;
PASS2/0d6z   test_11.py#_test @6hj6: configure passed
PASS1/0d6z   test_11.py#_test @6hj6: build passed
PASS2/0d6z   test_11.py#_test @6hj6: deploy passed
INFO2/0d6zE#1        test_11.py#_test @6hj6|local/qz44b-nios2: Reset
INFO2/0d6zE#1        test_11.py#_test @6hj6|local/qz41b-nios2: Reset
PASS2/0d6zE#1        test_11.py#_test @6hj6|local/qz44b-nios2: found expected `Hello World!` in console `local/qz44b-nios2:default` at 0.09s
PASS2/0d6zE#1        test_11.py#_test @6hj6|local/qz44b-nios2: eval pass: found expected `Hello World!` in console `local/qz44b-nios2:default` at 0.09s
PASS2/0d6zE#1        test_11.py#_test @6hj6|local/qz41b-nios2: found expected `Hello World!` in console `local/qz41b-nios2:default` at 0.13s
PASS2/0d6zE#1        test_11.py#_test @6hj6|local/qz41b-nios2: eval pass: found expected `Hello World!` in console `local/qz41b-nios2:default` at 0.13s
PASS2/0d6zE#1        test_11.py#_test @6hj6: eval pass: all expectations found
PASS1/0d6z   test_11.py#_test @6hj6: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="double-down-catchas">
<h3>2.4.15. Double down catchas<a class="headerlink" href="#double-down-catchas" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>If your testcase takes one target and it shall run on one of each
type and you have 6 different target types, it will:<ul>
<li>choose one target per type to run the testcase</li>
<li>build and flash 6 times, evaluate 6 times (one on each type of target)</li>
</ul>
</li>
<li>If your testcase needs two different targets and there are six
available:<ul>
<li>it will choose <em>6^2 = 36</em> permutations of targets</li>
<li>build and flash 36 times twice (once per target), eval 36 times</li>
</ul>
</li>
<li>If your testcase needs three different targets and there are six
available<ul>
<li>it will choose <em>6^3 = 216</em> permutations of targets:</li>
<li>build and flash 216 times thrice (once per target), eval 216 times</li>
</ul>
</li>
</ul>
<p><em>tcf run</em> limits by default to 10 permutations, but you can tweak that
with <code class="docutils literal"><span class="pre">-PNUMBER</span></code></p>
</div>
<div class="section" id="two-interconnected-targets">
<h3>2.4.16. Two interconnected targets?<a class="headerlink" href="#two-interconnected-targets" title="Permalink to this headline">¶</a></h3>
<p>Use <code class="docutils literal"><span class="pre">&#64;tcfl.tc.interconnect()</span></code> (a target–maybe conceptual–which
connects other targets together)</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">()</span>
</span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;got two interconnected targets&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Looking at the target’s <em>interconnecs</em> tags, <em>tcf run</em> can determine
which targets are connected to which interconnects.</li>
<li>Interconnects also use tags to describe what they are or how they
operate (maybe is an IP interconnect, or just a group that describes
targets that are in the same room, etc).</li>
<li>By requesting an interconnect and two targets that belong to it, we
will get a lot of permutations of two interconnected targets.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -v test_12.py
INFO1/0hgf   test_12.py#_test @qlan-tfdh: will run on target group &#39;ic=local/nwa target=local/qz34a-x86:x86 target1=local/qz45a-riscv32:riscv32&#39;
INFO1/20i5   test_12.py#_test @qlan-xk2u: will run on target group &#39;ic=local/nwa target=local/qz43a-nios2:nios2 target1=local/qz39a-arm:arm&#39;
INFO1/9rdg   test_12.py#_test @qlan-xo7w: will run on target group &#39;ic=local/nwa target=local/qz34a-x86:x86 target1=local/qz40a-nios2:nios2&#39;
...
PASS1/soip   test_12.py#_test @qlan-xeb3: evaluation passed
PASS1/4t2r   test_12.py#_test @qlan-xqnu: evaluation passed
PASS1/ku9e   test_12.py#_test @qlan-kdrw: evaluation passed
PASS1/20i5   test_12.py#_test @qlan-xk2u: evaluation passed
PASS1/9rdg   test_12.py#_test @qlan-xo7w: evaluation passed
PASS0/       toplevel @local: 10 tests (10 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>Note that because 4 target types were available (QEMU Zephyr for x86,
NIOS2, ARM and Risc v32), it has generated 16 different permutations
and only taken the first 10 (because of the default <code class="docutils literal"><span class="pre">-P10</span></code>
setting).</p>
</div>
<div class="section" id="networking-and-the-zephyr-echo-server">
<h3>2.4.17. Networking and the Zephyr echo server<a class="headerlink" href="#networking-and-the-zephyr-echo-server" title="Permalink to this headline">¶</a></h3>
<p>Let’s get a Zephyr network application, the Echo Server, built and
deployed in a target along with a network. Being part of a network
assigns IP addresses to targets, which we can query for building:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="hll"><span class="kn">import</span> <span class="nn">tcfl.tc</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">tcfl.tl</span>
</span><span class="hll"><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
</span><span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_server&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="hll"><span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
</span>                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
<span class="hll">                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_server&quot;</span><span class="p">))</span>
</span><span class="hll"><span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@staticmethod</span>
</span><span class="hll">    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">build_00_server_config</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
</span><span class="hll">        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
</span><span class="hll">            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
</span><span class="hll">                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">                <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span>            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll">
</span><span class="hll">        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
</span>            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">start_00</span><span class="p">(</span><span class="n">ic</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00_server</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo server&quot;</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;receive: Starting to wait&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul>
<li><p class="first">Use <code class="docutils literal"><span class="pre">&#64;tcfl.tc.interconnect(&quot;ipv4_addr&quot;)</span></code> to request an
interconnect that declares having an IPv4 address.</p>
</li>
<li><p class="first">Request a Zephyr capable target; use <code class="docutils literal"><span class="pre">name</span></code> to name them and
<code class="docutils literal"><span class="pre">spec</span></code> to <a class="reference internal" href="#tcf-evaluation-expressions"><span class="std std-ref">filter</span></a> the
targets where the echo server can run (based on the configuration
files available). Use <code class="docutils literal"><span class="pre">app_zephyr</span></code> to point to the right source.</p>
</li>
<li><p class="first">Use <em>build_*()</em> to set configuration values, as these applications
need to know their IP addresses at build time. These are available
in the target’s <em>kws</em> dictionary, which export the target’s tags.</p>
</li>
<li><p class="first">Use <em>start_*()</em> to power cycle the network before starting the
test, otherwise it will not work. <em>ic</em> is the default name assigned by
<code class="docutils literal"><span class="pre">&#64;tcfl.tc.interconnect()</span></code>.</p>
<p>Before evaluating, the <em>setup*()</em> and <em>start*()</em> functions are
executed serially in alphabetical order. That’s why we call it
<em>_00_</em> to make sure it gets run before the default Zephyr’s start
function (<em>start_50_*()</em>).</p>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_13.py
INFO2/       toplevel @local: scanning for test cases
INFO1/pz15   test_13.py#_test @qlan-4coc: will run on target group &#39;ic=local/nwa zephyr_server=local/qz33a-x86:x86&#39;
PASS2/pz15   test_13.py#_test @qlan-4coc: configure passed
PASS1/pz15   test_13.py#_test @qlan-4coc: build passed
PASS2/pz15   test_13.py#_test @qlan-4coc: deploy passed
INFO2/pz15E#1        test_13.py#_test @qlan-4coc|local/nwa: Power cycled
INFO2/pz15E#1        test_13.py#_test @qlan-4coc|local/qz33a-x86: Reset
PASS2/pz15E#1        test_13.py#_test @qlan-4coc|local/qz33a-x86: found expected `init_app: Run echo server` in console `local/qz33a-x86:default` at 0.06s
PASS2/pz15E#1        test_13.py#_test @qlan-4coc|local/qz33a-x86: eval pass: found expected `init_app: Run echo server` in console `local/qz33a-x86:default` at 0.06s
PASS2/pz15E#1        test_13.py#_test @qlan-4coc|local/qz33a-x86: found expected `receive: Starting to wait` in console `local/qz33a-x86:default` at 0.05s
PASS2/pz15E#1        test_13.py#_test @qlan-4coc|local/qz33a-x86: eval pass: found expected `receive: Starting to wait` in console `local/qz33a-x86:default` at 0.05s
PASS1/pz15   test_13.py#_test @qlan-4coc: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="add-on-the-zephyr-echo-client">
<h3>2.4.18. Add on the Zephyr echo client<a class="headerlink" href="#add-on-the-zephyr-echo-client" title="Permalink to this headline">¶</a></h3>
<p>A full Zephyr network echo client/server needs the client code too, so
we add it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_server&quot;</span><span class="p">,</span>
<span class="hll">                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
</span><span class="hll"><span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
</span><span class="hll"><span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
</span><span class="hll"><span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
</span><span class="hll">                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
</span>                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_server&quot;</span><span class="p">))</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_client&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_client&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build_00_server_config</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
<span class="hll">                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">                <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
</span><span class="hll">        <span class="k">else</span><span class="p">:</span>
</span><span class="hll">            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
</span><span class="hll">            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">])</span>
</span><span class="hll">
</span><span class="hll">    <span class="nd">@staticmethod</span>
</span><span class="hll">    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">build_00_client_config</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">):</span>
</span><span class="hll">        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
</span><span class="hll">            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
</span>                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
<span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_PEER_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span>            <span class="o">%</span> <span class="p">(</span><span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],</span>
               <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">start_00</span><span class="p">(</span><span class="n">ic</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_00_server</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo server&quot;</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;receive: Starting to wait&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_10_client</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">):</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo client&quot;</span><span class="p">)</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;Compared [0-9]+ bytes, all ok&quot;</span><span class="p">))</span>
</pre></div>
</div>
<ul>
<li><p class="first">Note how <em>build_00_client_config</em> takes as argument both the
<em>zephyr_client</em> and <em>zephyr_server</em> targets, because it needs to
know the server’s IP address to configure the client build.</p>
<p>This is the reason for <code class="docutils literal"><span class="pre">&#64;tcfl.tc.serially</span></code>. <em>build*()</em> functions
that take target arguments will be executed in parallel and cause an
error if the targets overlap. The decorator forces them to execute
serially to avoid race conditions in the use of resources (eg:
temporary directories) associated to each target.</p>
</li>
<li><p class="first">In the same fashion, <em>eval_10_client()</em> is named <em>_10_</em> to make sure
it runs after the server’s evaluation function.</p>
</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_14.py
INFO2/       toplevel @local: scanning for test cases
INFO1/51yw   test_14.py#_test @v2xd-d4h6: will run on target group &#39;ic=local/nwb zephyr_client=local/qz32b-x86:x86 zephyr_server=local/qz31b-x86:x86&#39;
PASS2/51yw   test_14.py#_test @v2xd-d4h6: configure passed
PASS1/51yw   test_14.py#_test @v2xd-d4h6: build passed
PASS2/51yw   test_14.py#_test @v2xd-d4h6: deploy passed
INFO2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/nwb: Power cycled
INFO2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz32b-x86: Reset
INFO2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz31b-x86: Reset
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz31b-x86: found expected `init_app: Run echo server` in console `local/qz31b-x86:default` at 0.41s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz31b-x86: eval pass: found expected `init_app: Run echo server` in console `local/qz31b-x86:default` at 0.41s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz31b-x86: found expected `receive: Starting to wait` in console `local/qz31b-x86:default` at 0.07s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz31b-x86: eval pass: found expected `receive: Starting to wait` in console `local/qz31b-x86:default` at 0.07s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz32b-x86: found expected `init_app: Run echo client` in console `local/qz32b-x86:default` at 0.08s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz32b-x86: eval pass: found expected `init_app: Run echo client` in console `local/qz32b-x86:default` at 0.08s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz32b-x86: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz32b-x86:default` at 1.33s
PASS2/51ywE#1        test_14.py#_test @v2xd-d4h6|local/qz32b-x86: eval pass: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz32b-x86:default` at 1.33s
PASS1/51yw   test_14.py#_test @v2xd-d4h6: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="cover-more-bases-on-the-zephyr-echo-server-client">
<h3>2.4.19. Cover more bases on the Zephyr echo server/client<a class="headerlink" href="#cover-more-bases-on-the-zephyr-echo-server-client" title="Permalink to this headline">¶</a></h3>
<p>In this case, we want to make sure that the order at which the targets
are starting is more under our control, because we need to make sure
the <em>network</em> (interconnect) is powered on first, then the server and
then finally the client.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_server&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_server&quot;</span><span class="p">))</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_client&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_client&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build_00_server_config</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build_00_client_config</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
<span class="hll">                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">                <span class="o">%</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
</span>        <span class="k">else</span><span class="p">:</span>
<span class="hll">            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class="hll">
</span>        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="s2">&quot;CONFIG_NET_APP_PEER_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
</span><span class="hll">            <span class="o">%</span> <span class="p">(</span><span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],</span>
</span><span class="hll">               <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],))</span>
</span>
    <span class="k">def</span> <span class="nf">start_50_zephyr_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start_50_zephyr_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zephyr_client</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">,</span> <span class="n">zephyr_client</span><span class="p">):</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overriden_start_50_zephyr_server</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo server&quot;</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;receive: Starting to wait&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overriden_start_50_zephyr_client</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval_10_client</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">):</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo client&quot;</span><span class="p">)</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;Compared [0-9]+ bytes, all ok&quot;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li>First we override the default App Zephyr start methods
(<em>start_50_zephyr_server()</em> and <em>start_50_zephyr_client()</em>) to do
nothing. This will actually have them renamed as
<em>overriden_start_50_zephyr_server()</em> and
<em>overriden_start_50_zephyr_client()</em>.</li>
<li>Then add to the existing <em>start_00()</em> a call to start the server
target, wait for the banner indicating it has started to serve and
then call to start the client.</li>
<li>This renders <em>eval_00_server()</em> unnecesary, as we did that check on
<em>start_00()</em> to ensure it had started properly.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_14.py
...
INFO2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/nwb: Power cycled
INFO2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz30b-x86: Reset
INFO2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz31b-x86: Reset
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz31b-x86: found expected `init_app: Run echo server` in console `local/qz31b-x86:default` at 0.10s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz31b-x86: eval pass: found expected `init_app: Run echo server` in console `local/qz31b-x86:default` at 0.10s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz31b-x86: found expected `receive: Starting to wait` in console `local/qz31b-x86:default` at 0.10s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz31b-x86: eval pass: found expected `receive: Starting to wait` in console `local/qz31b-x86:default` at 0.10s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz30b-x86: found expected `init_app: Run echo client` in console `local/qz30b-x86:default` at 0.08s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz30b-x86: eval pass: found expected `init_app: Run echo client` in console `local/qz30b-x86:default` at 0.08s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz30b-x86: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz30b-x86:default` at 1.61s
PASS2/jgszE#1        test_14.py#_test @v2xd-xwv4|local/qz30b-x86: eval pass: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz30b-x86:default` at 1.61s
PASS1/jgsz   test_14.py#_test @v2xd-xwv4: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="but-let-s-test-zephyr-s-echo-server-client-better">
<h3>2.4.20. But let’s test Zephyr’s echo server/client better<a class="headerlink" href="#but-let-s-test-zephyr-s-echo-server-client-better" title="Permalink to this headline">¶</a></h3>
<p>We should be looking for more than just one occurrence of the <em>all ok</em>
message:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">interconnect</span><span class="p">(</span><span class="s2">&quot;ipv4_addr&quot;</span><span class="p">)</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_server&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_server&quot;</span><span class="p">))</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;zephyr_client&quot;</span><span class="p">,</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;zephyr_board in [</span>
<span class="s2">                              &#39;frdm_k64f&#39;, &#39;qemu_x86&#39;,</span>
<span class="s2">                              &#39;arduino_101&#39;, &#39;sam_e70_xplained&#39;</span>
<span class="s2">                          ]&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;echo_client&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build_00_server_config</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">build_00_client_config</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;mac_addr&#39;</span> <span class="ow">in</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">:</span>
            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
                <span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;CONFIG_SLIP_MAC_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;mac_addr&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s2">&quot;mac_addr&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span>
            <span class="s2">&quot;ip_addr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CONFIG_NET_APP_SETTINGS=y</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;CONFIG_NET_APP_MY_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;CONFIG_NET_APP_PEER_IPV4_ADDR=</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">zephyr_client</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],</span>
               <span class="n">zephyr_server</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;ipv4_addr&#39;</span><span class="p">],))</span>

    <span class="k">def</span> <span class="nf">start_50_zephyr_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">):</span>
<span class="hll">        <span class="k">pass</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">start_50_zephyr_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zephyr_client</span><span class="p">):</span>
</span><span class="hll">        <span class="k">pass</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">start_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ic</span><span class="p">,</span> <span class="n">zephyr_server</span><span class="p">,</span> <span class="n">zephyr_client</span><span class="p">):</span>
</span><span class="hll">        <span class="n">ic</span><span class="o">.</span><span class="n">power</span><span class="o">.</span><span class="n">cycle</span><span class="p">()</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">overriden_start_50_zephyr_server</span><span class="p">(</span><span class="n">zephyr_server</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo server&quot;</span><span class="p">)</span>
        <span class="n">zephyr_server</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;receive: Starting to wait&quot;</span><span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">overriden_start_50_zephyr_client</span><span class="p">(</span><span class="n">zephyr_client</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">def</span> <span class="nf">eval_10_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zephyr_client</span><span class="p">):</span>
</span><span class="hll">        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;init_app: Run echo client&quot;</span><span class="p">)</span>
</span><span class="hll">        <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
</span><span class="hll">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class="hll">            <span class="n">zephyr_client</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Running for 30s (</span><span class="si">%d</span><span class="s2">/10)&quot;</span>  <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
</span><span class="hll">            <span class="p">[</span> <span class="n">target</span><span class="o">.</span><span class="n">active</span><span class="p">()</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>
</span><span class="hll">        <span class="c1"># Ensure we have at least one &quot;all ok&quot; message or fail</span>
</span>        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;Compared [0-9]+ bytes, all ok&quot;</span><span class="p">)</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">zephyr_client</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>        <span class="c1"># Read all the output we got</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;DEBUG: read </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">need</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">need</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">failed_e</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t get at least </span><span class="si">%d</span><span class="s2"> &#39;all ok&#39; &quot;</span>
                                   <span class="s2">&quot;messages (but </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">need</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)))</span>
        <span class="n">zephyr_client</span><span class="o">.</span><span class="n">report_pass</span><span class="p">(</span><span class="s2">&quot;Got at least </span><span class="si">%d</span><span class="s2"> &#39;all ok&#39; messages&quot;</span>
                                  <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li>note how after we detect the client has started running, we let the
client run, watiting a couple of times for thirty seconds…</li>
<li>… so we can mark all the targets as active using
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.active" title="tcfl.tc.target_c.active"><code class="xref py py-meth docutils literal"><span class="pre">tcfl.tc.target_c.active()</span></code></a> to avoid the server powering them
off due to inactivity.</li>
<li>once the target has had at least a minute to run, we read all the
console output and count how many <em>allow ok</em> messages have been
received</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vv test_16.py
...
PASS2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: found expected `init_app: Run echo client` in console `local/qz34a-x86:default` at 0.08s
PASS2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: eval pass: found expected `init_app: Run echo client` in console `local/qz34a-x86:default` at 0.08s
INFO2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: Running for 30s (1/1)
INFO2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: Running for 30s (1/2)
PASS2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz34a-x86:default` at 0.40s
PASS2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: eval pass: found expected `Compared [0-9]+ bytes, all ok` in console `local/qz34a-x86:default` at 0.40s
INFO2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: read console &#39;local/qz34a-x86:&lt;default&gt;&#39; @0 2374B
PASS2/4odfE#1        test_16.py#_test @qlan-pbuz|local/qz34a-x86: Got at least 10 &#39;all ok&#39; messages
PASS1/4odf   test_16.py#_test @qlan-pbuz: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
<div class="section" id="developing-zephyr-apps-with-the-tcf-s-help">
<h3>2.4.21. Developing Zephyr apps with the TCF’s help<a class="headerlink" href="#developing-zephyr-apps-with-the-tcf-s-help" title="Permalink to this headline">¶</a></h3>
<p>Let’s write our own Zephyr App, <code class="docutils literal"><span class="pre">test_18/src/main.c</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2017</span> <span class="n">Intel</span> <span class="n">Corp</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*/</span>
<span class="c1">#include &lt;zephyr.h&gt;</span>
<span class="c1">#include &lt;misc/printk.h&gt;</span>
<span class="c1">#include &lt;drivers/rand32.h&gt;</span>

<span class="nb">int</span> <span class="n">run_some_test</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint32_t</span> <span class="n">r</span><span class="p">;</span>
<span class="hll">	<span class="n">r</span> <span class="o">=</span> <span class="n">sys_rand32_get</span><span class="p">();</span>
</span>	<span class="k">return</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">run_some_test</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="s2">&quot;PASS</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s2">&quot;FAIL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a random test case, sometimes <em>passes</em>, sometimes <em>fails</em>.</p>
<p>Our app some assistance:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">test_18</span></code>: a directory where to place all the information for it</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">test_18/Makefile</span></code>: Makefile to integrate into Zephyr</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>BOARD ?= qemu_x86
CONF_FILE = prj.conf

include ${ZEPHYR_BASE}/Makefile.test
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">test_18/src</span></code>: directory where to place the source</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">test_18/src/Makefile</span></code>: Makefile Zephyr will call to build the app</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>include $(ZEPHYR_BASE)/tests/Makefile.test
obj-y = main$(SUBSAMPLE).o
</pre></div>
</div>
<p>We use the <code class="docutils literal"><span class="pre">$(SUBPHASE)</span></code> append to the file name so we can control
from the environment which file we compile, as we evolve the
testcase.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">test_18/test.py</span></code>: TCF test script integration</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">tcfl.tc</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
<span class="hll">    <span class="k">def</span> <span class="nf">setup_catch_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="s2">&quot;FAIL&quot;</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;PASS&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>setup*()</em> functions are called before <em>starting</em> the targets
and in this case we setup a hook on the console to fail the testcase
if we receive a <code class="docutils literal"><span class="pre">FAIL</span></code> string.</p>
</li>
</ul>
<p>When you run it and passes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vvy test_18/
INFO2/        toplevel @local: scanning for test cases
INFO1/vdac    test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: will run on target group &#39;target=srrsotc03/qz37g-riscv32:riscv32&#39;
PASS2/vdac    test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: configure passed
PASS1/vdac    test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: build passed
PASS2/vdac    test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: deploy passed
INFO2/vdacE#1 test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: Reset
PASS2/vdacE#1 test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: found expected `PASS` in console `srrsotc03/qz37g-riscv32:default` at 0.62s
PASS2/vdacE#1 test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: eval pass: found expected `PASS` in console `srrsotc03/qz37g-riscv32:default` at 0.62s
PASS1/vdac    test_18/test.py#_test @srrsotc03/qz37g-riscv32:riscv32: evaluation passed
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>and when it fails:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -vvy test_18/
INFO2/        toplevel @local: scanning for test cases
INFO1/f95t    test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: will run on target group &#39;target=srrsotc03/qz35h-nios2:nios2&#39;
PASS2/f95t    test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: configure passed
PASS1/f95t    test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: build passed
PASS2/f95t    test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: deploy passed
INFO2/f95tE#1 test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: Reset
FAIL2/f95tE#1 test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: eval failed: found expected (for failure) `FAIL` in console `srrsotc03/qz35h-nios2:default` at 0.10s
FAIL0/f95t    test_18/test.py#_test @srrsotc03/qz35h-nios2:nios2: evaluation failed
FAIL0/        toplevel @local: 1 tests (0 passed, 1 failed, 0 blocked, 0 skipped) - failed
</pre></div>
</div>
<p>We are going to evolve this app to see what is in a Zephyr testcase.</p>
<div class="section" id="evolving-into-a-tc-test-case">
<h4>2.4.21.1. Evolving into a TC test case<a class="headerlink" href="#evolving-into-a-tc-test-case" title="Permalink to this headline">¶</a></h4>
<p>Anything can be used to comunicate via the console if it passes or
fails, however, to be consistent and make it easy, Zephyr has
standarized on the <em>TC</em> macros and the <em>ztest</em> framework; copy
<code class="docutils literal"><span class="pre">main.c</span></code> to <code class="docutils literal"><span class="pre">main-b.c</span></code> and edit it adding:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2017</span> <span class="n">Intel</span> <span class="n">Corp</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*/</span>
<span class="c1">#include &lt;zephyr.h&gt;</span>
<span class="c1">#include &lt;misc/printk.h&gt;</span>
<span class="c1">#include &lt;drivers/rand32.h&gt;</span>
<span class="hll"><span class="c1">#include &lt;tc_util.h&gt;</span>
</span>
<span class="nb">int</span> <span class="n">run_some_test</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint32_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">sys_rand32_get</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nb">int</span> <span class="n">r</span><span class="p">;</span>
<span class="hll">	<span class="n">TC_START</span><span class="p">(</span><span class="s2">&quot;random test&quot;</span><span class="p">);</span>
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">run_some_test</span><span class="p">())</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">TC_PASS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">TC_FAIL</span><span class="p">;</span>
<span class="hll">	<span class="n">TC_END_RESULT</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span class="hll">	<span class="n">TC_END_REPORT</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</span><span class="p">}</span>
</pre></div>
</div>
<p>Our testing functions are slightly modified (no arguments or return
values) and they just have to call <em>ztest</em> functions to indicate a
failure. A suite is declared to tie them all together and launch
it. Error messages will be printed.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">tcfl.tc</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setup_catch_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="s2">&quot;PROJECT EXECUTION FAILED&quot;</span><span class="p">,</span>
</span><span class="hll">                             <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;RunID: </span><span class="si">%(runid)s</span><span class="s2">:</span><span class="si">%(tghash)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;PROJECT EXECUTION SUCCESSFUL&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ (export SUBSAMPLE=-c; tcf run --tmpdir tmp -vvvy test_18/test$SUBSAMPLE.py)
</pre></div>
</div>
<p>(remember that for the sake of brevity in the training, we use the
<em>SUBSAMPLE</em> environment variable to select which Python test file
script and which C source files we want to use)</p>
<p>produces:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">PASS2</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: found expected `PASS` in console `srrsotc03/qc1000-01:default` at 1.17s</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: ***** BOOTING ZEPHYR OS v1.7.99 - BUILD: Jun  4 2017 12:31:00 *****</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: tc_start() - random test</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: ===================================================================</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: PASS - main.</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: ===================================================================</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: RunID: :wpgl</span>
<span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: PROJECT EXECUTION SUCCESSFUL</span>
<span class="n">PASS2</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: eval pass: found expected `PASS` in console `srrsotc03/qc1000-01:default` at 1.17s</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The message <code class="docutils literal"><span class="pre">RunID:</span> <span class="pre">:wpgl</span></code> from this line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">PASS3</span><span class="o">/</span><span class="n">rmk0E</span><span class="c1">#1 test_18/test.py#_test @srrsotc03/qc1000-01:x86: console output: RunID: :wpgl</span>
</pre></div>
</div>
<p>will be unique for each combination of testcase name, target group
where it runs and the app itself (in our case <em>test_18/src</em>) and it is
always good to verify it was printed to ensure the right image was
found. For that, we can use <em>target.kws</em>’s <em>tghash</em> and <em>runid</em>
keys:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;RunID: </span><span class="si">%(runid)s</span><span class="s2">:%(tghash)&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="evolving-into-a-ztest-test-case">
<h4>2.4.21.2. Evolving into a ztest test case<a class="headerlink" href="#evolving-into-a-ztest-test-case" title="Permalink to this headline">¶</a></h4>
<p><em>ztest</em> is a unit test library, whose API can be found in
<em>tests/ztest/include</em>.</p>
<p>Copy <code class="docutils literal"><span class="pre">src/main-b.c</span></code> to <code class="docutils literal"><span class="pre">src/main-c.c</span></code> and introduce the
highlighted modifications:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2017</span> <span class="n">Intel</span> <span class="n">Corp</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*/</span>
<span class="c1">#include &lt;zephyr.h&gt;</span>
<span class="c1">#include &lt;misc/printk.h&gt;</span>
<span class="c1">#include &lt;drivers/rand32.h&gt;</span>
<span class="hll"><span class="c1">#include &lt;ztest.h&gt;</span>
</span>
<span class="hll"><span class="n">void</span> <span class="n">run_some_test1</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span><span class="hll"><span class="p">{</span>
</span><span class="hll">	<span class="n">uint32_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sys_rand32_get</span><span class="p">();</span>
</span><span class="hll">	<span class="n">zassert_true</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span> <span class="s2">&quot;random1&quot;</span><span class="p">);</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="hll"><span class="n">void</span> <span class="n">run_some_test2</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</span><span class="hll"><span class="p">{</span>
</span><span class="hll">	<span class="n">uint32_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sys_rand32_get</span><span class="p">();</span>
</span><span class="hll">	<span class="n">zassert_true</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span> <span class="s2">&quot;random2&quot;</span><span class="p">);</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="hll"><span class="n">void</span> <span class="n">test_main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>			<span class="o">/*</span> <span class="n">note</span> <span class="n">test_main</span><span class="p">()</span> <span class="o">*/</span>
</span><span class="p">{</span>
<span class="hll">	<span class="n">ztest_test_suite</span><span class="p">(</span>		<span class="o">/*</span> <span class="n">declare</span> <span class="n">the</span> <span class="n">test</span> <span class="n">suite</span> <span class="o">*/</span>
</span><span class="hll">		<span class="n">test_18</span><span class="p">,</span>
</span><span class="hll">		<span class="n">ztest_unit_test</span><span class="p">(</span><span class="n">run_some_test1</span><span class="p">),</span>
</span><span class="hll">		<span class="n">ztest_unit_test</span><span class="p">(</span><span class="n">run_some_test2</span><span class="p">));</span>
</span><span class="hll">	<span class="n">ztest_run_test_suite</span><span class="p">(</span><span class="n">test_18</span><span class="p">);</span>	<span class="o">/*</span> <span class="n">run</span> <span class="n">it</span> <span class="o">*/</span>
</span><span class="p">}</span>
</pre></div>
</div>
<p>Thus when a testcase passes, it will print <code class="docutils literal"><span class="pre">PROJECT</span> <span class="pre">EXECUTION</span>
<span class="pre">SUCCESSFUL</span></code> or <code class="docutils literal"><span class="pre">PROJECT</span> <span class="pre">EXECUTION</span> <span class="pre">FAILED</span></code> and a few other
messages; copy <code class="docutils literal"><span class="pre">test.py</span></code> to <code class="docutils literal"><span class="pre">test-b.py</span></code> and add:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">tcfl.tc</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">,</span> <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>

<span class="hll">    <span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">serially</span><span class="p">()</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">build_00</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">zephyr</span><span class="o">.</span><span class="n">config_file_write</span><span class="p">(</span><span class="s1">&#39;ztest&#39;</span><span class="p">,</span> <span class="s1">&#39;CONFIG_ZTEST=y&#39;</span><span class="p">)</span>
</span>
<span class="hll">    <span class="k">def</span> <span class="nf">setup_catch_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">on_console_rx</span><span class="p">(</span><span class="s2">&quot;PROJECT EXECUTION FAILED&quot;</span><span class="p">,</span>
</span><span class="hll">                             <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;RunID: </span><span class="si">%(runid)s</span><span class="s2">:</span><span class="si">%(tghash)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;PROJECT EXECUTION SUCCESSFUL&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A new configuration setting is needed <code class="docutils literal"><span class="pre">CONFIG_ZTEST</span></code>, which we can
do using a <em>build</em> method or by modifying <code class="docutils literal"><span class="pre">prj.conf</span></code>.</p>
<p>Runing a case that fails:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ (export SUBSAMPLE=-c; ~/z/v0.11-tcf.git/tcf run --tmpdir tmp -vyvvvv test_18/test$SUBSAMPLE.py)
INFO1/tgdh    test_18/test-c.py#_test @local/qz30a-x86:x86: will run on target group &#39;target=local/qz30a-x86:x86&#39;
PASS2/tgdh    test_18/test-c.py#_test @local/qz30a-x86:x86: configure passed
PASS1/tgdh    test_18/test-c.py#_test @local/qz30a-x86:x86: build passed
PASS2/tgdh    test_18/test-c.py#_test @local/qz30a-x86:x86: deploy passed
INFO2/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: Reset
PASS2/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: found expected `RunID: :5ohy` in console `local/qz30a-x86:default` at 0.05s
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: ***** BOOTING ZEPHYR OS v1.7.99 - BUILD: Jun  4 2017 17:36:02 *****
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: Running test suite test_18
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: tc_start() - run_some_test1
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: ===================================================================
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: PASS - run_some_test1.
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: tc_start() - run_some_test2
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: ===================================================================
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: PASS - run_some_test2.
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: ===================================================================
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: RunID: :5ohy
PASS3/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: console output: PROJECT EXECUTION SUCCESSFUL
PASS2/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: eval pass: found expected `RunID: :5ohy` in console `local/qz30a-x86:default` at 0.05s
...
PASS2/tgdhE#1 test_18/test-c.py#_test @local/qz30a-x86:x86: found expected `PROJECT EXECUTION SUCCESSFUL` in console `local/qz30a-x86:default` at 0.05s
...
PASS1/tgdh    test_18/test-c.py#_test @local/qz30a-x86:x86: evaluation passed
PASS0/        toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
</div>
</div>
<div class="section" id="change-of-pace-input-to-a-zephyr-test-case">
<h3>2.4.22. Change of pace, input to a Zephyr test case<a class="headerlink" href="#change-of-pace-input-to-a-zephyr-test-case" title="Permalink to this headline">¶</a></h3>
<p>Let’s play with a Zephyr shell example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span>
    <span class="s1">&#39;zephyr_board &#39;</span>
    <span class="c1"># Shell app can&#39;t run on NIOS2/RISCv32 due to no</span>
    <span class="c1"># IRQ-based UART support</span>
<span class="hll">    <span class="s1">&#39;and not zephyr_board in [ &quot;qemu_nios2&quot;, &quot;qemu_riscv32&quot; ]&#39;</span><span class="p">,</span>
</span>    <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                              <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;subsys&quot;</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="s2">&quot;shell&quot;</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="n">zephyr_filter</span> <span class="o">=</span> <span class="s2">&quot;UART_CONSOLE&quot;</span>
    <span class="n">zephyr_filter_origin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">expecter</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span>
<span class="hll">        <span class="n">target</span><span class="o">.</span><span class="n">crlf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span>
</span>        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;shell&gt;&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;select sample_module&quot;</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;sample_module&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>you can use shell based apps to implement <em>multiple</em> test cases on a
single Zephyr app using the <em>TC</em> framework.</li>
<li>Use <a class="reference internal" href="09-api.html#tcfl.tc.target_c.send" title="tcfl.tc.target_c.send"><code class="xref py py-meth docutils literal"><span class="pre">target.send</span></code></a> to send data to the
target’s console, as if you were typing it.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf run --tmpdir tmp -yvv test_17.py
INFO2/       toplevel @local: scanning for test cases
INFO1/3daq   test_17.py#_test @local/qz36a-arm:arm: will run on target group &#39;target=local/qz36a-arm:arm&#39;
PASS2/3daq   test_17.py#_test @local/qz36a-arm:arm: configure passed
PASS1/3daq   test_17.py#_test @local/qz36a-arm:arm: build passed
PASS2/3daq   test_17.py#_test @local/qz36a-arm:arm: deploy passed
INFO2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: Reset
PASS2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: found expected `shell&gt;` in console `local/qz36a-arm:default` at 0.05s
PASS2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: eval pass: found expected `shell&gt;` in console `local/qz36a-arm:default` at 0.05s
INFO2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: wrote &#39;select sample_module&#39; to console &#39;local/qz36a-arm:&lt;default&gt;&#39;
PASS2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: found expected `sample_module&gt;` in console `local/qz36a-arm:default` at 0.05s
PASS2/3daqE#1        test_17.py#_test @local/qz36a-arm:arm: eval pass: found expected `sample_module&gt;` in console `local/qz36a-arm:default` at 0.05s
PASS1/3daq   test_17.py#_test @local/qz36a-arm:arm: evaluation passed
PASS0/       toplevel @local: 1 tests (1 passed, 0 failed, 0 blocked, 0 skipped) - passed
</pre></div>
</div>
<p>Note how now, you can acquire the target and interact with it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ tcf acquire qz36a-arm
$ tcf console-write -i qz36a-arm
WARNING: This is a very limited interactive console
         Escape character twice ^[^[ to exit

shell&gt; shell&gt; select sample_module    # This was typed by the testcase
sample_module&gt; help                   # I typed this &#39;help&#39;
help
ping
params
sample_module&gt; ping                   # Same with &#39;ping&#39;
pong
sample_module&gt;
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Make sure it is on and it is not taken away from you in the middle
due to inactivity, a trick for that is to run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ while true; do tcf acquire qz36a-arm || true; sleep 30s; done &amp;
</pre></div>
</div>
<p>this is a loop, in the background, that is twice a minute
refreshing your acquisition of the target, while you interact with
it.</p>
<p class="last"><em>Kill it</em> when you are done, otherwise others won’t be able to use
it.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the interactive console is quite limited; plus some targets
(QEMU) have a tendency to drop characters or not echo input,
some stop working half way (SAMe70).</p>
</div>
</div>
<div class="section" id="fixme-missing">
<h3>2.4.23. FIXME: Missing<a class="headerlink" href="#fixme-missing" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>USB
- console
- mount</li>
<li>Power</li>
<li>Network</li>
<li>Network + tunnel</li>
<li>Network + linux</li>
</ul>
</div>
</div>
<div class="section" id="report-drivers">
<span id="tcf-guide-report-driver"></span><h2>2.5. Report Drivers<a class="headerlink" href="#report-drivers" title="Permalink to this headline">¶</a></h2>
<p>A report driver is what gets called to report information by the
different components of the TCF client test runner.</p>
<p>The APIs that are the entry points for reporting are:</p>
<ul class="simple">
<li>target <a class="reference internal" href="09-api.html#tcfl.tc.target_c" title="tcfl.tc.target_c"><code class="xref py py-class docutils literal"><span class="pre">object</span></code></a>:
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.report_info" title="tcfl.tc.target_c.report_info"><code class="xref py py-meth docutils literal"><span class="pre">report_info</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.report_pass" title="tcfl.tc.target_c.report_pass"><code class="xref py py-meth docutils literal"><span class="pre">report_pass</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.report_fail" title="tcfl.tc.target_c.report_fail"><code class="xref py py-meth docutils literal"><span class="pre">report_fail</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.report_blck" title="tcfl.tc.target_c.report_blck"><code class="xref py py-meth docutils literal"><span class="pre">report_blck</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.target_c.report_skip" title="tcfl.tc.target_c.report_skip"><code class="xref py py-meth docutils literal"><span class="pre">report_skip</span></code></a></li>
<li>testcase <a class="reference internal" href="09-api.html#tcfl.tc.tc_c" title="tcfl.tc.tc_c"><code class="xref py py-class docutils literal"><span class="pre">object</span></code></a>:
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.report_info" title="tcfl.tc.tc_c.report_info"><code class="xref py py-meth docutils literal"><span class="pre">report_info</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.report_pass" title="tcfl.tc.tc_c.report_pass"><code class="xref py py-meth docutils literal"><span class="pre">report_pass</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.report_fail" title="tcfl.tc.tc_c.report_fail"><code class="xref py py-meth docutils literal"><span class="pre">report_fail</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.report_blck" title="tcfl.tc.tc_c.report_blck"><code class="xref py py-meth docutils literal"><span class="pre">report_blck</span></code></a>,
<a class="reference internal" href="09-api.html#tcfl.tc.tc_c.report_skip" title="tcfl.tc.tc_c.report_skip"><code class="xref py py-meth docutils literal"><span class="pre">report_skip</span></code></a></li>
</ul>
<p>The system provides default drivers that report to the console and a
log file, as well as create report files with results of failures.</p>
<p>To create a new driver, one can override
<a class="reference internal" href="09-api.html#tcfl.report.report_c" title="tcfl.report.report_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.report.report_c</span></code></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">tcfl.report</span>

<span class="k">class</span> <span class="nc">report_ex_c</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_c</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">alevel</span><span class="p">,</span> <span class="n">ulevel</span><span class="p">,</span> <span class="n">_tc</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;REPORTING &quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">alevel</span><span class="p">,</span> <span class="n">_tc</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span>

<span class="n">tcfl</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_c</span><span class="o">.</span><span class="n">driver_add</span><span class="p">(</span><span class="n">report_ex_c</span><span class="p">(</span><span class="s2">&quot;results.log&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>with the following being:</p>
<blockquote>
<div><ul class="simple">
<li><em>level</em> is the verbosity level of the message; note report levels
greater or equal to 1000 are using to pass control messages, so
they shall not be subject to normal verbosity control.</li>
<li><em>alevel</em> is the verbosity level at which the attachments are
reported</li>
<li><em>ulevel</em> is deprecated</li>
<li><em>_tc</em> is the <a class="reference internal" href="09-api.html#tcfl.tc.tc_c" title="tcfl.tc.tc_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.tc.tc_c</span></code></a> or <a class="reference internal" href="09-api.html#tcfl.tc.target_c" title="tcfl.tc.target_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.tc.target_c</span></code></a>
object that is reporting</li>
<li><em>tag</em> is a string <em>PASS</em>, <em>FAIL</em>, <em>BLCK</em>, <em>SKIP</em> or <em>INFO</em>,
indicating what condition is being reported.</li>
<li><em>message</em> is the message the caller is reporting; if it starts with
<em>“COMPLETION “</em>, this is the final message issued to recap the
result of executing a single testcase.</li>
<li><em>attachments</em> a dictionary keyed by strings of objects that the
reporter decided to pass as extra information</li>
</ul>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This function will be called for <em>every</em> single report
the internals of the test runner and the testcases do from multiple
threads at the same time, so it makes sense to protect for
concurrency if accessing shared resources or to ignore high log
levels.</p>
</div>
<p>From these functions basically anything can be done–but they being
called frequently, it has to be efficient or will slow testcase
execution considerably. Actions done in this function can be:</p>
<ul class="simple">
<li>filtering (to only run for certain testcases, log levels, tags or
messages)</li>
<li>dump data to a database</li>
<li>record to separate files based on whichever logistics</li>
<li>etc</li>
</ul>
<div class="section" id="example-1-reporting-completion-of-testcase-execution">
<h3>2.5.1. Example 1: reporting completion of testcase execution<a class="headerlink" href="#example-1-reporting-completion-of-testcase-execution" title="Permalink to this headline">¶</a></h3>
<p>For example, to report all the testcases that finalize to a file
called <em>results.log</em>, consider <a class="reference download internal" href="../_downloads/conf_report_ex.py" download=""><code class="xref download docutils literal"><span class="pre">this</span> <span class="pre">example</span></code></a>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example report driver</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tcfl.report</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>

<span class="k">class</span> <span class="nc">report_ex_c</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example report driver</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file_name</span><span class="p">):</span>
        <span class="n">tcfl</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_c</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span> <span class="o">=</span> <span class="n">log_file_name</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> started&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">alevel</span><span class="p">,</span> <span class="n">ulevel</span><span class="p">,</span> <span class="n">_tc</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report data</span>

<span class="sd">        Note this can be called concurrently, so the file could be</span>
<span class="sd">        overriden; measures to avoid that involve a lock, like what is</span>
<span class="sd">        used here.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t operate on the global reporter</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_tc</span><span class="p">,</span> <span class="s2">&quot;skip_reports&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># The top level completion message starts with COMPLETION</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;COMPLETION&quot;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># _tc can be a target_c, but not for COMPLETION</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_tc</span><span class="p">,</span> <span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">)</span>

        <span class="c1"># Write it down!</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file_name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> DEBUG HASHID </span><span class="si">%s</span><span class="s2"> TC </span><span class="si">%s</span><span class="s2"> RESULT </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">_tc</span><span class="o">.</span><span class="n">ticket</span><span class="p">,</span> <span class="n">_tc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">twn</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">_tc</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DEBUG    TARGET </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">twn</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">fullid</span><span class="p">,</span>
                                                          <span class="n">target</span><span class="o">.</span><span class="n">bsp_model</span><span class="p">))</span>

<span class="n">tcfl</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_c</span><span class="o">.</span><span class="n">driver_add</span><span class="p">(</span><span class="n">report_ex_c</span><span class="p">(</span><span class="s2">&quot;results.log&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>note how this example:</p>
<ul class="simple">
<li>creates the file with a timestamp when the driver is initialized in
the <em>__init__</em> method</li>
<li>skips any reporter that has a <em>skip_reports</em> attribute</li>
<li>acts only on testcase completion by looking for the <em>COMPLETION</em>
string at the beginning of the message</li>
<li>correctly assumes the testcase might be assigned none, one or more
targets, depending on the testcase – it merely walks the list of
targets assigned to the testcase to print information about them as
needed.</li>
<li>accesses a shared resource (the file) by taking a lock, making sure
only one thread is accessing it at the same time, to avoid
corruption.</li>
<li>registers the driver instantiating the class</li>
</ul>
</div>
<div class="section" id="example-2-reporting-failures">
<h3>2.5.2. Example 2: reporting failures<a class="headerlink" href="#example-2-reporting-failures" title="Permalink to this headline">¶</a></h3>
<p>The builtin <a class="reference download internal" href="../_downloads/report.py" download=""><code class="xref download docutils literal"><span class="pre">report</span> <span class="pre">failure</span> <span class="pre">driver</span></code></a>
works similarly, but collecting information as we go to differerent
files for each testcase instantiation. When the testcase completes, it
writes a single report with all the information using the same method
as we described in the first example.</p>
<p>See <a class="reference internal" href="09-api.html#tcfl.report.file_c" title="tcfl.report.file_c"><code class="xref py py-class docutils literal"><span class="pre">tcfl.report.file_c</span></code></a>.</p>
</div>
</div>
<div class="section" id="app-builders">
<span id="tcf-guide-app-builder"></span><h2>2.6. App Builders<a class="headerlink" href="#app-builders" title="Permalink to this headline">¶</a></h2>
<p>FIXME</p>
<div class="section" id="overriding-actions">
<span id="tcf-guide-app-builder-override"></span><h3>2.6.1. Overriding actions<a class="headerlink" href="#overriding-actions" title="Permalink to this headline">¶</a></h3>
<p>Any defined application builder will insert in the testcase, for each
named target (<em>targetX</em>) declared with <a class="reference internal" href="09-api.html#tcfl.tc.target" title="tcfl.tc.target"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.target()</span></code></a> (or
<a class="reference internal" href="09-api.html#tcfl.tc.interconnect" title="tcfl.tc.interconnect"><code class="xref py py-func docutils literal"><span class="pre">tcfl.tc.interconnect()</span></code></a>) the following methods:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">configure_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">build_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">deploy_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">setup_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">start_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">teardown_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
<li><code class="docutils literal"><span class="pre">clean_50_targetX(self,</span> <span class="pre">targetX)</span></code></li>
</ul>
<p>however, you can override any by defining it yourself in your test
class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_50_targetX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetX</span><span class="p">):</span>
    <span class="n">targetX</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Doing something else for building&quot;</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>while you can still call the overriden function by its new name,
<code class="docutils literal"><span class="pre">overriden_build_50_target()</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_50_targetX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetX</span><span class="p">):</span>
    <span class="n">targetX</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;Doing something else before building&quot;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overriden_build_50_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetX</span><span class="p">)</span>
</pre></div>
</div>
<p>so the functionality is quite quick to reuse.</p>
<p>See <code class="docutils literal"><span class="pre">test_zephyr_override.py</span></code>, where that is done to build Zephyr’s
<em>Hello World!</em>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/python2</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017 Intel Corporation</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tcfl.tc</span>
<span class="kn">import</span> <span class="nn">tcfl.tl</span>

<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="o">**</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">zephyr_tags</span><span class="p">())</span>
<span class="c1"># Ask for a target that defines an zephyr_board field, which indicates</span>
<span class="c1"># it can run the Zephyr OS</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s2">&quot;zephyr_board&quot;</span><span class="p">,</span>
                <span class="n">app_zephyr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">ZEPHYR_BASE</span><span class="p">,</span>
                                          <span class="s2">&quot;samples&quot;</span><span class="p">,</span> <span class="s2">&quot;hello_world&quot;</span><span class="p">))</span>
<span class="nd">@tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tags</span><span class="p">(</span><span class="n">ignore_example</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_test</span><span class="p">(</span><span class="n">tcfl</span><span class="o">.</span><span class="n">tc</span><span class="o">.</span><span class="n">tc_c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show an example on how to override pre-defined actions created by</span>
<span class="sd">    app_zephyr while running Hello World!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">build_50_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">report_info</span><span class="p">(</span><span class="s2">&quot;building our own way, we are &quot;</span>
                           <span class="s2">&quot;going to hack the source first&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overriden_build_50_target</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="n">target</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s2">&quot;Hello World! </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">kws</span><span class="p">[</span><span class="s1">&#39;zephyr_board&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="contributing">
<span id="tcf-contributing"></span><h2>2.7. Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h2>
<p>Checkout your code in (eg) <cite>~/tcf.git</cite></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git clone -b v0.11-branch https://FIXME/tcf.git tcf.git
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">we are on the v0.11 stabilization branch (otherwise, you’d
clone <em>master</em>).</p>
</div>
<div class="section" id="support-reporting-issues">
<span id="support-and-reporting-issues"></span><h3>2.7.1. Support &amp; reporting issues<a class="headerlink" href="#support-reporting-issues" title="Permalink to this headline">¶</a></h3>
<p>Please report any issues found into the Github project page</p>
<p><a class="reference external" href="https://github.com/otcshare/tcf/issues">https://github.com/otcshare/tcf/issues</a></p>
</div>
<div class="section" id="running-the-tcf-client-from-the-source-tree">
<span id="tcf-run-from-source-tree"></span><h3>2.7.2. Running the TCF client from the source tree<a class="headerlink" href="#running-the-tcf-client-from-the-source-tree" title="Permalink to this headline">¶</a></h3>
<p>If you are developing TCF client code, it is helpful to be able to run
the local, checked out copy of the code rather than having to install
system wide.</p>
<p>For that, you can set the configuration:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ mkdir ~/.tcf
$ cd ~/.tcf
$ ln -s ~/tcf.git/zephyr/conf_zephyr.py
</pre></div>
</div>
<p>If you have installed TCF systemwide, you might have to remove
<cite>/etc/tcf/conf_zephyr.py</cite> or alternatively, pass <code class="docutils literal"><span class="pre">--config-path</span>
<span class="pre">:~/tcf.git/zephyr</span></code>, but it can be repetitive (the initial <cite>:</cite> removes
the predefined path <cite>/etc/tcf</cite>).</p>
<p>And now you can run:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd anywhere
$ ~/tcf.git/tcf command...
</pre></div>
</div>
<p>Add servers as needed in your toplevel <cite>~/.tcf</cite> or <cite>/etc/tcf/</cite>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ echo &quot;tcfl.config.url_add(&#39;https://SERVER:5000&#39;, ssl_ignore = True)&quot; &gt;&gt; conf_servers.py
</pre></div>
</div>
<p>A useful trick to be able to quickly switch servers (when only
wanting to work on a set of servers S1 versus a set of servers
S2):</p>
<ul>
<li><p class="first">Create directory <cite>~/s/S1</cite>, add a conf_server.py there pointing to
the servers in said set; when running tcf, use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ~/tcf.git/tcf --config-path ~/s/S1 COMMAND
</pre></div>
</div>
</li>
<li><p class="first">Maybe easier, is to call the directory <cite>~/s/S1/.tcf</cite>, cd into
<cite>~/s/S1</cite> and run tcf from there:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd ~/s/S1
$ ~/tcf.git/tcf command...
</pre></div>
</div>
<p>I have different directories, one call <cite>production/.tcf</cite> with all the
production servers, another <cite>staging/.tcf</cite>, with all the test servers,
<cite>local/.tcf</cite>, for my local server, etc…</p>
</li>
</ul>
</div>
<div class="section" id="running-the-tcf-server-ttbd-from-the-source-tree">
<h3>2.7.3. Running the TCF server (ttbd) from the source tree<a class="headerlink" href="#running-the-tcf-server-ttbd-from-the-source-tree" title="Permalink to this headline">¶</a></h3>
<p>If you are developing TCF server code, running said code without
installing system wide (and potentially conflicting versions),
requires some setup. This is usually called the <em>staging</em> server,
running locally on your machine:</p>
<ol class="arabic">
<li><p class="first">Disable SELinux:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># setenforce 0</span>
</pre></div>
</div>
</li>
<li><p class="first">Build what’s needed (<em>ttblc.so</em>):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd ~/z/tcf.git/ttbd
$ python setup.py build
$ ln -s build/lib.linux-x86_64-2.7/ttblc.so
</pre></div>
</div>
</li>
<li><p class="first">Ensure your home directory and such are readable by users members
of your group:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ chmod g+rX ~
$ chmod -R g+rX ~/tcf.git
</pre></div>
</div>
</li>
<li><p class="first">Create a staging configuration directory <cite>/etc/ttbd-staging</cite>, make it
owned by your user, so you don’t have to work as root:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ sudo install -d -o $LOGNAME -g $LOGNAME /etc/ttbd-staging
</pre></div>
</div>
</li>
<li><p class="first">link the following config files from your source tree:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd /etc/ttbd-staging
$ ln -s ~/tcf.git/ttbd/conf_00_lib.py
$ ln -s ~/tcf.git/ttbd/conf_06_default.py
$ ln -s ~/tcf.git/ttbd/zephyr/conf_06_zephyr.py
</pre></div>
</div>
</li>
<li><p class="first">Create a local configuration, so you can login without a password
from the local machine to port 5001 (port 5000 we leave it for
production instances):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cat &gt; /etc/ttbd-staging/conf_local.py &lt;&lt;EOF
local_auth.append(“127.0.0.1”)
host = “0.0.0.0”
port = 5001
EOF
</pre></div>
</div>
<p>To have TCF use this daemon, add a configuration line:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">tcfl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">url_add</span><span class="p">(</span><span class="s1">&#39;https://SERVER:5001&#39;</span><span class="p">,</span> <span class="n">ssl_ignore</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>to any TCF config file which your client will read.</p>
</li>
<li><p class="first">Create a local configuration file <cite>conf_10_local.py</cite> with local
configuration statements to enable hardware as needed. The default
configuration has only virtual machines.</p>
</li>
<li><p class="first">If you will use local Linux VMs (qlf*), set up the images by
following this FIXME: procedure.</p>
</li>
<li><p class="first">Create a configuration for systemd to start the daemon:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># cp ~user/tcf.git/ttbd/ttbd@.service /etc/systemd/systemctl/ttbd@staging.service</span>
</pre></div>
</div>
<p>Edit said file and:</p>
<ul>
<li><p class="first">In <em>Supplementary groups</em>, append your login name, so the process
can access your home directory</p>
</li>
<li><p class="first">In <em>ExecStart</em>, replace <cite>/usr/bin/ttbd</cite> with
<cite>/home/USERNAME/tcf.git/ttbd/ttbd</cite> so it starts the copy of the
daemon you are working on</p>
<p>(note if you ever need to run <em>strace</em> on the daemon, you can
prefix <cite>/usr/bin/strace -f -o /tmp/ttbd.strace.log</cite> to record
every single system call…for those hard debug cases :)</p>
</li>
<li><dl class="first docutils">
<dt>Reload the systemd configuration::</dt>
<dd><p class="first last"># systemctl daemon-reload</p>
</dd>
</dl>
</li>
</ul>
</li>
</ol>
<p>Start the daemon with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart ttbd@staging</span>
</pre></div>
</div>
<p>Make it always start automatically with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># systemctl enable ttbd@staging</span>
</pre></div>
</div>
</div>
<div class="section" id="workflow-for-contributions">
<h3>2.7.4. Workflow for contributions<a class="headerlink" href="#workflow-for-contributions" title="Permalink to this headline">¶</a></h3>
<p>Adapted from <a class="reference external" href="http://docs.zephyrproject.org/contribute/contribute_guidelines.html#contribution-workflow">http://docs.zephyrproject.org/contribute/contribute_guidelines.html#contribution-workflow</a></p>
<p>Make small, logically self-contained, controlled changes to simplify
review.  Makes merging and rebasing easier, and keep the change
history clear and clean.</p>
<blockquote>
<div><div class="admonition-example admonition">
<p class="first admonition-title">example</p>
<p>cleaning up code would be a set of commits:</p>
<ul class="last simple">
<li>only whitespace changes to adapt to convention</li>
<li>fix one type of warnings</li>
<li>fix one type of errors</li>
<li>etc…</li>
</ul>
</div>
</div></blockquote>
<p>Provide as much information as you can about your change, update
appropriate documentation, and testing changes thoroughly before
submitting.</p>
<p>We accept contributions as GitHub pull requests, to save everyone’s
time and provide a consistent review platform for all.</p>
<p>A github-based workflow can be:</p>
<ol class="arabic">
<li><p class="first">Create a fork to your personal account on GitHub (click on the
<em>fork</em> button in the top right corner of the project repo page in
GitHub)</p>
</li>
<li><p class="first">On your development computer, clone the fork you just made:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git clone https://github.com/&lt;your github id&gt;/tcf.git
</pre></div>
</div>
<p>Configure <em>git</em> to know about the upstream repo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git remote add upstream https://github.com/FIXME/tcf.git
$ git remote -v
</pre></div>
</div>
</li>
<li><p class="first">Create a topic branch (off of master or anyother branch) for your
work (if you’re addressing an issue, we suggest including the issue
number in the branch name):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git checkout master
$ git checkout -b fix_comment_typo
</pre></div>
</div>
<p>Make changes, test locally, change, test, test again; some base
testcases we will run are at least:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ cd ~/tcf.git
$ ./lint-all.py
$ ./tcf run ~/tcf.git/tests
</pre></div>
</div>
</li>
<li><p class="first">Start the pull request process by adding your changed files:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git add [file(s) that changed, add -p if you want to be more specific]
</pre></div>
</div>
<p>You can see files that are not yet staged using:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git status
</pre></div>
</div>
<p>Verify changes to be committed look as you expected:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git diff --cached
</pre></div>
</div>
</li>
<li><p class="first">Commit your changes to your local repo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git commit -vs
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">-s</span></code> option automatically adds your <cite>Signed-off-by:</cite> to your
commit message. Your commit will be rejected without this line that
indicates your agreement with the DCO (Developer Certificate of
Origin).</p>
<p>Commits messages shall be explanatory and concise, properly spelled
and in the form:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">AREA</span><span class="p">:</span> <span class="n">SHORT</span> <span class="n">SUMMARY</span>

<span class="n">Longer</span> <span class="n">description</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">obviated</span> <span class="k">if</span> <span class="n">the</span> <span class="n">commit</span> <span class="ow">is</span> <span class="n">quite</span>
<span class="n">obvious</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">the</span> <span class="n">summary</span> <span class="n">already</span> <span class="n">says</span> <span class="n">it</span> <span class="nb">all</span><span class="o">.</span> <span class="n">Note</span>
<span class="n">implementation</span> <span class="n">details</span> <span class="n">shall</span> <span class="n">be</span> <span class="n">detailed</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">code</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">ok</span>
<span class="k">for</span> <span class="n">the</span> <span class="n">commit</span> <span class="n">message</span> <span class="n">to</span> <span class="n">point</span> <span class="n">to</span> <span class="n">those</span><span class="p">,</span> <span class="k">as</span> <span class="n">we</span> <span class="n">don</span><span class="s1">&#39;t want</span>
<span class="n">information</span> <span class="n">duplicated</span> <span class="n">innecesarily</span><span class="o">.</span>

<span class="n">Signed</span><span class="o">-</span><span class="n">off</span><span class="o">-</span><span class="n">by</span><span class="p">:</span> <span class="n">Random</span> <span class="n">Developer</span> <span class="o">&lt;</span><span class="n">random</span><span class="o">.</span><span class="n">developer</span><span class="nd">@somewhere</span><span class="o">.</span><span class="n">org</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Push your topic branch with your changes to your fork in your
personal GitHub account:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git push origin fix_comment_typo
</pre></div>
</div>
<ol class="loweralpha">
<li><p class="first">In your web browser, go to your forked repo and click on the
<em>Compare &amp; pull request</em> button for the branch you just worked on
and you want to open a pull request with.</p>
</li>
<li><p class="first">Review the pull request changes, and verify that you are opening a
pull request for the appropriate branch. The title and message from
your commit message should appear as well.</p>
<p>GitHub will assign one or more suggested reviewers (based on the
<cite>CODEOWNERS</cite> file in the repo). If you are a project member, you can
select additional reviewers now too.</p>
</li>
<li><p class="first">Click on the <em>submit</em> button and your pull request is sent and
awaits review. Email will be sent as review comments are made, or
you can check on your pull request at
<a class="reference external" href="https://github.com/FIXME/pulls">https://github.com/FIXME/pulls</a>.</p>
</li>
</ol>
<p>While you’re waiting for your pull request to be accepted and
merged, you can create another branch to work on another issue (be
sure to make your new branch off of master and not the previous
branch):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git checkout master
$ git checkout -b fix_another_issue
</pre></div>
</div>
<p>and use the same process described above to work on this new topic
branch.</p>
</li>
</ol>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="03-server-setup.html" class="btn btn-neutral float-right" title="3. Server deployment guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../02-QUICKSTART.html" class="btn btn-neutral" title="1. Quickstart" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Author.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.11',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>